[{"content":"","date":"18 Janvier 2024","permalink":"/fr/authors/","section":"Authors","summary":"","title":"Authors"},{"content":" TL;DR: Epic fail. Pfiou\u0026hellip;. # J\u0026rsquo;ai fini de construire ma guitare.\nEt quand je dis \u0026ldquo;j\u0026rsquo;ai fini de construire ma guitare\u0026rdquo;, ce que je veux vraiment dire c\u0026rsquo;est que le projet est un échec, que je n\u0026rsquo;ai pas pu jouer avec et qu\u0026rsquo;elle a fini sa vie à la recyclerie. C\u0026rsquo;est un peu triste, mais je ne regrette pas d\u0026rsquo;avoir essayé, j\u0026rsquo;ai appris beaucoup de choses, et je me suis bien amusé malgré tout.\nSi j\u0026rsquo;ai mis autant de temps à écrire cette suite, c\u0026rsquo;est que j\u0026rsquo;ai eu du mal à accepter l\u0026rsquo;échec. J\u0026rsquo;ai eu besoin de prendre du recul, de digérer, et de me dire que ce n\u0026rsquo;était pas grave\u0026hellip;\nNon, plus sérieusement, un peu de flemme et de procrastination, parsemé de quelques évènements personnels qui ont pris le dessus sur mes loisirs.\nJe me motive aujourd\u0026rsquo;hui pour terminer cette série et apporter un peu de finalité à ce projet, en espérant qu\u0026rsquo;elle motivera des gens à tester par eux-mêmes avec un peu plus de succès que moi je l\u0026rsquo;espère.\nDonc voici ce qui s\u0026rsquo;est passé depuis le dernier épisode.\nTeinture du corps # J\u0026rsquo;ai d\u0026rsquo;abord passé une première couche de base mate, en prévision de la teinture et de la peinture.\nJ\u0026rsquo;ai passé une première couche de teinture bleue sur le corps\u0026hellip;\n\u0026hellip; puis une seconde quelques heures après lorsque la première était sèche.\nJ\u0026rsquo;avais envie d\u0026rsquo;un mélange de bleu \u0026ldquo;police\u0026rdquo;, de bleu de Klein et de noir \u0026ldquo;trou noir\u0026rdquo;, donc j\u0026rsquo;ai commencé par masquer ce qui ne serait pas teint en noir avec du scotch de peinture, et j\u0026rsquo;ai passé une première couche de noir\u0026hellip;\nsuivi d\u0026rsquo;une seconde le lendemain.\nLe résultat était très sympa, avec un noir très intense, et un bleu qui laissait apparaître les veines du bois:\nJ\u0026rsquo;ai ensuite ajouté deux bandes de bleu de Klein entre la bande noire et le bleu police, en délimitant par des petites bandes noires, puis j\u0026rsquo;ai finalisé avec une couche de vernis mate.\nMécaniques # J\u0026rsquo;ai ensuite installé les mécaniques, rien de bien compliqué, j\u0026rsquo;ai simplement placé les mécaniques dans les trous et utilisé une règle pour contrôler l\u0026rsquo;alignement et marquer les points de perçage.\nCollage du manche au corps # J\u0026rsquo;ai ensuite collé le manche au corps avec de la colle à bois, et c\u0026rsquo;est la première grosse erreur que j\u0026rsquo;ai commise: il ne faut pas teindre ou peindre le manche avant de le coller au corps.\nÀ ce stade, naïvement je pense avoir réussi l\u0026rsquo;opération, le manche semble bien collé au corps.\nInstallation du chevalet # Le moment qui me stressait le plus, l\u0026rsquo;installation du chevalet.\nÀ ce stade, je réalise que le manche n\u0026rsquo;est pas complètement aligné avec le chevalet\u0026hellip; alors que le manche était bien en butée dans la découpe du corps sans aucun jeu, et que le chevalet était bien placé dans la découpe.\nJ\u0026rsquo;avais un peu d\u0026rsquo;espoir de pouvoir corriger ça en jouant un peu sur le réglage du chevalet, mais j\u0026rsquo;ai vite réalisé que c\u0026rsquo;était impossible.\nDans tous les cas, le corps ayant été collé et teint, plus moyen de demander un échange donc je me suis dit que je ne risquais rien à continuer.\nJ\u0026rsquo;ai fini d\u0026rsquo;installé le chevalet \u0026hellip;\n\u0026hellip; puis installé les cordes pour voir l\u0026rsquo;étendue des dégats.\nLe projet fini # Une petite vue de l\u0026rsquo;ensemble ?\nLe résultat est esthétiquement sympa, je me voyais déjà jouer avec, mais j\u0026rsquo;ai vité réalisé que c\u0026rsquo;était impossible: le cordes n\u0026rsquo;étaient pas parallèles au manche.\nVisuellement, ça ne choque pas, mais le décalage est tel que les cordes ne sont pas jouables, et selon la position certaines techniques ne sont juste pas réalisables: un simple bend peut faire glisser la corde sur la frette hors du manche passé la 17ème frette.\nMême en étant très optimiste\u0026hellip; je ne pouvais pas jouer avec cette guitare.\nUn autre problème est survenu deux jours plus tard: je me rends compte que le manche est complètement décollé du corps.\nAprès avoir retiré les cordes, je retente de coller le manche au corps et laisser plus de temps, mais j\u0026rsquo;apprends par la suite que la colle à bois ne colle pas sur de la teinture ou de la peinture. La sanction ne tarde pas, le manche se décolle à nouveau.\nJe fini donc par visser le manche au corps\u0026hellip; c\u0026rsquo;est bien il tient\u0026hellip; mais la guitare reste injouable à cause du décalage entre le manche et le chevalet.\nConclusion # Évidemment une déception puisque je ne peux pas jouer avec, et que j\u0026rsquo;ai investi quelques centaines d\u0026rsquo;euros dans le projet, mais je ne regrette pas d\u0026rsquo;avoir essayé, j\u0026rsquo;ai beaucoup appris et je me suis bien amusé malgré tout.\nJ\u0026rsquo;ai découvert que la construction d\u0026rsquo;une guitare n\u0026rsquo;est pas un projet trivial, qu\u0026rsquo;il faut être très précis, que la moindre erreur peut être fatale, et que la patience est une qualité indispensable.\nJ\u0026rsquo;ai appris que j\u0026rsquo;aimais bien la peinture, que j\u0026rsquo;aime bien l\u0026rsquo;odeur du bois, mais que je n\u0026rsquo;aime pas le travail de précision et donc que je ne me vois pas en faire une seconde.\nSachant que j\u0026rsquo;envisageais un stage de lutherie pour fabriquer ma guitare en 2024, cette leçon a quelques centaines d\u0026rsquo;euros m\u0026rsquo;a évité de perdre plusieurs milliers d\u0026rsquo;euros dans un stage qui ne m\u0026rsquo;aurait pas plu.\nJe vais donc me contenter de jouer avec mes guitares achetées dans le commerce :-)\n","date":"18 Janvier 2024","permalink":"/fr/posts/2024-02-18/bilan-final/","section":"Posts","summary":"TL;DR: Epic fail. Pfiou\u0026hellip;. # J\u0026rsquo;ai fini de construire ma guitare.\nEt quand je dis \u0026ldquo;j\u0026rsquo;ai fini de construire ma guitare\u0026rdquo;, ce que je veux vraiment dire c\u0026rsquo;est que le projet est un échec, que je n\u0026rsquo;ai pas pu jouer avec et qu\u0026rsquo;elle a fini sa vie à la recyclerie.","title":"Bilan final"},{"content":"","date":"18 Janvier 2024","permalink":"/fr/categories/","section":"Categories","summary":"","title":"Categories"},{"content":"","date":"18 Janvier 2024","permalink":"/fr/series/construire-ma-propre-guitare/","section":"Series","summary":"","title":"Construire ma propre guitare"},{"content":"","date":"18 Janvier 2024","permalink":"/fr/categories/diy/","section":"Categories","summary":"","title":"diy"},{"content":" Architecte IT, développeur senior, consultant \u0026amp; formateur Je suis un architecte IT, un développeur passionné, un consultant pragmatique et un formateur enthousiaste. Que vous ayez besoin de produire quelque chose de neuf, d\u0026rsquo;examiner votre architecture logicielle, ou de former votre équipe sur les dernières technologies, je suis là pour vous aider.\nJ\u0026rsquo;aime résoudre des problèmes. J\u0026rsquo;apporte une approche honnête et réaliste à mon travail, en m\u0026rsquo;assurant toujours que je fournis des solutions qui répondent à vos besoins spécifiques en tenant compte de vos contraintes. Je suis transparent sur ce qu\u0026rsquo;il est possible ou non de faire et sous quelles conditions, mon but n\u0026rsquo;est pas de vendre du rêve mais de tenir des promesses: la plupart de mes livraisons sont faites sans surprises et dans les délais.\nMon taux journalier moyen varie en fonction du projet et du niveau d\u0026rsquo;expertise attendu, se situant entre 750 et 1250 euros, selon les compétences auxquelles il fait appel.\nN\u0026rsquo;hésitez pas à analyser mon travail sur Github ou à regarder mon profil LinkedIn, les recommandations qui m\u0026rsquo;ont été laissées, mais aussi à contacter des personnes ayant travaillées avec moi pour leur demander leur avis.\nSi vous pensez que nous pourrions faire une bonne équipe, n\u0026rsquo;hésitez pas à me contacter !\nAu plaisir de collaborer avec vous bientôt.\n","date":"18 Janvier 2024","permalink":"/fr/authors/gilles/","section":"Authors","summary":"Architecte IT, développeur senior, consultant \u0026amp; formateur Je suis un architecte IT, un développeur passionné, un consultant pragmatique et un formateur enthousiaste. Que vous ayez besoin de produire quelque chose de neuf, d\u0026rsquo;examiner votre architecture logicielle, ou de former votre équipe sur les dernières technologies, je suis là pour vous aider.","title":"Gilles Chehade"},{"content":"","date":"18 Janvier 2024","permalink":"/fr/categories/guitare/","section":"Categories","summary":"","title":"guitare"},{"content":"","date":"18 Janvier 2024","permalink":"/fr/categories/musique/","section":"Categories","summary":"","title":"musique"},{"content":"","date":"18 Janvier 2024","permalink":"/fr/","section":"poolp.org","summary":"","title":"poolp.org"},{"content":"","date":"18 Janvier 2024","permalink":"/fr/posts/","section":"Posts","summary":"","title":"Posts"},{"content":"","date":"18 Janvier 2024","permalink":"/fr/series/","section":"Series","summary":"","title":"Series"},{"content":" TL;DR: Donner une forme à la tête # Pour commencer, j\u0026rsquo;ai voulu donner une esthétique différente à la tête.\nLe manche que j\u0026rsquo;ai acheté est un manche PRS, j\u0026rsquo;aime beaucoup et ma guitare du moment est une PRS:\n\u0026hellip; mais elle est trop caractéristique et un peu trop pointue à mon goût pour ce projet:\nJe me suis dit que j\u0026rsquo;allais faire une petite découpe pour arrondir un peu tout ça, et donc j\u0026rsquo;ai obtenu le résultat suivant:\nJe suis assez content du résultat, elle fait plus \u0026ldquo;douce\u0026rdquo;, j\u0026rsquo;aime beaucoup.\nTeinture du manche # Comme je l\u0026rsquo;ai dit dans mon précédent article de la série, je compte peindre la guitare en bleu Klein et en noir \u0026ldquo;trou noir\u0026rdquo;\u0026hellip; mais après un peu de recherche, je me suis rendu compte que ce n\u0026rsquo;était pas forcément une très bonne idée pour le manche.\nContrairement au corps, le manche va être soumis a pas mal de friction entre le pouces et les cordes, et il est recommandé de plutôt prendre une teinture qui va pénétrer le bois.\nJ\u0026rsquo;ai donc cherché un très joli bleu, pour le dos et la tête, et un noir très intense, pour les frettes, histoire de bien aller avec ce que j\u0026rsquo;ai choisi pour le corps.\nLe noir est encore en attente de livraison, mais le bleu est arrivé et j\u0026rsquo;ai donc pu commencer à teindre.\nAprès trois tours de ponçage et teinture, j\u0026rsquo;ai le résultat suivant que je trouve magnifique:\nIl me reste plus qu\u0026rsquo;à attendre que le reste arrive !\n","date":"5 Janvier 2023","permalink":"/fr/posts/2023-08-05/d%C3%A9coupe-de-la-t%C3%AAte-et-teinture-du-manche/","section":"Posts","summary":"TL;DR: Donner une forme à la tête # Pour commencer, j\u0026rsquo;ai voulu donner une esthétique différente à la tête.\nLe manche que j\u0026rsquo;ai acheté est un manche PRS, j\u0026rsquo;aime beaucoup et ma guitare du moment est une PRS:","title":"Découpe de la tête et teinture du manche"},{"content":" TL;DR: De retour des vacances, j\u0026rsquo;ai commencé à travailler sur le manche mais réalisé que j\u0026rsquo;avais besoin de plus d\u0026rsquo;outils. Heureusement, j\u0026rsquo;en ai trouvé des pas trop chers. Travail sur la tête # J\u0026rsquo;ai commandé et reçu le manche, il s\u0026rsquo;adapte bien, mais je voulais retravailler la tête un peu pour qu\u0026rsquo;elle soit un peu moins PRS. Malheureusement, après avoir passé une heure à limer et poncer, je me suis rendu compte que je m\u0026rsquo;y prenais mal et que j\u0026rsquo;avais besoin d\u0026rsquo;outils automatiques\u0026hellip; sinon je serais encore dessus en Décembre.\nJ\u0026rsquo;ai cherché des outils pas trop chers et j\u0026rsquo;en ai trouvé un, le Dremel 8220, qui pourrait être utilisé pour couper, limer, poncer, percer et faire tout un tas de tâches répétitives. Il m\u0026rsquo;a coûté 145 EUR, ce qui n\u0026rsquo;est pas énorme étant donné que j\u0026rsquo;en ai besoin pour d\u0026rsquo;autres tâches à la maison.\nPour 35 EUR de plus, il y a un pack qui inclus aussi un étau ce qui me semblait une plutôt bonne idée: maintenir le manche en place pendant le limage a été une épreuve de patience et de souffrance dans laquelle j\u0026rsquo;ai réussi à me mettre une grosse écharde.\nVu que j\u0026rsquo;étais déjà dan sujne frénésie de shopping, j\u0026rsquo;ai aussi acheté un stylo graveur, qui me semblait là aussi une bonne idée vu que j\u0026rsquo;ai des projets pour lui. J\u0026rsquo;ai acheté le mien chez Nature et Découverte, mais il y en a une tonne de différents sur Amazon.\nLa peinture est en retard, ce n\u0026rsquo;est pas un problème\u0026hellip; # Ma commande pour la peinture n\u0026rsquo;est pas encore expédiée à cause d\u0026rsquo;une rupture sur l\u0026rsquo;un des articles, et ils n\u0026rsquo;expédient que les commandes complètes donc\u0026hellip; pas trop grave vu que je dois d\u0026rsquo;abord retravailler la tête de toutes façons.\nLa suite ? # Je commencerai la semaine prochaine, comme je viens de revenir de vacances, et que mon fils est à la maison ce qui rends difficile toute activité bruyante. Je posterai des photos de la tête dès qu\u0026rsquo;elle sera comme je le veux !\n","date":"26 Janvier 2023","permalink":"/fr/posts/2023-07-26/construire-ma-propre-guitare-partie-4/","section":"Posts","summary":"TL;DR: De retour des vacances, j\u0026rsquo;ai commencé à travailler sur le manche mais réalisé que j\u0026rsquo;avais besoin de plus d\u0026rsquo;outils. Heureusement, j\u0026rsquo;en ai trouvé des pas trop chers.","title":"Construire ma propre guitare, partie 4"},{"content":"","date":"26 Janvier 2023","permalink":"/fr/tags/diy/","section":"Tags","summary":"","title":"diy"},{"content":"","date":"26 Janvier 2023","permalink":"/fr/tags/guitare/","section":"Tags","summary":"","title":"guitare"},{"content":"","date":"26 Janvier 2023","permalink":"/fr/tags/","section":"Tags","summary":"","title":"Tags"},{"content":"","date":"25 Janvier 2023","permalink":"/fr/tags/c/","section":"Tags","summary":"","title":"C"},{"content":" TL;DR: J\u0026rsquo;ai retrouvé une copie imprimée d\u0026rsquo;un devoir que j\u0026rsquo;ai eu à faire en 2005, quand j\u0026rsquo;étais encore étudiant, pour implémenter un appel système sous OpenBSD et Linux. J\u0026rsquo;ai perdu le fichier source LaTeX alors j\u0026rsquo;ai décidé de le retaper pour en avoir une copie numérique. À l\u0026rsquo;origine, l\u0026rsquo;article couvrait les \u0026ldquo;loadable kernel modules\u0026rdquo; (LKM) qui ne font plus partie d\u0026rsquo;OpenBSD, j\u0026rsquo;ai donc supprimé cette partie. J\u0026rsquo;ai aussi supprimé la partie Linux parce qu\u0026rsquo;elle ne m\u0026rsquo;intéressait pas à l\u0026rsquo;époque, que j\u0026rsquo;ai écrit le minimum vital pour mon devoir et que ce n\u0026rsquo;est donc pas très intéressant à lire ;-) Avertissement # Le contenu de cet article est basé sur un devoir que j\u0026rsquo;ai rédigé en 2005, lorsque j\u0026rsquo;étais encore étudiant à Epitech, donc les choses ont probablement changé et ce n\u0026rsquo;est pas un tutoriel: s\u0026rsquo;il vous plait, n\u0026rsquo;écrivez pas d\u0026rsquo;appels systèmes et ne les soumettez pas à OpenBSD\u0026hellip; sauf si les développeurs d\u0026rsquo;OpenBSD vous ont demandé de le faire et vous ont dit que c\u0026rsquo;était une bonne idée.\nJE LE RÉPÈTE: N\u0026rsquo;\u0026hellip; IMPLÉMENTEZ\u0026hellip; PAS\u0026hellip; D\u0026rsquo;\u0026hellip; APPELS\u0026hellip; SYSTÈMES\u0026hellip; À\u0026hellip; PARTIR\u0026hellip; DE\u0026hellip; CET\u0026hellip; ARTICLE !\nL\u0026rsquo;article a pour objectif de partager de la connaissance, et d\u0026rsquo;éviter de perdre quelque chose que j\u0026rsquo;ai écrit et qui n\u0026rsquo;existe plus qu\u0026rsquo;en version papier. Voyez le comme un vestige archéologique.\nJ\u0026rsquo;ai accidentellement leaké une version brouillon de cet article il y a trois ans, devenue très rapidement populaire suite à un partage sur un site connu\u0026hellip; avant que je ne la supprime parce que je n\u0026rsquo;avais pas fini de le nettoyer et de mettre cet avertissement. Cette fois ci, j\u0026rsquo;ai été plus malin, j\u0026rsquo;ai tout rédigé avant de faire mon commit.\nJ\u0026rsquo;ai fait quelques changements mineurs pour aider à la compréhension, mais je n\u0026rsquo;ai pas modifié le style d\u0026rsquo;écriture, vous lisez le moi d\u0026rsquo;il y a 18 ans qui faisait un devoir scolaire.\nLes exemples sont très simples, ils ne sont pas là pour servir de fondation à vos projets, mais juste pour aider certains à faire leurs premiers pas sur les marches de la compréhension. Trouvez les erreurs est un petit cadeau que je vous laisse: je vous encourage à commenter ou soumettre des pull requests pour améliorer cet article.\nQuelques rappels nécessaires # Programme et Processus # Les gens utilisent souvent les deux mots de manière interchangeable mais il est important de comprendre la différence entre un programme et un processus, particulièrement parce que le même programme peut être autorisé à utiliser un appel système dans un processus mais pas dans un autre (utilisateur privilégié ou non), mais aussi parce que la notion de processus fait partie de l\u0026rsquo;API des appels sytème (l\u0026rsquo;interface des appels système prends un pointeur sur une struct proc qui représente un processus).\nUn programme est un exécutable qui contient un jeu d\u0026rsquo;instructions qui sont supposées être exécutées et faire quelque chose. Il réside dans un fichier structuré (a.out, elf, \u0026hellip;) dans le système de fichier qui impose des restrictions sur qui peut ou non l\u0026rsquo;exécuter (permissions et ownership dans un système de fichiers). Un processus est une instance de ce programme, qui tourne dans un espace mémoire qui lui est propre, avec ses propres privilèges.\nSi l\u0026rsquo;on prends /bin/ls, c\u0026rsquo;est un programme qui liste les répertoires et fichiers. Lorsqu\u0026rsquo;un utilisateur l\u0026rsquo;exécute, un processus est créé qui va effectivement exécuter ce programme avec les privilèges de l\u0026rsquo;utilisateur, dans un espace mémoire qui n\u0026rsquo;est pas partagé avec les autres processus.\nKernel et userland # Les systèmes Unix-like ont une architecture où le code est exécuté dans deux zones principales: le kernel (noyau) et le userland (espace utilisateur).\nLe kernel est en charge de fournir et limiter l\u0026rsquo;accès aux matériels, imposer des restrictions sur ce qu\u0026rsquo;un programme peut faire, et fournir un espace mémoire virtuel aux programmes dans lesquels ils peuvent s\u0026rsquo;exécutér.\nUn programme s\u0026rsquo;exécute en userland et effectue des opérations sur une mémoire qui lui est allouée par le kernel durant l\u0026rsquo;initialisation du processus. Lorsque le programme doit accéder à un matériel ou a besoin que le kernel fasse une opération qu\u0026rsquo;il n\u0026rsquo;est pas autorisé à faire lui même, il demande au kernel de déclencher un appel système. L\u0026rsquo;appel système est une fonction qui fait partie du kernel et qui s\u0026rsquo;exécute en lui de la part du processus.\nAppel système # Un appel système est un service fourni par le kernel pour qu\u0026rsquo;un processus userland puisse demander au kernel de faire quelque chose à sa place, généralement quelque chose que le programme useland n\u0026rsquo;est pas capable ou pas autorisé à faire lui même.\nDu point de vue d\u0026rsquo;un programme, c\u0026rsquo;est une fonction un peu particulière qu\u0026rsquo;il peut appeler comme n\u0026rsquo;importe quelle autre fonction, mais qui ne s\u0026rsquo;exécute pas dans l\u0026rsquo;espace mémoire du processus. Un programme connait seulement l\u0026rsquo;interface des appels systèmes mais n\u0026rsquo;a pas accès à leur implémentation, il peut donc les appeler, leur passer des paramètres, obtenir un résultat, mais ne peut pas inspecter ce qu\u0026rsquo;il se passe à l\u0026rsquo;intérieur de l\u0026rsquo;appel système pendant qu\u0026rsquo;il s\u0026rsquo;exécute. Il ne peut pas le debugger.\nÇa vient avec des effets de bord. Côté performances, un appel système bascule de l\u0026rsquo;exécution en userland à une exécution en kernel qui est plus coûteuse. Ensuite, des bugs dans un appel système ont un impact bien différents des bugs dans une fonction: une corruption mémoire peut provoquer le crash d\u0026rsquo;un processus, la même corruption mémoire dans un appel système peut provoquer le crash du système.\nIl y a deux aspects aux appels systèmes:\nL\u0026rsquo;implémentation de l\u0026rsquo;appel systène, le code effectif de l\u0026rsquo;appel système qui sera exécuté dans le kernel lorsqu\u0026rsquo;il sera appellé, et l\u0026rsquo;interface de l\u0026rsquo;appel système, la manière dont l\u0026rsquo;appel système est supposé être appelé depuis une application en userland.\nC\u0026rsquo;est important de différencier les deux comme, dans OpenBSD, le prototype pour l\u0026rsquo;implémentation d\u0026rsquo;un appel système ne corresponds pas au prototype de l\u0026rsquo;interface pour le même appel système comme nous allons voir.\n@gpt-4: Les appels système servent de passerelle entre les applications utilisateur et le noyau du système d\u0026rsquo;exploitation de bas niveau. Ils sont une partie intégrale de l\u0026rsquo;infrastructure d\u0026rsquo;un système d\u0026rsquo;exploitation qui fournit un accès contrôlé aux ressources matérielles, gère les processus et gère les interactions avec le système de fichiers, parmi de nombreuses autres tâches.\nAlors que les systèmes d\u0026rsquo;exploitation sont livrés avec un ensemble standard d\u0026rsquo;appels système, il peut y avoir des cas où vous souhaitez introduire des appels système personnalisés. Ceux-ci pourraient être destinés à du matériel spécialisé, à des exigences de gestion de processus uniques, ou à d\u0026rsquo;autres personnalisations au niveau de l\u0026rsquo;OS qui ne sont pas fournies par les appels système intégrés.\nComprendre comment ajouter de nouveaux appels système dans un système comme OpenBSD, ouvre donc une porte vers des innovations et des personnalisations au niveau du système.\nImplémenter des appels système pour OpenBSD # Pré-requis # Utiliser un compte privilégié # Il est évident qu\u0026rsquo;un compte non privilégié n\u0026rsquo;est pas autorisé à modifier le kernel comme il vérifie les permissions sur le système. Pour cette raison, il faut nécessairement avoir un compte privilégié au moins pour installer le kernel modifié.\nAvoir les sources du système # Les sources du système sont disponibles directemnet depuis le projet OpenBSD. Pour ce devoir, nous aurons besoin des archives suivantes:\nsrc.tar.gz srcsys.tar.gz Il faudra les extraire à la racine du système:\n% doas tar -C / -zxf src.tar.gz % doas tar -C / -zxf srcsys.tar.gz (edit: doas remplace maintenant sudo)\nSavoir comment rebuilder un kernel # Une fois que vous avez accès aux sources du système, vous pouvez rebuilder un kernel en utilisant les commandes suivantes:\n# cd /usr/src/sys/arch/amd64/config # config GENERIC # cd ../compile/GENERIC # make clean depend install Le rebuild ne prends que quelques minutes et une copie de sauvegarde du précedent kernel est faite automatiquement au cas où le nouveau kernel serait instable.\nRebuilder le système # Rebuilder le système peut être nécessaire si les changements du kernel affectent des outils userland.. Ce peut être le cas par exemple si vous modifiez la struct proc qui est utilisée par des outils comme ps, top ou uname. Rebuilder est aussi simple que de taper:\n# cd /usr/src # make build Rebuilder le système est considérablement plus long que pour le kernel et peut prendre de quelques minutes à plusieurs heures selon l\u0026rsquo;architecture.\nAppel système sans paramètres: sys_goodbye() # Pour débuter, nous allons implémenter l\u0026rsquo;appel système sys_goodbye() qui ne prends aucun paramètre. Son prototype est:\nint goodbye(void); Implémentation # #include \u0026lt;sys/types.h\u0026gt; #include \u0026lt;sys/param.h\u0026gt; #include \u0026lt;sys/systm.h\u0026gt; #include \u0026lt;sys/kernel.h\u0026gt; #include \u0026lt;sys/proc.h\u0026gt; #include \u0026lt;sys/mount.h\u0026gt; #include \u0026lt;sys/syscallargs.h\u0026gt; /* displays \u0026#34;Goodbye, cruel world !\u0026#34; on the console */ sys_goodbye(struct proc *p, void *v, register_t *retval) { printf(\u0026#34;Goodbye, cruel world !\\n\u0026#34;); return (0); } Description # Notre premier appel système affiche la phrase \u0026ldquo;Goodbye, cruel world !\u0026rdquo; sur la console.\nIl nous permet de voir que le prototype de l\u0026rsquo;appel système diffère entre le userland et le kernel. OpenBSD fournit une API unique pour tous les appels systèmes, peu importe le prototype qu\u0026rsquo;ils exposent au userland.\nLes headers inclus ici sont le set minimal requis pour que l\u0026rsquo;API des appels système fonctionne normalement. Certains peuvent paraitre inutilisés par notre fonction mais seront utilisé lors du build pour la plomberie interne du kernel. L\u0026rsquo;appel système ne se limite pas seulement à son implémentation, certains éléments seront ajoutés par la suite indirectement et automatiquement comme on le verra.\nNe premier appel système va ignorer ses paramètres (struct proc *, void *v et register_t *retval), utiliser printf() et retourner 0 pour indiquer à l\u0026rsquo;appelant que l\u0026rsquo;exécution s\u0026rsquo;est bien déroulée.\nIci, printf() ne doit pas être confondu avec le printf() userland, le premier est utilisé pour écrire sur la console et non pas sur la sortie standard.\nAppel système avec paramètres: sys_showparams() # Notre second appel système, sys_showparams(), prends un int en paramètre et affiche sa valeur sur la console. Son prototype est le suivant:\nint showparams(int val); Implementation # #include \u0026lt;sys/types.h\u0026gt; #include \u0026lt;sys/param.h\u0026gt; #include \u0026lt;sys/systm.h\u0026gt; #include \u0026lt;sys/kernel.h\u0026gt; #include \u0026lt;sys/proc.h\u0026gt; #include \u0026lt;sys/mount.h\u0026gt; #include \u0026lt;sys/syscallargs.h\u0026gt; /* displays value of integer parameter to console */ sys_showparams(struct proc *p, void *v, register_t *retval) { struct sys_showparams_args /* { syscallarg(int)\tval; } */ *uap = v; printf(\u0026#34;showparams(%d)\\n\u0026#34;, SCARG(uap, val)); return (0); } Description # Contrairement à la précédente, cette fonction n\u0026rsquo;ignore pas ses paramètres mais en extraie un paramètre entier passé dans l\u0026rsquo;interface userland.\nPour le faire, l\u0026rsquo;appel système déclare un pointeur vers une struct sys_showparams_args et le fait pointer sur son deuxième paramètre, void *v. Il devient clair que ce second paramètre représente d\u0026rsquo;une certaine manière les paramètres que le userland passe à l\u0026rsquo;appel système.\nLa définition de struct sys_showparams_args ne fait pas partie de notre implémentation parce qu\u0026rsquo;elle est générée automatiquement au moment du build. Chacun de ses champs correspond à un paramètre dans l\u0026rsquo;interface userland et la macro SCARG() permet de déréférencer la structure correctement, sans avoir à s\u0026rsquo;inquiéter de l\u0026rsquo;alignement ou de l\u0026rsquo;endian de l\u0026rsquo;architecture.\nAppel système retournant une valeur: sys_retparam() # L\u0026rsquo;appel système sys_retparam() prends un paramètre de type int et le retourne s\u0026rsquo;il est inférieur ou égal à 1024, et dans le cas contraire retourne -1, en assignant EINVAL à errno. Son prototype est similaire à celui de sys_showparams():\nint retparam(int val); Implementation # #include \u0026lt;sys/types.h\u0026gt; #include \u0026lt;sys/param.h\u0026gt; #include \u0026lt;sys/systm.h\u0026gt; #include \u0026lt;sys/kernel.h\u0026gt; #include \u0026lt;sys/proc.h\u0026gt; #include \u0026lt;sys/mount.h\u0026gt; #include \u0026lt;sys/syscallargs.h\u0026gt; /* returns value of integer parameter if lesser or equal to 1024 */ sys_retparam(struct proc *p, void *v, register_t *retval) { struct sys_retparam_args /* { syscallarg(int)\tval; } */ *uap = v; unsigned int val; val = SCARG(uap, val); if (val \u0026gt; 1024) return (EINVAL); *retval = val; return (0); } Description # les choses sont un petit peu plus complèxes et nous allons devoir plonger sur ce qu\u0026rsquo;il se passe en dehors de la fonction pour comprendre son fonctionnement.\nLe problème est le suivant: si nous devons retourner 0 en cas de succès et une valeur positive en cas d\u0026rsquo;erreur, alors comment faire pour avoir un appel système qui retourne une valeur positive en cas de succès ?\nLa solution réside dans le troisième paramètre de notre appel système.\nLa valeur retournée par notre appel système n\u0026rsquo;est pas la valeur retournée par l\u0026rsquo;interface de l\u0026rsquo;appel système pour le userland. La valeur de retour de notre appel système sert simplement à déterminer si sont exécution s\u0026rsquo;est déroulée correctement ou assigner errno. La valeur retournée par l\u0026rsquo;interface userland est en réalité placée dans le troisième paramètre de notre implémentation d\u0026rsquo;appel système qui est en rélaité un tableau de deux registres.\nLe premier élément de ce tableau représente EAX, il est initialisé à 0 par l\u0026rsquo;API des appels systèmes avant que notre implémentation ne soit appellée et ne puisse le modifier. Le second élément est rarement utilisé: il sert à resoudre le cas particulier de fork() qui.. retourne deux valeurs, une pour le processus parent et une pour le processus enfant.\n@gilles: L\u0026rsquo;article a été écrit pour amd64 où les registres EAX et EDX sont utilisés pour retval, ce n\u0026rsquo;est évidemment pas le cas pour toutes les autres architectures.\nPour une meilleur compréhension, un coup d\u0026rsquo;oeil a /usr/src/sys/amd64/amd64/trap.c (en remplaçant la plateforme par une autre) est utile: il prépare les paramètres en respectant la convention d\u0026rsquo;appel, déclenche l\u0026rsquo;interruption d\u0026rsquo;appel système, fait correspondre les valeurs de registres et d\u0026rsquo;errno aux bonnes structures pour au final donner une impression uniforme au userland sur toutes les architectures.\nSystem call poking into struct proc: sys_retpid() # Notre dernier appel système, sys_retpid(), prends un int en paramètre qui va faire retourner à notre fonction le pid du processus si la valeur est 0, le pid du processus parent si la valeur est 1 et échouer en assignant EINVAL a errno dans les autres cas. Son prototype est le suivant:\nint retpid(int val); Implémentation # #include \u0026lt;sys/types.h\u0026gt; #include \u0026lt;sys/param.h\u0026gt; #include \u0026lt;sys/systm.h\u0026gt; #include \u0026lt;sys/kernel.h\u0026gt; #include \u0026lt;sys/proc.h\u0026gt; #include \u0026lt;sys/mount.h\u0026gt; #include \u0026lt;sys/syscallargs.h\u0026gt; /* * returns current pid if val == 0 * returns parent pid if val == 1 * return -1 and sets errno to EINVAL otherwise */ sys_retpid(struct proc *p, void *v, register_t *retval) { struct sys_retpid_args /* { syscallarg(int)\tval; } */ *uap = v; unsigned int val; val = SCARG(uap, val); if (val != 0 \u0026amp;\u0026amp; val != 1) return (EINVAL); if (val == 0) *retval = p-\u0026gt;p_pid; else *retval = p-\u0026gt;p_pptr-\u0026gt;p_pid; return (0); } @gilles: Notez que cette fonction peu ou non exploser, pour de multiples raisons, et si vous ne comprenez pas pourquoi, ne copiez-collez pas ce code optimiste qui ne fait pas les vérifications et le locking adéquats.\nCe commentaire est valide pour toutes les fonctions de cet article.\nDescription # Ce dernier appel nous permet d\u0026rsquo;illustrer que la fonction ne s\u0026rsquo;exécute pas en userland mais vraiment dans le kernel, il nous permets d\u0026rsquo;accéder à la mémoire en dehors de celle du processus courant. Ici, nous déréférençons la struct proc associée à notre processus mais aussi un pointeur vers une autre struct proc, nous pouvons utiliser les différentes listes chainées internes à la struct proc pour accéder à des ressources qui ne sont pas accessibles à notre processus courant en userland.\nNotez que c\u0026rsquo;est juste un exemple et qu\u0026rsquo;il faut faire bien attention à faire le bon locking requis, si l\u0026rsquo;appel système accède à une ressource qui a été libérée, le résultat ne sera pas un crash du processus mais un crash du système.\nIntégration # @gilles: La version initiale de cette article date de 2005 et présentait le link static et les loadable kernel modules. Depuis, l\u0026rsquo;interface LKM a été supprimée d\u0026rsquo;OpenBSD, j\u0026rsquo;ai donc supprimé les parties qui ne présentaient plus d\u0026rsquo;intérêt de nos jours pour garder l\u0026rsquo;article court. @gpt-4: Lors de la mise en œuvre de nouveaux appels système, il est essentiel de faire de la sécurité une priorité dans vos considérations. Par conception, les appels système font le pont entre l\u0026rsquo;espace utilisateur et le noyau, ce qui, s\u0026rsquo;il n\u0026rsquo;est pas correctement géré, peut exposer le système à diverses vulnérabilités.\nLors de la conception d\u0026rsquo;un appel système, il est crucial de valider toutes les données en entrée. Comme les appels système fonctionnent avec des privilèges de niveau noyau, toutes les données en entrée peuvent potentiellement interagir avec des parties critiques du système, et doivent donc être soigneusement examinées.\nRéfléchissez attentivement aux capacités que votre nouvel appel système devrait avoir. Si un appel système a seulement besoin de lire des données, il ne devrait pas avoir la capacité d\u0026rsquo;écrire des données. Limiter la fonctionnalité au minimum nécessaire peut limiter les dommages potentiels si l\u0026rsquo;appel système est mal utilisé.\nDe plus, les problèmes de concurrence peuvent conduire à des conditions de course dans les appels système. Des primitives de synchronisation appropriées doivent être utilisées pour éviter ces scénarios. N\u0026rsquo;oubliez pas, une faille dans un appel système peut mettre en péril la sécurité de l\u0026rsquo;ensemble du système, donc être attentif aux vulnérabilités potentielles est de la plus haute importance.\nGardez à l\u0026rsquo;esprit qu\u0026rsquo;OpenBSD, comme d\u0026rsquo;autres systèmes de type Unix, suit le principe du privilège minimal, qui suggère qu\u0026rsquo;un processus ne devrait se voir accorder que les privilèges qui sont essentiels à sa fonction. En tant que concepteur d\u0026rsquo;appel système, votre responsabilité est de vous assurer que votre appel système est en accord avec ce principe.\nIntégration d\u0026rsquo;appels système par linkage statique # Plusieurs fichiers sont en jeu lors d\u0026rsquo;une intégration statique d\u0026rsquo;appel système:\n/usr/src/sys/kern.syscalls.master est le fichier principal utilisé pour ajouter un appel système. Il est utilisé pour rebuilder un ensemble de tableaux et de structures internes utilisées par l\u0026rsquo;API des appels systèmes. /usr/src/sys/kern/syscalls.c contient la liste des appels système. /usr/src/sys/kern/init_sysent.c contient la table sysent. Chaque élément de la table décrit le nombre de paramètres de l\u0026rsquo;appel système, la structure qui est associée à ces paramètres et la fonction utilisée pour implémenter l\u0026rsquo;appel système. /usr/src/sys/sys/syscallargs.h contient la définition des structures associées aux appels système. /usr/src/sys/sys/syscall.h contient les numéros associés à nos appels systèmes représentés par des macros. La première étape est d\u0026rsquo;éditer /usr/src/sys/kern.syscalls.master et de trouver un numéro inutilisé d\u0026rsquo;appel système, ou d\u0026rsquo;en ajouter un s\u0026rsquo;il n\u0026rsquo;y en a pas de disponible. Le format du fichier est très simple, il consiste en un numéro d\u0026rsquo;appel système, un type d\u0026rsquo;appel système et un pseudo-prototype.\nUne fois modifié, les fichiers autogénérés peuvent être reconstruits par ces commandes:\n# cd /usr/src/sys/kern # make init_sysent.c Les fichiers décrits ci-dessus sont reconstruits en prenant en compte les nouveaux appels systèmes et en produisant les structures nécessaires pour leurs paramètres. Tout ce qu\u0026rsquo;il reste à faire est de reconstruire le kernel après avoir ajouté les fichiers contenant les implémentations de nos appels système.\nLes appels système sont indépendant de l\u0026rsquo;architecture, leurs implémentations sont placéees dans /usr/src/sys/kern.\nVous devez ensuite éditer /usr/src/sys/kern/files et y ajouter les lignes suivantes:\nfile kern/sys_goodbye.c file kern/sys_showparam.c file kern/sys_retparam.c file kern/sys_retpid.c puis reconstruire le kernel.\nÀ ce stade, une fois le système redémarré sur le nouveau kernel, nos appels systèmes sont utilisables par les applications en userland qui connaissent leur numéro au travers de l\u0026rsquo;appel système syscall().\nPour pouvoir les appeler par leur nom, vous devrez mettre à jour les fichiers d\u0026rsquo;entêtes /usr/include/sys/syscall.h et /usr/include/sys/sycallargs.h avec ceux générés durant la phase de make init_sysent.c, puis reconstruire la libc après avoir ajouté les fichiers objets (sans leur préfixe sys_) dans /usr/src/lib/libc/sys/Makefile.inc.\nLa libc est reconstruire avec les commandes suivantes:\n# cd /usr/src/lib/libc # make install Les appels systèmes sont immédiatement disponibles sans besoin d\u0026rsquo;un redémarrage du système.\nUn mot du futur, 2023 # Soyez gentils avec le gilles@ de 2005, n\u0026rsquo;hésitez pas à commenter ou soumettre une pull request pour mettre à jour l\u0026rsquo;article et le moderniser.\nAu cas où vous vous le demandez, cette interface n\u0026rsquo;est pas exactement celle de NetBSD ou de FreeBSD, mais les interfaces et structures se ressemblent assez pour pouvoir démarrer. Si vous le voulez, je pourrais écrire quelques articles autour de ces sujets à l\u0026rsquo;avenir.\nAu cas où vous vous le demandez aussi, cette interface ne vous aidera pas du tout pour écrire un appel système sous Linux. Tout diffère, depuis la manière dont le code est organisé, à la manière dont les appels systèmes sont enregistrés, en passant par la convention d\u0026rsquo;appel. Les concepts sont les mêmes, l\u0026rsquo;implémentation et les API sont radicalement différentes. J\u0026rsquo;ai écrit un devoir là dessus aussi, implémentant exactement les mêmes appels systèmes en décrivant le cheminement, mais j\u0026rsquo;ai trouvé ça pénible au possible et ça se ressentait dans l\u0026rsquo;article 😆\nLectures en rapport\u0026hellip; # Je recommande la lecture de ces deux livres sur le sujet:\n","date":"25 Janvier 2023","permalink":"/fr/posts/2023-07-25/implementer-un-appel-syst%C3%A8me-pour-openbsd/","section":"Posts","summary":"TL;DR: J\u0026rsquo;ai retrouvé une copie imprimée d\u0026rsquo;un devoir que j\u0026rsquo;ai eu à faire en 2005, quand j\u0026rsquo;étais encore étudiant, pour implémenter un appel système sous OpenBSD et Linux.","title":"Implementer un appel système pour OpenBSD"},{"content":"","date":"25 Janvier 2023","permalink":"/fr/tags/kernel/","section":"Tags","summary":"","title":"kernel"},{"content":"","date":"25 Janvier 2023","permalink":"/fr/tags/openbsd/","section":"Tags","summary":"","title":"OpenBSD"},{"content":"","date":"25 Janvier 2023","permalink":"/fr/categories/technologie/","section":"Categories","summary":"","title":"technologie"},{"content":" TL;DR: J\u0026rsquo;ai reçu le nouveau manche et\u0026hellip; il est parfaitement adapté ! Le manche # UPS vient de me livrer mon nouveau manche, un clone de PRS 24 frettes:\nPas grand chose à dire, c\u0026rsquo;est de l\u0026rsquo;Érable canadien et une touche en Jatoba (cerisier Brésilien), le toucher est sympa et l\u0026rsquo;esthétique aussi même si je ne la conserverai pas.\nJ\u0026rsquo;ai tenté de voir s\u0026rsquo;il tenait bien en place et il est parfaitement adapté:\nLes outils # J\u0026rsquo;ai aussi reçus quelques outils pour faire de petits travaux sur le corps, comme limer des contours:\net un spray à peinture que j\u0026rsquo;utiliserai pour peindre le corps et la tête:\nLa raison pour laquelle j\u0026rsquo;ai eu besoin d\u0026rsquo;outil est pour retravailler la tête, mais aussi pour ajouter des contours pour ce corps un peu trop épais pour moi. Je ne ferais pas grand chose, juste le strict minimum pour qu\u0026rsquo;elle soit un peu plus comfortable.\nPour la peinture, j\u0026rsquo;ai décidé de ne pas partir sur un look naturel puisque j\u0026rsquo;ai déjà une guitare comme ça, et que j\u0026rsquo;ai envie d\u0026rsquo;expérimenter avec des couleurs.\nLa peinture # À l\u0026rsquo;origine, je voulais utilisera de la peinture de tableau blanc et de tableau craie pour avoir une guitare sur laquelle mon fils peut dessiner, mais j\u0026rsquo;ai décidé de garder ça pour un autre projet où je metterai du matériel de moins bonne qualité.\nJe suis tombé amoureux d\u0026rsquo;une peinture noire l\u0026rsquo;an dernier, et par peinture noire je veux dire la plus noire des peintures noires, j\u0026rsquo;ai donc une bouteille qui attends encore sur mon étagère d\u0026rsquo;être utilisée.\nMais j\u0026rsquo;aime aussi la peinture Easy Klein de la même entreprise:\nEnfin, j\u0026rsquo;aime aussi leur pigment phosphorescent :\nPour être honnête, j\u0026rsquo;aime toutes leurs couleurs, leur rouge \u0026ldquo;urgence\u0026rdquo; est magnifique (et sold out), ils ont aussi de très beaux blancs et perle, je testerai surement plus tard.\nÀ ce stade, j\u0026rsquo;ai commandé les trois du dessus et j\u0026rsquo;attends la livraison qui devrait\u0026hellip; prendre pas mal de temps vu le délai lorsque j\u0026rsquo;ai commandé la peinture noire l\u0026rsquo;an dernier.\nJe ne suis pas encore décidé sur ce que j\u0026rsquo;utiliserai sur quelle partie de la guitare, j\u0026rsquo;ai déjà des idées mais pas un design définitif, la seule chose de sûre est qu\u0026rsquo;il y aura du noir, du bleu et du phosphorescent.\nMécaniques # Pour les mécaniques, je me suis arrêté sur les Graph Tech Ratio Locking qui existent aussi en argenté et dont je me déciderai du modèle quand je saurais de quelle couleur sera la tête de la guitare.\nPourquoi celles là ?\nce sont des mécaniques bloquantes, une nette amélioration sur ce que j\u0026rsquo;utilise, et si vous ne savez pas ce que sont les mécaniques bloquantes\u0026hellip; je vous recommande de chercher sur youtube: elles permettent de facilement changer les corpses, de mieux garder la tenue de l\u0026rsquo;accordage, et elles évitent d\u0026rsquo;avoir à faire cinquante tours de moulinets, il suffit de bloquer les cordes en place et de faire un ou deux tours. ces mécaniques spécifiques ont aussi un ratio de rotation par corde qui permet d\u0026rsquo;avoir un accordage d\u0026rsquo;un demi-ton par demi-tour quelle que soit la corde: plus besoin de faire un tour sur une corde et quatre sur l\u0026rsquo;autre, sans compter qu\u0026rsquo;à partir du moment où l\u0026rsquo;on connait ses intervalles, accorder ou désaccorder en conséquence devient plus simple. Quand le manche sera peint et que j\u0026rsquo;en serais content, je placerai une commande et je vous montrerai des photos de leur mise en place.\nmicros et chevalet # Je n\u0026rsquo;ai pas encore décidé de ce que je veux pour mes micros et mon chevalet, je vais attendre que le corps soit fini pour me décider.\nJ\u0026rsquo;ai quelques idées, une shortlist, mais je ne suis pas encore décidé et peux encore changer radicalement d\u0026rsquo;idée.\nUne seule chose est sûre, je vais jouer pas mal de jazz avec mais j\u0026rsquo;aimerai faire un peu de metal à la maison, mon plan est d\u0026rsquo;avoir des micros dépareillés: un micro très jazzy pour le manche vu que c\u0026rsquo;est la position que j\u0026rsquo;adopte toujours, et un micro très metal pour le chevalet vu que là aussi c\u0026rsquo;est la position que j\u0026rsquo;adopte toujorus.\nCe serait super s\u0026rsquo;ils pouvaient être splittables, je ne sais pas si ce sera possible, à voir.\nQuelque chose que j\u0026rsquo;aimerai bien aussi est un kill switch, j\u0026rsquo;aime l\u0026rsquo;idée d\u0026rsquo;un kill switch, je veux un kill switch.\nLa suite ? # Je ne pourrais pas faire grand chose avant la fin de Juillet comme j\u0026rsquo;ai d\u0026rsquo;autres choses prévues, je vous tiens au courant.\n","date":"4 Janvier 2023","permalink":"/fr/posts/2023-07-04/construire-ma-propre-guitare-partie-3/","section":"Posts","summary":"TL;DR: J\u0026rsquo;ai reçu le nouveau manche et\u0026hellip; il est parfaitement adapté ! Le manche # UPS vient de me livrer mon nouveau manche, un clone de PRS 24 frettes:","title":"Construire ma propre guitare, partie 3"},{"content":" TL;DR: J\u0026rsquo;ai reçu le manche\u0026hellip; dommage que ce ne soit pas exactement celui que j\u0026rsquo;ai commandé :-) Le manche # Pour le manche, je voulais un manche 24 frettes et j\u0026rsquo;en ai trouvé un qui me plaisait bien en ligne.\nÀ la livraison aujourd\u0026rsquo;hui, j\u0026rsquo;ai réalisé qu\u0026rsquo;ils n\u0026rsquo;avaient pas envoyés le bon et qu\u0026rsquo;il s\u0026rsquo;agissait d\u0026rsquo;un manche 22 frettes (voir photo d\u0026rsquo;illustration de l\u0026rsquo;article). Je trouve qu\u0026rsquo;il est très beau, il n\u0026rsquo;empêche que ce n\u0026rsquo;est pas exactement ce que je voulais, sans compter qu\u0026rsquo;il ne corresponds pas aux mesures annoncées par le marchand et n\u0026rsquo;est pas exactement adapté: il semble qu\u0026rsquo;en matière de construction de guitares, les millimètres ça compte.\nJ\u0026rsquo;ai décidé de commander un manche de PRS:\nque j\u0026rsquo;essaierai de customiser si j\u0026rsquo;y arrive. Je devrais le recevoir dans quelques jours, je posterai une mise à jour alors.\nDans l\u0026rsquo;intervalle, j\u0026rsquo;ai commencé à regarder trois choses:\nles mécaniques le chevalet les micros Je veux que les mécaniques soient bloquantes, j\u0026rsquo;ai lu de bonnes chose sur les Schaller M6, elles sont en tête de liste mais je regarde les alternatives. Quand je prendra ma décision et que je les recevrai, je posterai un article un peu plus long sur les raisons de mon choix.\nPour le chevalet, je veux un chevalet flottant mais qui ne soit pas un floyd rose vu que j\u0026rsquo;en ai déjà, j\u0026rsquo;aime bien mais les inconvénients me donnent envie d\u0026rsquo;avoir autre chose sur une autre guitare. Je regarde actuellement les chevalets tremolo Gotoh 1502 et 1802, et je n\u0026rsquo;ai pas encore décidé si je resterai sur cette idée mais je posterai là aussi un article explicatif de ma décision une fois que je serais décidé.\nEnfin, pour les micros, je n\u0026rsquo;ai rien décidé à part que je voudrais des micros passifs et différents: le micro manche devrait être aedapté au jazz et au blues, le micro chevalet devrait être adapté au metal. Idéalement, s\u0026rsquo;ils sont splittables, c\u0026rsquo;est mieux. J\u0026rsquo;ai une petite liste de micros à aller enquêter, mais comme c\u0026rsquo;est la partie la plus chère, je vais attendre de voir la tournure que prends le projet avant de m\u0026rsquo;engager au cas où la construction s\u0026rsquo;avère pas géniale.\nLa suite ? # J\u0026rsquo;attends que le nouveau manche arrive, j\u0026rsquo;enquête un peu plus sur les mécaniques et le chevalet, plus d\u0026rsquo;infos dans le prochain article :-)\n","date":"29 Janvier 2023","permalink":"/fr/posts/2023-06-29/construire-ma-propre-guitare-partie-2/","section":"Posts","summary":"TL;DR: J\u0026rsquo;ai reçu le manche\u0026hellip; dommage que ce ne soit pas exactement celui que j\u0026rsquo;ai commandé :-) Le manche # Pour le manche, je voulais un manche 24 frettes et j\u0026rsquo;en ai trouvé un qui me plaisait bien en ligne.","title":"Construire ma propre guitare, partie 2"},{"content":" TL;DR: Je construis une guitare \u0026ldquo;from scratch\u0026rdquo;, en choisissant chacun des composants mais en évitant les découpes :-) À propos de ce projet # Le but premier de ce projet est de construire une guitare customisée, en choisissant chacun des composants un par un, pour qu\u0026rsquo;elle soit 100% ce que je veux qu\u0026rsquo;elle soit.\nLe second but est de me donner un objectif raisonnable en évitant les aspects trop complexes de la construction d\u0026rsquo;une guitare, comme la grosse découpe et les collages trop minutieux, pour voir si j\u0026rsquo;aime bien construire des guitares.\nCette série d\u0026rsquo;articles va suivre ce petit projet, usqu\u0026rsquo;à sa finition ou son échec complet, quoi qu\u0026rsquo;il arrive :-)\nLe corps # Pour le corps, je veux une forme traditionelle et comme j\u0026rsquo;aime beaucoup les guitares PRS, j\u0026rsquo;ai décidé d\u0026rsquo;aller dans cette direction ou proche.\nJ\u0026rsquo;aurai aimé savoir choisir mon bois mais, vu que je ne vais pas le couper moi-même, la recherche est limitée à ce que je peux avoir à disposition.\nJe me suis arrêté sur ce corps en Acajou et Érable vernis. Je l\u0026rsquo;ai commandé il y a deux jours sur La fabrique à guitare et il a été livré aujourd\u0026rsquo;hui.\nLe corps est plutôt joli en ce qui me concerne, mais en pratiue il est un peu rugueux et a besoin de ponçage, je pense aussi le vernir et le teindre.\nLa suite ? # J\u0026rsquo;ai trouvé un joli manche pour aller avec, commandé depuis un autre marchand, il devrait arriver demain et je vous le montrerais dès que je verrais s\u0026rsquo;il est utilisable.\n","date":"28 Janvier 2023","permalink":"/fr/posts/2023-06-28/construire-ma-propre-guitare-partie-1/","section":"Posts","summary":"TL;DR: Je construis une guitare \u0026ldquo;from scratch\u0026rdquo;, en choisissant chacun des composants mais en évitant les découpes :-) À propos de ce projet # Le but premier de ce projet est de construire une guitare customisée, en choisissant chacun des composants un par un, pour qu\u0026rsquo;elle soit 100% ce que je veux qu\u0026rsquo;elle soit.","title":"Construire ma propre guitare, partie 1"},{"content":" TL;DR: Je vais parler de musique sur ce site à partir de maintenant. Ce blog est un blog musical aussi # Comme certains le savent, j\u0026rsquo;ai un profond intérêt pour la musique.\nCette section du blog va se concentrer sur des sujets liés à la musique, aussi bien du point de vue d\u0026rsquo;un auditeur, que de celle d\u0026rsquo;un musicien amateur et/ou d\u0026rsquo;un producteur.\nJe posterai des fois des liens vers de la musique que j\u0026rsquo;ai envie de partager, parce que je l\u0026rsquo;ai moi-même produite, ou parce que je l\u0026rsquo;ai aimée, mais j\u0026rsquo;écrirais aussi des articles et partagerai des reviews de matériels et logiciels.\n","date":"25 Janvier 2023","permalink":"/fr/posts/2023-06-25/une-nouvelle-section-apparait/","section":"Posts","summary":"TL;DR: Je vais parler de musique sur ce site à partir de maintenant. Ce blog est un blog musical aussi # Comme certains le savent, j\u0026rsquo;ai un profond intérêt pour la musique.","title":"Une nouvelle section apparait !"},{"content":" TL;DR: le greylisting est une bonne idée ce n\u0026rsquo;est pas très pratique aujourd\u0026rsquo;hui beaucoup de gens se passent du greylisting ou trouvent des contournements le SPF-aware greylisting rend le greylisting utilisable à nouveau Shout out a mes sponsors ❤️ # Un GRAND MERCI à mes sponsors sur github et patreon: votre soutien est grandement apprécié !\nOù est-ce que j\u0026rsquo;ai déjà lu ça ? # Cet article est une traduction de l\u0026rsquo;article \u0026ldquo; SPF-aware greylisting and filter-greylist\u0026rdquo;, publié sur ce blog début Décembre.\nC\u0026rsquo;est mon troisième article rédigé en français depuis des années, je vous demande donc un peu d\u0026rsquo;indulgence : si vous trouvez des fautes, vous pouvez me les remonter pour que je les corrige, ou faire une pull request pour les techies.\nN\u0026rsquo;hésitez pas à partager la publication à l\u0026rsquo;aide des icônes en fin d\u0026rsquo;article et à la commenter \u0026lt;3\nBonne lecture !\nLes erreurs SMTP en quelques mots # SMTP est un protocole fail-safe qui essaie de son mieux de garantir que les messages ne se perdent pas en transit. Parmi les différents mécanismes et exigences du standard on trouve l\u0026rsquo;utilisation d\u0026rsquo;échecs temporaires.\nConcrètement, un nœud SMTP a deux états finaux pour un message : soit le message est distribué et le nœud destination le détient, soit il n\u0026rsquo;est PAS distribué et le nœud destination ne le détient pas. Dans le second cas, le protocole SMTP exige que le dernier nœud en charge notifie l\u0026rsquo;émetteur qu\u0026rsquo;une erreur est survenue. Soit en rejetant le message lors de la session, soit à l\u0026rsquo;aide d\u0026rsquo;une mail d\u0026rsquo;erreur différé (aussi connu sous le nom de MAILER-DAEMON).\nEnfin, il y a un troisième état qui n\u0026rsquo;est pas final : l\u0026rsquo;échec temporaire. Il couvre tous les cas d\u0026rsquo;erreurs qui ont pu temporairement empêcher la distribution… mais qui pourraient tout aussi bien ne plus se produire si quelque chose était corrigé sur le nœud de destination.\nContrairement aux mails distribués, que les destinataires voient, et aux mails échoués, que les émetteurs voient, les mails en échec temporaire ne sont généralement pas vus par les utilisateurs. Ils sont traités entre les Mail eXchangers (MX) qui tentent de se les retransmettre en arrière-plan. Il ne sont généralement vus par les utilisateurs que lorsque les tentatives finissent par réussir ou qu\u0026rsquo;elles échouent définitivement après que leur temps de vie a expiré.\nDans le premier cas, le destinataire va recevoir le message un peu plus tard que prévu, le plus souvent sans même avoir su que des tentatives de retransmission ont eu lieu. Dans le second cas, l\u0026rsquo;émetteur recevra une notification lui indiquant que, malgré les retransmissions, le message n\u0026rsquo;a pas pu être distribué dans le délai imparti.\nLes stratégies de retransmission en cas d\u0026rsquo;échec temporaire sont gérées différemment dans les différents logiciels, mais vous pouvez postuler qu\u0026rsquo;il y aura une retransmission dans les secondes ou minutes qui suivent un échec temporaire. Une approche populaire, l\u0026rsquo;incrément quadratique du délai, crée un délai initialement court mais qui augmente avec le nombre de tentatives en échec de sorte que plus un hôte est injoignable longtemps, plus les tentatives vers cet hôte sont espacées.\nLes échecs temporaires arrivent tout le temps, c\u0026rsquo;est quelque chose de normal dans le protocole SMTP, et en regardant les logs on verra très souvent des lignes telles que :\n4b3a6c195c1f6010 mta delivery evpid=8f26ea98359eccea from=\u0026lt;misc+bounces-4541-[redacted]=tin.it@opensmtpd.org\u0026gt; to=\u0026lt;[redacted]@tin.it\u0026gt; rcpt=\u0026lt;-\u0026gt; source=\u0026quot;45.76.46.201\u0026quot; relay=\u0026quot;62.211.72.32 (smtp.tin.it)\u0026quot; delay=0s result=\u0026quot;TempFail\u0026quot; stat=\u0026quot;421 \u0026lt;[redacted]@tin.it\u0026gt; Service not available - too busy\u0026quot; Il ne s\u0026rsquo;agit pas d\u0026rsquo;erreurs que l\u0026rsquo;on ne trouve que chez des petits serveurs personnels. Je connais deux Big Mailer Corps qui ont des machines en échec temporaire à peu près en permanence, ils ont juste suffisamment de MX pour qu\u0026rsquo;une retransmission ait peu de chances de taper le même MX deux fois de suite. Les mails sont généralement distribués à la première ou seconde tentative.\nPetit secret rien qu\u0026rsquo;entre nous : certains Big Mailer Corps se servent volontairement de ces échecs temporaires pour évaluer la réputation des émetteurs. Ils génèrent ces erreurs à des moments clefs qui leurs permettent certaines analyses sur lesquelles je reviendrai dans un futur article.\nIl y a beaucoup de choses à dire sur les erreurs SMTP, mais résumons l\u0026rsquo;essentiel pour cet article :\nIl existe un mécanisme dans le protocole SMTP qui permet à un MX destinataire de demander à un MX émetteur de retransmettre un message. La retransmission a lieu en arrière-plan, sans aucune action des utilisateurs, et elle peut provoquer un délai dans la distribution.\nLe greylisting expliqué # Le spam est une industrie du volume.\nLes spammeurs ne sont pas intéressés par cibler des destinataires spécifiques. Ils sont intéressés par cibler un grand nombre de destinataires pour que statistiquement cela augmente le nombre de destinataires qui se feront avoir.\nJe ne vais pas trop creuser ce sujet parce que c\u0026rsquo;est l\u0026rsquo;objet d\u0026rsquo;un autre article en rédaction, néanmoins vous devez avoir à l\u0026rsquo;esprit qu\u0026rsquo;il y a différents types de spammeurs. Alors que certains utilisent des MX tout ce qu\u0026rsquo;il y a de plus normaux qui honorent les demandes de retransmissions, beaucoup d\u0026rsquo;autres utilisent des outils ou des MX customisés pour NE PAS retransmettre.\nHonorer les retransmissions ralentit considérablement l\u0026rsquo;émission pour un résultat incertain. Garder trace de tous les destinataires en échec temporaire pendant des heures ou des jours pour pouvoir les retenter est loin d\u0026rsquo;être intéressant, surtout s\u0026rsquo;il n\u0026rsquo;y a pas de certitude que la retransmission n\u0026rsquo;aboutira pas en un échec permanent de type \u0026ldquo;cet utilisateur n\u0026rsquo;existe pas\u0026rdquo;. Il faut conserver un état pour se rappeller des tentatives en échec et conserver les destinataires dans la queue d\u0026rsquo;envoi. Directement ou indirectement cela impacte la capacité à envoyer en masse.\nL\u0026rsquo;idée derrière le greylisting est très simple :\nLe greylisting déclenche un échec temporaire pour les MX auquels vous ne faites pas encore confiance et garde trace des tentatives de retransmission. Si la retransmission a lieu trop tôt elle est ignorée, les spammers ne peuvent pas faire une retransmission immédiate et doivent garder un état. Si la retransmission a lieu trop tard… et bien c\u0026rsquo;est trop tard, l\u0026rsquo;implémentation peut faire un bon nombre de choses depuis l\u0026rsquo;ajout en blacklist à la dégradation de la réputation, en passant par un nouveau tour de greylisting, encore et encore et encore, … Le résultat est que pour passer le greylisting, les spammeurs sont contraints de conserver un état et de se comporter comme des implémentations correctes du point de vue de la RFC. C\u0026rsquo;est en conflit direct avec l\u0026rsquo;économie de l\u0026rsquo;envoi de masse.\nD\u0026rsquo;un autre côté, les MX qui respectent la RFC vont naturellement retenter de nombreuses fois et finir par faire une tentative dans la bonne fenêtre de temps pour être whitelistés.\nLe greylisting ne permet pas de se prémunir des spammeurs qui ont compromis des MX légitimes, ni de ceux qui envoient à l\u0026rsquo;aide d\u0026rsquo;outils qui acceptent le coût de la retransmission. Il permet par contre d\u0026rsquo;éliminer la plus grosse partie du spam : celle qui provient de machines infectées et transformées en bots à spam, ou de scripts dont le seul but est d\u0026rsquo;envoyer un maximum possible avant qu\u0026rsquo;un hébergeur ou un administrateur ne s\u0026rsquo;en rende compte.\nComment le greylisting fonctionne habituellement # Il y a différentes solutions de greylisting et elles ne fonctionnent pas toutes pareil.\nL\u0026rsquo;idée générale est que vous avez une base de donnée qui garde trace des demande de retransmissions et de la fenêtre de temps durant laquelle une tentative est considérée comme valide pour un MX. En revanche, la manière dont sont comptabilisées les tentatives d\u0026rsquo;un MX varie d\u0026rsquo;une solution à une autre. Certaines solutions ne regardent que l\u0026rsquo;adresse IP source, alors que d\u0026rsquo;autres vont également regarder le MAIL FROM et/ou le RCPT TO. Dans certains cas que j\u0026rsquo;ai pu observer, la solution regardait également l\u0026rsquo;entête Message-ID.\nLa solution spamd(8) d\u0026rsquo;OpenBSD va par exemple garder trace de l\u0026rsquo;adresse IP source, le nom d\u0026rsquo;hôte utilisé lors de la phase d\u0026rsquo;identification HELO/EHLO, l\u0026rsquo;émetteur d\u0026rsquo;envelope (MAIL FROM) et le destinataire d\u0026rsquo;envelope (RCPT TO). Pour passer le greylisting, un MX doit faire une retransmission dans la bonne fenêtre de temps, en provenance de la même IP source, en utilisant le même nom d\u0026rsquo;hôte à l\u0026rsquo;identification, depuis le même émetteur et pour le même destinataire.\nLe problème avec le greylisting et les Big Mailer Corps # Pour de petits émetteurs, le greylisting marche très bien parce que la plupart utilisent le même MX pour le trafic entrant et sortant. Le MX vous contacte, il lui est demandé de retenter plus tard, il est accepté lorsqu\u0026rsquo;il revient une minute plus tard.\nEnsuite, vous avez Gmail / Yahoo / Outlook / … qui non seulement disposent de MX différents pour le trafic entrant et sortant, mais ont également des douzaines et des douzaines de MX sortants. La situation devient la suivante : un MX vous contacte, il lui est demandé de retenter plus tard, mais vous ne voyez jamais de retransmission de ce MX puisque c\u0026rsquo;est un autre qui a retenté et à qui il a été demandé de retenter plus tard, etc…\nLe greylisting avec ces hôtes est inutilisable et résulte en des mails qui peuvent arriver avec plusieurs heures ou jours de retard, s\u0026rsquo;ils n\u0026rsquo;expirent pas tout simplement avant de vous atteindre.\nMais en même temps, le greylisting empêche une grande quantité de nuisibles de vous atteindre en tuant le trafic de presque tous les scripts et les ordinateurs compromis. Donc pour le conserver, un grand nombre d\u0026rsquo;opérateurs de mails mettent en place des bricolages pour pouvoir continuer à utiliser le greylisting pour les petits émetteurs, tout en ne l\u0026rsquo;appliquant pas pour les Big Mailer Corps.\nStratégies de contournement # J\u0026rsquo;utilise le pluriel mais en réalité toutes les stratégies reposent sur la même idée : le whitelisting.\nLe contournement consiste à trouver la liste des adresses IP des Big Mailer Corps pour leur donner un passe droit et leur permettre d\u0026rsquo;éviter le greylisting.\nEst-ce que cela met en défaut le greylisting ? Pas vraiment. Le greylisting a pour but d\u0026rsquo;empêcher les MX ne respectant pas la RFC de vous atteindre, mais les Big Mailer Corps utilisent des MX qui respectent la RFC. Lorsque la retransmission a bien lieu plusieurs fois par le même MX sortant, ils passent le test du greylisting sans souci.\nTrès bien, ajoutons-les à la whitelist alors… mais comment ?\nPendant un moment, j\u0026rsquo;ai utilisé une approche naïve consistant à whitelister le /24 de n\u0026rsquo;importe quel MX de Big Mailer Corps qui se retrouvait greylisté. Après quelques temps, ma liste était suffisamment grande pour que de nouveaux MX soient rarement hors de ma whitelist. C\u0026rsquo;était pénible, ça ne couvrait pas le cas de nouveaux MX me contactant depuis de nouvelles plages d\u0026rsquo;adresses IP, et j\u0026rsquo;ai fini par aggréger les listes de différentes personnes à la mienne pour être sûr d\u0026rsquo;en avoir le plus possible. Le résultat était une whitelist en augmentation constante.\nCe n\u0026rsquo;était pas très malin parce que la plupart des Big Mailer Corps utilisent SPF. Ils ont un enregistrement DNS qui liste avec quelles adresses IP ils nous contactent, de façons à ce que lorsque l\u0026rsquo;on reçoit un mail avec une adresse e-mail en provenance de chez eux, on puisse vérifier que c\u0026rsquo;est bien un de leurs MX autorisé qui l\u0026rsquo;a transmis. Avec ça en tête, j\u0026rsquo;ai écrit spfwalk (maintenant une sous-commande de smtpctl) en Janvier 2018, un outil qui permet de faire une énumération dans l\u0026rsquo;enregistrement SPF d\u0026rsquo;un domaine et extraire un maximum d\u0026rsquo;adresse IP possible. Il y a un article en anglais à propos de spfwalk sur ce blog si ça vous intéresse. L\u0026rsquo;outil avait pour vocation de remplacer mon approche naïve, il est loin d\u0026rsquo;être parfait, j\u0026rsquo;ai fait mon mieux.\nLa façon dont fonctionne SPF permet de vérifier facilement si une adresse IP est autorisée, mais ne permet pas d\u0026rsquo;extraire facilement une liste d\u0026rsquo;adresse pour une vérification ultérieure. Par exemple, certaines politiques SPF s\u0026rsquo;attendent à une résolution DNS inverse de l\u0026rsquo;adresse IP source pour voir si le nom d\u0026rsquo;hôte corresponds au domaine d\u0026rsquo;envoi. Dans ce type de politique SPF, il n\u0026rsquo;y a aucune adresse IP à extraire pour mettre dans une whitelist. Donc… l\u0026rsquo;énumération SPF fonctionne à peu près tant que l\u0026rsquo;on ne tombe pas sur les politiques qui ne peuvent pas être énumérées. Pas de bol pour nous, l\u0026rsquo;un des Big Mailer Corps est dans le périmètre.\nUn grand nombre de personnes sont très contentes avec l\u0026rsquo;énumération SPF. Elle améliore considérablement la situation, mais elle reste un bricolage à mon sens et je n\u0026rsquo;utilise plus cet outil parce qu\u0026rsquo;il ne me semble pas être la bonne approche.\nLa preuve de concept filter-greylist # Le mois dernier, j\u0026rsquo;ai écrit comme preuve de concept pour OpenSMTPD un filtre qui utilise une approche différente et qui est disponible sur Github.\nJe vais juste clarifier avant tout que je ne prétends pas avoir inventé cette méthode, elle m\u0026rsquo;a juste semblée être une bonne approche alors je l\u0026rsquo;ai implémentée. Il se peut qu\u0026rsquo;on trouve d\u0026rsquo;autres implémentations de cette même idée ailleurs, j\u0026rsquo;avoue que je n\u0026rsquo;ai pas vraiment cherché très fort (pour ne pas dire \u0026ldquo;du tout\u0026rdquo;). Je ne sais donc pas s\u0026rsquo;il existe d\u0026rsquo;autres implémentations similaires, et si elles existent je ne sais pas si mon implémentation exploite l\u0026rsquo;idée de la même manière.\nL\u0026rsquo;idée de base est que nous ne voulons pas vraiment que les Big Mailer Corps soient exemptés de greylisting, ils en sont exemptés parce que l\u0026rsquo;on ne sait pas considérer tous leurs MX sortants comme identiques dans un test de greylisting. En faisant une énumération SPF pour extraire leurs adresses IP, notre intention est simplement de considérer que toutes les adresses IP de tous leurs MX sortants sont identiques pour nous : elles devraient pouvoir être interchangeables dans un test de greylisting. En d\u0026rsquo;autres termes, ce que l\u0026rsquo;on veut c\u0026rsquo;est un SPF-aware greylisting (greylisting conscient de SPF).\nLa preuve de concept considère qu\u0026rsquo;il y a deux types d\u0026rsquo;émetteurs : ceux qui publient des enregistrements SPF et ceux qui n\u0026rsquo;en publient pas.\nLes MX qui ne publient pas d\u0026rsquo;enregistrement SPF sont greylistés par adresse IP source, comme cela serait le cas avec un greylisting traditionnel. Commes les Big Mailer Corps requièrent que les émetteurs fournissent un enregistrement SPF pour ne pas dégrader leur réputation, et parce que la plupart des gens veulent pouvoir émettre vers les Big Mailer Corps, la plupart des émetteurs légitimes ne devraient pas rentrer dans ce cas. Ne devraient rentrer dans ce cas que des petits émetteurs qui n\u0026rsquo;émettent pas depuis un grand nombre d\u0026rsquo;adresse, et dont le greylisting serait identique qu\u0026rsquo;il soit par adresse IP ou domaine.\nEnsuite, nous avons les MX qui publient des enregistrements SPF, englobant l\u0026rsquo;ensemble des Big Mailer Corps pour des raisons évidentes (difficile d\u0026rsquo;imposer SPF à d\u0026rsquo;autres sans se l\u0026rsquo;imposer à soi-même). Pour ceux-ci, plutôt que d\u0026rsquo;avoir recours a un greylisting par IP source, on procède à un greylisting SPF du domaine.\nEn supposant que ce soit le premier email que nous recevons d\u0026rsquo;un MX, quand une nouvelle connexion arrive, le filtre garde trace de l\u0026rsquo;adresse IP source. La session SMTP progresse jusqu\u0026rsquo;à la création d\u0026rsquo;une transaction SMTP et le client fournit l\u0026rsquo;émetteur d\u0026rsquo;envelope (MAIL FROM) :\nS: 220 in.mailbrix.mx ESMTP OpenSMTPD C: EHLO localhost S: [...] S: 250 in.mailbrix.mx Hello localhost [127.0.0.1], pleased to meet you C: MAIL FROM:\u0026lt;gilles@poolp.org\u0026gt; À ce stade, le filtre peut faire une recherche SPF pour le domaine de l\u0026rsquo;émetteur d\u0026rsquo;enveloppe, poolp.org. S\u0026rsquo;il ne trouve pas d\u0026rsquo;enregistrement SPF, il pourra garder trace de l\u0026rsquo;adresse IP source et demander une retransmission.\nS\u0026rsquo;il trouve un enregistrement SPF, il vérifie que l\u0026rsquo;adresse IP source est valide pour cet enregistrement. Si elle ne l\u0026rsquo;est pas, il peut supposer qu\u0026rsquo;elle ne provient pas du domaine émetteur, le filtre va là encore procéder à un greylisting par adresse IP source. Une approche plus stricte pourrait être de rejeter la session, mais ce n\u0026rsquo;est pas le but d\u0026rsquo;un filtre de greylisting de décider si la violation SPF est acceptable ou non.\nSi en revanche l\u0026rsquo;adresse IP source est valide pour l\u0026rsquo;enregistrement SPF, au lieu de garder trace de l\u0026rsquo;adresse IP source, le filtre garde trace du domaine et demande une retransmission.\nIgnorons dorénavant le cas du greylisting par IP source pour nous concentrer sur le greylisting par domaine.\nLors d\u0026rsquo;une seconde connexion en provenance d\u0026rsquo;un domaine dont le filtre avait gardé trace, si l\u0026rsquo;adresse IP source est valide pour l\u0026rsquo;enregistrement SPF, le filtre va pouvoir valider que le domaine était déjà en demande de retransmission depuis une autre addresse IP et considérer le test comme réussi. En d\u0026rsquo;autres termes plus simples, si Gmail vient d\u0026rsquo;une adresse IP, il est autorisé à venir d\u0026rsquo;une autre addresse IP dès lors que les deux sont déclarées dans l\u0026rsquo;enregistrement SPF.\nCette résolution SPF en live permet de garantir qu\u0026rsquo;il n\u0026rsquo;y a pas besoin de whitelister au préalable les adresses IP. À la place il est possible de whitelister des domaines indépendamment des adresses IP avec lesquelles ils nous contacterons. Cette façon de fonctionner est de plus compatible avec les domaines qui ne fournissent pas d\u0026rsquo;enregistrement SPF, et qui dégradent en un greylisting par IP source.\nIl n\u0026rsquo;est pas possible d\u0026rsquo;implémenter cela dans un daemon comme spamd(8), la décision de greylister ou de laisser la session progresser est prise au moment du MAIL FROM, là ou la redirection spamd(8) est décidée par le firewall à la connexion.\nEst-ce que ça peut être amélioré ? # Je ne sais pas trop mais je ne pense pas que l\u0026rsquo;on puisse radicalement améliorer l\u0026rsquo;idée.\nIl y a surement quelques petites améliorations à faire à la marge, mais je ne pense pas que l\u0026rsquo;on puisse faire de grosses grosses avancées : un SPF-aware greylisting résout le problème du greylisting chez les Big Mailer Corps, ni plus, ni moins. Aujourd\u0026rsquo;hui avec ce filtre, je ne vois aucune différence de traitement entre Gmail et le petit domaine du coin. Les deux passent le greylisting assez rapidement et sans que l\u0026rsquo;on ne se rende vraiment compte qu\u0026rsquo;il y a eu retransmission.\nEn gardant en tête que le spam est une industrie du volume, je pense que du travail plus intéressant peut être fait en augmentant le coût de l\u0026rsquo;envoi de masse : de la même manière que les spammeurs n\u0026rsquo;aiment pas la retransmission, ils n\u0026rsquo;aiment PAS DU TOUT les hôtes lents parce qu\u0026rsquo;ils ont un impact ÉNORME sur la capacité à distribuer et sur la taille de la queue. J\u0026rsquo;ai déjà implémenté des fonctionnalités dans ce sens au sein d\u0026rsquo;autres filtres en corrélant les temps de réponse à la réputation d\u0026rsquo;un domaine.\nSi je passe plus de temps à essayer de faire d\u0026rsquo;OpenSMTPD une cible difficile pour les spammeurs, il est certain que mes prochains travaux seront dans la lignée des sanctions par délais.\n","date":"26 Janvier 2019","permalink":"/fr/posts/2019-12-26/spf-aware-greylisting-et-filter-greylist/","section":"Posts","summary":"TL;DR: le greylisting est une bonne idée ce n\u0026rsquo;est pas très pratique aujourd\u0026rsquo;hui beaucoup de gens se passent du greylisting ou trouvent des contournements le SPF-aware greylisting rend le greylisting utilisable à nouveau Shout out a mes sponsors ❤️ # Un GRAND MERCI à mes sponsors sur github et patreon: votre soutien est grandement apprécié !","title":"SPF-aware greylisting et filter-greylist"},{"content":" TL;DR: Pas de résumé, j\u0026rsquo;ai passé des heures à traduire, vous allez passer des minutes à lire ;) OK… J\u0026rsquo;ai expliqué avec BIEN TROP DE DÉTAILS comment mettre en place un serveur de mail Merci à mes sponsors ! # Un énorme merci aux gens qui me sponsorisent sur patreon ou github.\nOù est-ce que j\u0026rsquo;ai déjà lu ça ? # En Août, j\u0026rsquo;ai publié un petit article intitulé \u0026ldquo; You should not run your mail server because mail is hard\u0026rdquo; (\u0026ldquo;Vous ne devriez pas héberger votre serveur de mail parce que c\u0026rsquo;est dur\u0026rdquo;) qui était, en gros, mon opinion sur les différentes raisons qui poussent les gens à décourager l\u0026rsquo;hébergement de mails. De manière très inattendue, l\u0026rsquo;article est devenu assez populaire, atteignant 100K lectures et continuant à recevoir des visites et des commentaires plusieurs mois après sa publication.\nEn Septembre, j\u0026rsquo;ai publié un autre article beaucoup plus long intitulé \u0026ldquo; Setting up a mail server with OpenSMTPD, Dovecot and Rspamd\u0026rdquo; (\u0026ldquo;Installer un serveur de mail avec OpenSMTPD, Dovecot et Rspamd\u0026rdquo;) qui décrivait pas à pas, de façon très détaillée, les étapes pour installer un serveur de mail complet jusqu\u0026rsquo;à la livraison des e-mails en boîte de réception chez un gros hébergeur de mail américain. L\u0026rsquo;article est devenu lui aussi plutôt populaire, sans pour autant atteindre le niveau du précedent article moins technique et spécifique, mais atteignant 40K lectures et continuant également à recevoir des visites et des commentaires plusieurs mois après la publication. Le contenu que vous vous apprêtez à lire est la traduction de cet article technique.\nC\u0026rsquo;est mon second article rédigé en français depuis des années, je vous demande donc un peu d\u0026rsquo;indulgence : si vous trouvez des fautes, vous pouvez me les remonter pour que je les corrige, ou faire une pull request pour les techies.\nCet article est DENSE parce que je vais vous tenir la main à un niveau frisant l\u0026rsquo;absurdité en expliquant chacune de mes actions et le pourquoi du comment. D\u0026rsquo;un point de vue purement technique, sans explications, l\u0026rsquo;article pourrait probablement tenir en quelques paragraphes.\nN\u0026rsquo;hésitez pas à partager la publication à l\u0026rsquo;aide des icones en fin d\u0026rsquo;article et à la commenter \u0026lt;3\nAh, et tant que je vous ai sous la main, je vous recommande chaudement la lecture de mon article non technique \u0026ldquo;Décentralisons SMTP pour le bien commun\u0026rdquo; qui aborde certaines des raisons pour lesquelles il nous faut davantage de serveurs de mail.\nBonne lecture !\nCet article est pour les techies et les sysadmins # L\u0026rsquo;auto-hébergement requiert un minimum de connaissances et de motivation. Ce n\u0026rsquo;est pas un truc qui se fait en deux clics, il vous faut des connaissances minimales et avoir l\u0026rsquo;envie d\u0026rsquo;y dédier un peu de votre temps. Si vous n\u0026rsquo;avez jamais touché une zone DNS ou si vous pensez que prendre une heure pour configurer quelque chose est une tâche difficile, alors autant vous prévenir de suite : ça ne va pas être simple. Je ne vous recommande pas vous lancer dans l\u0026rsquo;aventure sauf si vous VOULEZ avoir à apprendre une tonne de trucs.\nSi vous êtes un sysadmin familier avec le travail de sysadmin, alors la plupart de votre travail de sysadmin est déjà considérablement plus dur que mettre en place une instractructure mail. Pour vous, le mail ne sera pas quelque chose de difficile.\nEHLO hypno.cat # Pour cet article, nous mettrons en place un serveur de mail pour hypno.cat, un petit site web pour mon (hypothétique) activité prospère d\u0026rsquo;hypnopraticien. J\u0026rsquo;ai enregistré ce domaine il y a plusieurs années parce que j\u0026rsquo;aimais bien le nom mais il n\u0026rsquo;a jamais été utilisé pour quoi que ce soit d\u0026rsquo;autre que l\u0026rsquo;hébergement d\u0026rsquo;un merveilleux fichier animé.\nGoogle, Bing et Yahoo le connaissent ; on ne sait pas trop comment (je vais du moins faire semblant de ne pas savoir) et ont indexé la page d\u0026rsquo;accueil, du coup ils ne considèrent pas que ce domaine vient d\u0026rsquo;être acheté par un spammer pour immédiatement envoyer du mail, mais il reste virtuellement inconnu sur internet parce qu\u0026rsquo;il n\u0026rsquo;a aucun contenu, ne fais aucun lien, n\u0026rsquo;est linké depuis nul part, et n\u0026rsquo;a jamais émis ou reçu de mail depuis ou vers personne. C\u0026rsquo;est un détail plutôt important qui montre que l\u0026rsquo;âge d\u0026rsquo;un domaine à un impact sur la réputation, mais ça reste un critère parmi d\u0026rsquo;autres, on reparlera réputation dans un futur article.\nJe vais le mettre en place au fur et à mesure que j\u0026rsquo;écris cet article, depuis le moment où j\u0026rsquo;ai démarré un nouveau VPS jusqu\u0026rsquo;au moment où j\u0026rsquo;ai pu échanger un mail dans les deux sens avec mon compte Gmail. J\u0026rsquo;ai choisi Gmail parce qu\u0026rsquo;il est sur-représenté dans la population et qu\u0026rsquo;un nombre important de personnes se sont plains de problèmes de distribution là-bas. Très personnellement, je pense que Outlook est bien pire en terme d\u0026rsquo;interopérabilité, mais gardons ça pour un futur article peut-être.\nLes services de mail pour hypno.cat vont fournir du mail entrant et sortant sécurisés par TLS. Ils vont permettre de soumettre des messages depuis l\u0026rsquo;application Gmail de mon smartphone pour ne pas changer les habitudes de mes utilisateurs. Je pourrais tout aussi bien fournir un webmail, avec Rainloop ou Roundcube, ou installer un client lourd comme Thunderbird ou mutt. N\u0026rsquo;importe quel client fonctionnera ; donc je ne vais pas couvrir cette partie. Il y a de nombreuses alternatives et plusieurs articles existants sur internet pour couvrir leur mise en place. Il y a même des techniques pour assister les clients à automatiquement découvrir leur configuration, mais tout ça reste hors du périmètre de mon article, je ne me fais pas de soucis vous allez trouver tout seul.\nMon mail sortant passera les vérifications basiques de Gmail, plus précisément SPF, DKIM et DMARC, qui sont plus que suffisant pour laisser le mail arriver en inbox. Il est possible de faire beaucoup plus, mais le but de cet article est de trouver le bon équilibre entre faire assez de travail pour avoir bonne allure face aux autres serveurs et rester simple.\nLe mail entrant sera filtré pour réduire la quantité de spam, soit en tuant les connexions de mauvais émetteurs évidents dès qu\u0026rsquo;ils sont détectés, soit en proposant une classification du Spam dans un répertoire dédié pour éviter de saturer la boite de réception.\nJe pourrais m\u0026rsquo;arrêter là parce que c\u0026rsquo;est déjà un setup assez intéressant, mais je vais rajouter un peu de configuration pour apprendre à Dovecot à entrainer le filtre antispam. Il apprendra à reconnaitre le Spam lorsque je déplacerai un message dans le répertoire Spam, et à reconnaitre le mail légitime lorsque je déplacerai un message hors du répertoire Spam. Cette partie est un peu plus complexe parce qu\u0026rsquo;elle dépend de Sieve qui est loin d\u0026rsquo;être un bijou d\u0026rsquo;ingénierie. Si vous vous moquez de l\u0026rsquo;apprentissage, vous pouvez sauter cette partie ; j\u0026rsquo;ai fait sans pendant plus de dix ans. C\u0026rsquo;est un truc sympa à avoir mais loin d\u0026rsquo;être une obligation ; c\u0026rsquo;est juste mon petit cadeau bonus dans cet article.\nPré-requis # Le premier pré-requis est de savoir où vous allez faire tourner votre serveur de mail.\nAvec la propagation des connexions permanentes type ADSL ou FTTH (fibre), une connexion à domicile peut être tentante mais ce n\u0026rsquo;est pas une bonne idée parce que les espaces d\u0026rsquo;adressage IP des FAI sont souvent blacklistés, ou souffrent d\u0026rsquo;une très mauvaise réputation de départ. De plus, de nombreux FAI bloquent le trafic SMTP sortant pour éviter que les machines personelles compromises se transforment en bot à spam. Pour moi, la meilleure option est de louer un serveur dédié ou un VPS depuis une société d\u0026rsquo;hébergement après s\u0026rsquo;être assuré que le trafic SMTP sortant est autorisé là-bas.\nJ\u0026rsquo;ai loué mes serveurs dédiés chez online.net ces douze dernières années et je suis extrêmement satisfait. Vous trouverez même sur ce blog des instructions (en anglais) pour faire tourner OpenBSD sur leurs serveurs comme ce n\u0026rsquo;est pas supporté nativement. Ils ne filtrent pas SMTP, ce qui est bien parce que vous pouvez faire tourner un serveur de mail immédiatement, mais les adresses IP peuvent avoir été utilisées préalablement par de mauvais émetteurs et il vous faudra les tester. Si l\u0026rsquo;adresse IP qui vous est automatiquement allouée n\u0026rsquo;est pas bonne, soit il va falloir bucher pour gagner en réputation, soit il vous faudra en commander une additionelle en prenant bien le soin de la choisir dans un autre range, après avoir vérifié qu\u0026rsquo;elle n\u0026rsquo;est pas dans une blacklist, ou qu\u0026rsquo;elle ne souffre pas déjà d\u0026rsquo;une mauvaise réputation.\nAlternativement, pour les besoins d\u0026rsquo;une offre commerciale que je suis en train de monter, j\u0026rsquo;ai commencé à construire une infrastructure sur vultr.com (lien de parrainage). Je ne suis là bas que depuis quelques mois et je changerai peut-être d\u0026rsquo;avis, mais pour l\u0026rsquo;instant j\u0026rsquo;en suis très satisfait. Là-bas, SMTP est filtré par défaut et il faut ouvrir un ticket et expliquer quel est le projet pour le trafic mail. J\u0026rsquo;ai expliqué que je ne cherchais pas à devenir ESP et que je n\u0026rsquo;allais pas envoyer de mail commercial de masse mais plutôt gérer de l\u0026rsquo;hébergement ; ils ont été très serviables et m\u0026rsquo;ont retiré le filtrage le jour même.\nPeu importe où le serveur de mail sera hébergé, ce que vous devez vérifier c\u0026rsquo;est que :\nl\u0026rsquo;hébergeur n\u0026rsquo;a pas un passif avec l\u0026rsquo;hébergement de spammers et qu\u0026rsquo;il autorise SMTP vous avez une adresse IP dédiée au mail vous avez le contrôle du reverse DNS pour cette adresse IP votre adresse IP n\u0026rsquo;est pas déjà sur des blacklists Tant que ces pré-requis sont respectés, vous ne devriez pas avoir trop de problèmes.\nComme personne n\u0026rsquo;aime perdre de mails, il est aussi judicieux de se préparer aux incidents. On s\u0026rsquo;en protège en utilisant un serveur secondaire pour prendre le trafic lorsque le primaire est down, ou pour re-router le trafic lorsque le primaire est en incapacité de router correctement. Je ne vais pas couvrir ce sujet parce que ce n\u0026rsquo;est pas très complexe, il s\u0026rsquo;agit d\u0026rsquo;installer un second serveur qui route son trafic vers le premier et de faire le bon enregistrement DNS, après avoir lu cet article vous devriez vous en sortir seul.\nCEPENDANT, un grand nombre de personnes ont mentionnés s\u0026rsquo;être déjà fait blacklister et avoir perdu du mail, donc je pense que c\u0026rsquo;est le bon moment pour donner ce conseil : n\u0026rsquo;hébergez pas vos différents serveurs au même endroit. Vous ne voulez pas avoir tous vos serveurs au même endroit s\u0026rsquo;il y a une panne de courant ou de réseau, et vous voulez aussi éviter que si votre range IP est blacklisté en dommage collatéral d\u0026rsquo;un voisin malveillant, l\u0026rsquo;adresse IP de votre serveur secondaire est \u0026ldquo;suffisamment éloignée\u0026rdquo; pour ne pas être blacklistée aussi. De cette façon, si votre serveur primaire est en incapacité temporaire d\u0026rsquo;émettre à cause d\u0026rsquo;un blocage, vous pouvez re-router votre trafic au-travers de votre serveur secondaire le temps que le problème soit résolu.\nJ\u0026rsquo;ai personellement eu à gérer un seul blocage sur mon propre setup (bien plus en dehors) durant ces dix dernières années. C\u0026rsquo;est un peu chiant parce que les incidents tombent toujours au mauvais moment et que ce n\u0026rsquo;est jamais fun, mais j\u0026rsquo;ai re-routé le trafic au-travers d\u0026rsquo;un serveur secondaire pour le rétablir, rempli un formulaire de délistage en apportant la preuve que j\u0026rsquo;étais un émetteur légitime, puis re-routé le trafic par mon serveur primaire une fois le problème résolu. On est très loin du problème insurmontable qu\u0026rsquo;en font un certain nombre de personnes.\nPas de stress pour ceux qui ont un plan pour les pannes avant qu\u0026rsquo;elles ne surviennent.\nLa stack technique # Je vais démarrer un nouveau VPS chez vultr.com (toujours un lien de parrainage), installer la dernière version d\u0026rsquo; OpenBSD ( snapshot) parce que c\u0026rsquo;est mon système de préférence (installation non couverte dans cet article), et construire mon système de mail par dessus. Je vais partir du principe que nous sommes sous OpenBSD tout le reste de cet article, mais à l\u0026rsquo;exception de certaines commandes spécifiques pour installer des packages, la configuration est très similaire d\u0026rsquo;un système à un autre. Si vous êtes assez grands pour faire tourner un serveur de mail, vous êtes assez grands pour adapter des chemins, remplacer doas par sudo, et sinon… installez OpenBSD !\nPour la couche SMTP, qui est en charge de transférer des messages entre deux hôtes indépendemment de la manière dont les utilisateurs vont y accéder, j\u0026rsquo;utiliserais le logiciel OpenSMTPD. Il s\u0026rsquo;agit du serveur SMTP par défaut pour le système d\u0026rsquo;exploitation OpenBSD et il y a une version portable disponible sur Github avec des instructions pour le construire. Il est également disponible dans les dépôts de packages de différents systèmes et distributions Linux, peut-être tout juste à un pkg, un rpm ou un apt de vous.\nLes instructions de cet article sont pour la version 6.6.0 ou ultérieure, elles ne fonctionneront pas sur des versions précédentes. Si votre système ne fournit pas de package à jour, vous pouvez tenter de demander au mainteneur de le mettre à jour ou alors tenter d\u0026rsquo;en devenir mainteneur. Il vous faudra construire le package manuellement à partir du dernier tag contenant un p, pour portable, dans son nom sur Github.\nPour la couche IMAP, qui permet aux utilisateurs de récupérer les messages qu\u0026rsquo;ils ont reçus et y accéder depuis leurs smartphones ou webmail, j\u0026rsquo;utiliserais la dernière version de Dovecot. J\u0026rsquo;utiliserai également le package Dovecot-Pigeonhole, qui permettera d\u0026rsquo;entraîner notre solution antispam en lui faisant apprendre ce qui est du Spam et ce qui est du Ham. Si vous souhaitez utiliser un client console, en ssh, comme mutt par exemple, pas besoin de cette couche car OpenSMTPD peut distribuer dans une boite mail locale à laquelle les clients mail peuvent accéder en direct. Dans cet article, nous configurerons IMAP parce que nous voulons que les mails puissent être consultés depuis un smartphone comme une personne lambda.\nEnfin, pour la couche de filtrage du spam, j\u0026rsquo;utiliserai l\u0026rsquo;excellent Rspamd qui est bien plus qu\u0026rsquo;une simple solution antispam. Il fournit des méthodes de filtrage moderne, mais permet également l\u0026rsquo;intégration de filtrage antivirus, de signature DKIM, et d\u0026rsquo;une tonne de modules que vous pouvez choisir d\u0026rsquo;activer ou non pour régler plus finement votre setup. Dans cet article, nous utiliserons tout simplement ses capacités de filtrage du Spam et de signature DKIM, le strict minimum dont nous avons besoin.\nMe rendre accessible # SMTP est très étroitement lié avec DNS et les autres hôtes dépendent de recherches DNS pour trouver quelle machine gère le mail de votre domaine. C\u0026rsquo;est fait au-travers de la recherche d\u0026rsquo;enregistrements MX (Mail eXchanger), donc le minimum à faire pour que SMTP fonctionne est de déclarer un enregistrement MX pour votre domaine. Pour hypno.cat, la zone contiendra ce qui suit :\n;; un enregistrement A (et AAAA pour IPv6) est déclaré pour nommer le serveur de mail mail.hypno.cat A 217.69.8.253 mail.hypno.cat AAAA 2001:19f0:6801:867:5400:01ff:fee7:7af7 ;; un enregistrement MX est déclaré pour dire au monde que mail.hypno.cat gère le ;; mail pour hypno.cat ;; 0 est la préférence maximale, si nous avions un serveur secondaire il aurait un ;; nombre supérieur hypno.cat. MX 0 mail.hypno.cat. ;;hypno.cat. MX 10 mail-backup.hypno.cat. Je peux m\u0026rsquo;assurer que tout est correct en utilisant host et dig pour vérifier que le nom résoud et que la recherche MX retourne bien le bon nom :\n$ host mail.hypno.cat mail.hypno.cat has address 217.69.8.253 mail.hypno.cat has IPv6 address 2001:19f0:6801:867:5400:1ff:fee7:7af7 $ dig -t MX hypno.cat +short 0 mail.hypno.cat. À ce stade et avec ces enregistrements DNS, les autres serveurs de mail peuvent déjà trouver quel serveur est responsable pour hypno.cat, et le contacter quand ils veulent envoyer du mail à n\u0026rsquo;importe quelle adresse mail de ce domaine.\nMe faire bien voir # Être joignable n\u0026rsquo;est pas suffisant parce qu\u0026rsquo;aujourd\u0026rsquo;hui, vous DEVEZ avoir un reverse DNS (rDNS) ET un Forward-Confirmed rDNS (FCrDNS).\nIl y a une raison derrière cela. Un grand nombre d\u0026rsquo;hôtes qui émettent du spam sont des machines compromises, avec une grande portion d\u0026rsquo;entre elles qui sont des ordinateurs personnels derrière des connexions résidentielles. Beaucoup de ces connexions n\u0026rsquo;ont pas de rDNS ou de FCrDNS, ou ont des rDNS qui ressemblent à des patterns d\u0026rsquo;IP allouées dynamiquement (ex. : 123.123.123.123.dyn.adsl.example.com).\nComme il s\u0026rsquo;agit de machines compromises individuellement, et non de machines dont la configuration est sous le contrôle total des spammers, les rDNS et FCrDNS ne peuvent pas être configurés… il en résulte que la configuration de rDNS et FCrDNS est devenu une preuve de travail : il faut un rDNS et un FCrDNS correctement configuré et ne ressemblant pas à une allocation dynamique. Chez certains Big Mailer Corps, il s\u0026rsquo;agit de règles claires, décrites dans les guidelines, pour d\u0026rsquo;autres on le découvre par la sanction. Dans tous les cas, il s\u0026rsquo;agit du STRICT MINIMUM ; assurez-vous que vos noms d\u0026rsquo;hôtes ressemblent à un VRAI nom de serveur de mail (ex. : mail.hypno.cat, et non pas www.hypno.cat).\nLe rDNS est généralement hors de votre contrôle parce que dans une zone un peu spéciale, arpa, gérée par le propriétaire de l\u0026rsquo;adresse IP (en général votre hébergeur). Les FAI ne vous laissent pas toujours les configurer ; mais les hébergeurs de serveurs n\u0026rsquo;ayant pas vraiment d\u0026rsquo;autres choix, fournissent généralement un formulaire quelque part sur leurs espaces clients pour assigner un rDNS aux adresses qu\u0026rsquo;ils vous ont assignées :\nSi je configure mon rDNS pour avoir la même valeur que l\u0026rsquo;enregistrement DNS configuré plus haut, alors je passe automatiquement le test du FCrDNS. On peut le vérifier très simplement en faisant une recherche rDNS pour l\u0026rsquo;adresse IP :\n$ host 217.69.8.253 253.8.69.217.in-addr.arpa domain name pointer mail.hypno.cat. $ host 2001:19f0:6801:867:5400:1ff:fee7:7af7 7.f.a.7.7.e.e.f.f.f.1.0.0.0.4.5.7.6.8.0.1.0.8.6.0.f.9.1.1.0.0.2.ip6.arpa domain name pointer mail.hypno.cat. Puis cherchez l\u0026rsquo;adresse IP pour ce rDNS :\n$ host mail.hypno.cat mail.hypno.cat has address 217.69.8.253 mail.hypno.cat has IPv6 address 2001:19f0:6801:867:5400:1ff:fee7:7af7 Si les valeurs se retrouvent dans les deux sens, tout est d\u0026rsquo;équerre.\nAnnoncer quelles machines sont autorisées à émettre pour mon domaine # SPF est un mécanisme qui permet pour un domaine destination de déterminer si la machine qui émet était autorisée pour le domaine émetteur.\nLe mécanisme est très simple, on ajoute un enregistrement DNS à la zone de notre domaine qui déclare quels serveurs peuvent émettre. Quand le domaine destination reçoit un mail avec un émetteur de notre domaine, il vérifie si l\u0026rsquo;adresse IP du serveur émetteur en avait le droit.\nSPF n\u0026rsquo;est pas obligatoire pour SMTP mais c\u0026rsquo;est une des choses qui nous font paraître légitimes face aux destinataires. SPF est informatif par défaut ; ne pas passer un test SPF ou ne pas avoir d\u0026rsquo;enregistrement SPF n\u0026rsquo;implique pas qu\u0026rsquo;un mail termine en Spam ou soit détruit. Il est communément accepté que l\u0026rsquo;absence d\u0026rsquo;un enregistrement SPF a un impact très négatif sur la réputation d\u0026rsquo;un domaine, c\u0026rsquo;est même explicitement dit dans les guidelines de certains Big Mailer Corps, et vu comme l\u0026rsquo;enregistrement est simple à fournir… il n\u0026rsquo;y a vraiment aucune excuse pour ne pas le faire.\nIl y a plusieurs façons de configurer SPF ; dans cet example, je vais simplement le configurer pour n\u0026rsquo;autoriser QUE mon serveur de mail à envoyer du mail en mon nom :\nhypno.cat. IN TXT \u0026#34;v=spf1 mx -all\u0026#34; Si des hôtes reçoivent un mail avec un émetteur @hypno.cat qui ne provient pas de mail.hypno.cat, ils pourront prendre la décision (ou non) de rejeter le mail. Ils pourront en tout cas constater qu\u0026rsquo;il provient d\u0026rsquo;une machine qui n\u0026rsquo;était pas autorisée et qu\u0026rsquo;ils ont le droit de le rejeter.\nProuver que j\u0026rsquo;ai autorisé le message lui même. # DKIM est un mécanisme d\u0026rsquo;authentification par lequel on peut signer cryptographiquement les mails émis par notre serveur, prouvant qu\u0026rsquo;on les a vu passer et que l\u0026rsquo;on a pris la responsabilité de les laisser transiter. Les hôtes qui recoivent ces mails peuvent vérifier qu\u0026rsquo;ils étaient bien autorisés en vérifiant la signature, permettant ainsi de détecter des mails forgés hors du système de mail.\nComme SPF, c\u0026rsquo;est informatif par défaut et l\u0026rsquo;absence de signature DKIM ou une signature invalide ne veut pas dire qu\u0026rsquo;un mail ne sera pas distribué. En revanche, il est là aussi admis et décrit dans les guidelines que l\u0026rsquo;absence de DKIM aura un effet sur la réputation d\u0026rsquo;un domaine. Et comme configurer DKIM est facile, pas vraiment d\u0026rsquo;excuse pour ne pas le faire là non plus.\nC\u0026rsquo;est un petit peu plus complexe que pour SPF parce que, même si ça dépend aussi de DNS, il faut générer une paire de clés et publier la clé publique dans l\u0026rsquo;enregistrement DNS. Rien de bien foufou non plus.\nNous sommes en 2019. Je vais générer une clé RSA de 1024 bits ; je sais !\n\u0026mdash; BEGIN DIGRESSION \u0026mdash;\nLes clés RSA 2048 bits ne rentrent pas dans un enregistrement DNS TXT et doivent être tronquées en deux enregistrements, mais tout le monde n\u0026rsquo;est pas capable de réassocier ces clés tronquées, et vous pouvez perdre les bénéfices de DKIM si l\u0026rsquo;hôte destination n\u0026rsquo;arrive pas à utiliser votre clé publique partielle et considère la signature invalide.\nEn ce qui me concerne, ces hôtes sont responsables et nous pouvons les ignorer ; mais comme le but de cet article est de permettre une interopérabilité maximale et que DKIM n\u0026rsquo;est pas présent ici pour sécuriser quoi que ce soit, juste pour vous faire paraître légitime, on va juste regarder ailleurs en justifiant cette mauvaise pratique par le risque modéré de falsification de contenu quand il est utilisé conjointement à SPF.\nCe n\u0026rsquo;est pas une bonne manière de raisonner mais DKIM a d\u0026rsquo;autres inconvénients et comme virtuellement tout le monde utilise du RSA 1024-bits. Je suggère de laisser le débat 1024 vs \u0026gt;= 2048 à plus tard, lors que nous aurons déjà réussis à échanger correctement avec les Big Mailer Corps. Je prendrais juste le temps, sans pointer de doigt nul part, d\u0026rsquo;appuyer sur le fait que certaines sociétés dans la sécurité qui travaillent dans l\u0026rsquo;industrie du mail ont (avaient ?) encore des problèmes avec les clés 2048-bits en 2019. Des sociétés qui calculent des scores de réputation. Oh, la, belle, ironie !\nSi c\u0026rsquo;est un sujet d\u0026rsquo;inquiétude pour vous, vous pouvez expérimenter la troncature des clé et voir si ça vous convient. Adapter mon exemple est trivial ; assurez vous juste d\u0026rsquo;avoir la clé tronquée sur deux enregistrements TXT.\n\u0026mdash; END DIGRESSION \u0026mdash;\nJe crée un répertoire pour contenir les clés :\n# mkdir /etc/mail/dkim Ensuite, la commande suivante va générer une paire de clé et extraire la clé publique de la clé privée:\n# openssl genrsa -out /etc/mail/dkim/hypno.cat.key 1024 Generating RSA private key, 1024 bit long modulus …………………………++++++ ……………++++++ e is 65537 (0x10001) # openssl rsa -in /etc/mail/dkim/hypno.cat.key -pubout -out /etc/mail/dkim/hypno.cat.pub writing RSA key # cat /etc/mail/dkim/hypno.cat.pub -----BEGIN PUBLIC KEY----- MIGfMA0GCSqGSIb3DQEBAQUAA4GNADCBiQKBgQDThHqiM610nwN1nmV8OMc7PaPO uJWVGRDz5bWj4cRjTTmQYjJQd02xrydRNrRhjEKBm2mMDArNWjoM3jvN04ZifqJx DmKr7X8jsYi+MPEHz6wZxB8mayDK6glYTCyx//zl1luUdvm26PutA38K8cgnb7iT kfVP2OqK6sHAdXjnowIDAQAB -----END PUBLIC KEY----- Enfin, je génére un enregistrement DNS TXT en retirant le blindage de la clé publique et en formattant le contenu pour qu\u0026rsquo;il soit comme suit :\n20190913._domainkey.hypno.cat.\tIN TXT \u0026#34;v=DKIM1;k=rsa;p=MIGfMA0GCSqGSIb3DQEBAQUAA4GNADCBiQKBgQDThHqiM610nwN1nmV8OMc7PaPOuJWVGRDz5bWj4cRjTTmQYjJQd02xrydRNrRhjEKBm2mMDArNWjoM3jvN04ZifqJxDmKr7X8jsYi+MPEHz6wZxB8mayDK6glYTCyx//zl1luUdvm26PutA38K8cgnb7iTkfVP2OqK6sHAdXjnowIDAQAB;\u0026#34; Le nom de l\u0026rsquo;enregistrement est construit selon le motif : \u0026lt;selector\u0026gt;._domainkey.\u0026lt;domain\u0026gt;., où \u0026lt;selector\u0026gt; est un nom arbitraire choisi pour permettre à plusieurs clés de co-exister. J\u0026rsquo;aime bien utiliser la date à laquelle j\u0026rsquo;ai généré la paire de clés, mais peu importe ce que vous choisissez, écrivez le pour plus tard car nous en aurons besoin pour configurer la signature DKIM.\nDe plus, la clé publique n\u0026rsquo;a pas besoin de rester dans le répertoire une fois qu\u0026rsquo;elle est publiée dans l\u0026rsquo;enregistrement DNS. Elle peut toujours être dérivée de la clé privée si nous en avons besoin, mais personnellement j\u0026rsquo;aime bien la garder pour la retrouver rapidement.\nFaites bien attention à ce que la clé privée ne soit pas en lecture pour tous car, pour une raison inconnue et pas très maline, OpenSSL pense que les clés privées doivent être créées en rw-r--r--.\nDire aux autres quoi faire en cas d\u0026rsquo;erreurs SPF et DKIM avec DMARC # SPF et DKIM sont tous les deux très intéressants, mais ils ne sont qu\u0026rsquo;informatifs, alors ils n\u0026rsquo;empêchent pas d\u0026rsquo;abuser de votre nom de domaine.\nDMARC permet de dire aux serveurs mails de destination ce que vous voulez qu\u0026rsquo;ils fassent des mails en apparence de votre domaine qui ratent les tests SPF et DKIM. Il permet par exemple de leur dire qu\u0026rsquo;ils doivent rejeter ces mails.\nIl n\u0026rsquo;y a pas d\u0026rsquo;indicateur clair : fournir une politique de rejet nous fait mieux voir que de fournir une politique sans action. Des expérimentations semblent montrer qu\u0026rsquo;avoir un enregistrement a un impact positif par rapport à n\u0026rsquo;en avoir aucun, même si l\u0026rsquo;enregistrement dit que rien ne doit être fait avec les erreurs SPF et DKIM. Il serait intéressant de mener une nouvelle expérimentation à ce sujet, mais en même temps, il est plus simple de fournir une politique de rejet et de ne pas avoir à se poser la question :-)\nLe format d\u0026rsquo;un enregistrement DMARC va bien au-delà de cet article et vous trouverez de nombreux exemples dans n\u0026rsquo;importe quel moteur de cherche. Un enregistrement simple annoncera une politique (p=) de none (reject si vous voulez rejeter, quarantine si vous avez besoin de temps pour décider). Le champ pourcentage (pct=) déclare combien de ces mails devraient être sujets à la politique DMARC, et le champ Reporting URI of Aggregates (rua=) est la destination des rapports DMARC (pour analyse avant de basculer de quarantine à reject par exemple).\nJe vais ici créer un enregistrement simple, un enregistrement qui fera que les Big Mailer Corps voient que nous nous intéressons à DMARC même si nous ne savons pas encore quoi en faire :\n_dmarc.hypno.cat. IN TXT \u0026#34;v=DMARC1;p=none;pct=100;rua=mailto:postmaster@hypno.cat;\u0026#34; Mon opinion est qu\u0026rsquo;il est préférable de basculer rapidement vers p=reject, après s\u0026rsquo;être assuré que les mails sont correctement signés et que seul notre serveur de mail les émet.\nObtenir un certificat pour TLS # Il y a plusieurs façons d\u0026rsquo;obtenir un certificat TLS. Je vais partir du principe que vous êtes familiers avec l\u0026rsquo;hébergement d\u0026rsquo;autres services et que vous êtes capable d\u0026rsquo;en obtenir un par votre registrar ou depuis letsencrypt. Si ce n\u0026rsquo;est pas le cas, vous trouverez des exemples à foison sur n\u0026rsquo;importe quel moteur de recherche.\nSi vous savez gérer vos certificats, vous pouvez sauter à la section suivante.\nComme je suis réellement en train de mettre en place mail.hypno.cat, je ne serais pas en mesure de continuer cet article sans obtenir de certificat, donc en bonus pour les utilisateurs d\u0026rsquo;OpenBSD, je vais documenter la génération de mon certificat sur ma nouvelle installation.\nacme-client est un utilitaire présent dans le système de base et qui permet de demander ou renouveller des certificats depuis la console. Il dépend d\u0026rsquo;un challenge HTTP ; il doit donc être en mesure d\u0026rsquo;écrire dans un répertoire qui soit accessible par HTTP. Et comme nous sommes chanceux… OpenBSD contient un serveur httpd que l\u0026rsquo;on peut utiliser pour ce challenge. Et comme nous sommmes TRÈS chanceux… OpenBSD fournit aussi un exemple de fichier de configuration que l\u0026rsquo;on peut utiliser sans gros changement.\nOn copie simplement le fichier d\u0026rsquo;example depuis /etc/example/httpd.conf vers /etc/httpd.conf, en remplaçant example.com par mail.hypno.cat et en supprimant le bloc TLS puisque seul le challenge nous interesse. Le fichier doit ressembler à cela :\nserver \u0026#34;mail.hypno.cat\u0026#34; { listen on * port 80 location \u0026#34;/.well-known/acme-challenge/*\u0026#34; { root \u0026#34;/acme\u0026#34; request strip 2 } location * { block return 302 \u0026#34;https://$HTTP_HOST$REQUEST_URI\u0026#34; } } Le daemon httpd peut être démarré comme suit :\n# rcctl -f start httpd httpd(ok) En ce qui concerne acme-client, c\u0026rsquo;est très simple, on copie à nouveau le fichier d\u0026rsquo;exemple depuis /etc/example/acme-client.conf vers /etc/acme-client.conf, en remplaçant example.com par mail.hypno.cat et on doit se retrouver avec un bloc comme suit :\ndomain mail.hypno.cat { domain key \u0026#34;/etc/ssl/private/mail.hypno.cat.key\u0026#34; domain full chain certificate \u0026#34;/etc/ssl/mail.hypno.cat.fullchain.pem\u0026#34; sign with letsencrypt } À ce stade, on se contente de lancer acme-client pour notre domaine :\n# acme-client -v mail.hypno.cat […] acme-client: /etc/ssl/mail.hypno.cat.fullchain.pem: created Le certificat et les clés sont créés au bon endroit, il suffira par la suite d\u0026rsquo;ajouter les chemins dans OpenSMTPD et Dovecot.\nVous pouvez garder httpd en marche pour les renouvellements et appeller acme-client depuis un cron, vous pouvez l\u0026rsquo;éteindre et renouveller d\u0026rsquo;une autre façon. Je vous laisse vous débrouiller ; vous trouverez comment faire avec l\u0026rsquo;aide de la page de manuel acme-client(1).\nInstaller et configurer Rspamd # Sur OpenBSD, Rspamd est packagé et peut être installé d\u0026rsquo;une simple commande. Nous avons aussi besoin d\u0026rsquo;installer Redis qui sert à stocker des statistiques pour Rspamd et son greylisting (entre autres), et également filter-rspamd qui est un petit bout de code qui permets à OpenSMTPD de travailler avec Rspamd. Ils existent également sous forme de packages et peuvent être installés en une seule commande.\nTout d\u0026rsquo;abord, on installe les packages :\nmail$ doas pkg_add redis rspamd opensmtpd-filter-rspamd […] redis-4.0.14: ok rspamd-1.9.0: ok opensmtpd-filter-rspamd-0.1.1: ok The following new rcscripts were installed: /etc/rc.d/redis /etc/rc.d/rspamd See rcctl(8) for details. Rspamd est très configurable, si vous voulez faire des choses un peu funky je vous laisse lire la documentation. Pour cet article je me contenterai d\u0026rsquo;une utilisation très basique, comme c\u0026rsquo;est le cas sur mes propres machines :\nJe pourrais éditer la configuration dans /etc/rspamd/actions.conf pour ajuster les seuils de mise en spam, mais les valeurs par défaut me conviennent alors je vous les montre juste :\nactions { reject = 15; # Reject when reaching this score add_header = 6; # Add header when reaching this score greylist = 4; # Apply greylisting when reaching this score (will emit `soft reject action`) […] Mais ce que je veux vraiment c\u0026rsquo;est que Rspamd gère la signature DKIM parce que c\u0026rsquo;est un des pré-requis pour paraître légitime.\nOn le fait en fournissant une configuration dans /etc/rspamd/local.d/dkim_signing.conf pour faire correspondre à notre domaine la clé DKIM générée plus tôt :\n# mkdir /etc/rspamd/local.d # cat \u0026lt;\u0026lt; EOF \u0026gt;/etc/rspamd/local.d/dkim_signing.conf allow_username_mismatch = true; domain { hypno.cat { path = \u0026#34;/etc/mail/dkim/hypno.cat.key\u0026#34;; selector = \u0026#34;20190913\u0026#34;; } } EOF La clé de configuration allow_username_mismatch est nécessaire parce que Rspamd attend des utilisateurs avec des noms de domaines, mais dans cette configuration OpenSMTPD authentifie de simples utilisateurs système. De plus, faites attention à ce que le fichier contenant la clé DKIM soit autorisé en lecture au groupe _rspamd.\nÀ ce stade on est bon, Rspamd et Redis peuvent être activés pour qu\u0026rsquo;OpenBSD les démarre à chaque reboot :\n# rcctl enable redis # rcctl enable rspamd Et on peut les démarrer immédiatement pour ne pas avoir à attendre le prochain reboot :\n# rcctl start redis redis(ok) # rcctl start rspamd rspamd(ok) Configurer OpenSMTPD # OpenSMTPD est installé par défaut sur OpenBSD donc aucune phase d\u0026rsquo;installation ici. Si vous utilisez un système d\u0026rsquo;exploitation différent, soit quelqu\u0026rsquo;un l\u0026rsquo;a packagé et vous pouvez l\u0026rsquo;installer avec votre gestionnaire de paquets, ou vous pouvez le construire depuis les sources et l\u0026rsquo;installer en utilisant le code depuis le mirroir Github et en suivant les instructions de build.\nComme écrit plus haut, ces instructions ne sont valides que pour la version 6.6.0 et ultérieures, les versions précédentes ne supportent pas les filtres et certaines des fonctionnalités décrites ici.\nLa configuration par défault d\u0026rsquo;OpenSMTPD est adaptée à un serveur de mail local, n\u0026rsquo;acceptant pas de connexions de l\u0026rsquo;extérieur, mais capable de laisser les utilisateurs locaux s\u0026rsquo;échanger des messages et en émettre vers des hôtes distants.\nElle ressemble à ce qui suit :\n# $OpenBSD: smtpd.conf,v 1.11 2018/06/04 21:10:58 jmc Exp $ # This is the smtpd server system-wide configuration file. # See smtpd.conf(5) for more information. table aliases file:/etc/mail/aliases # To accept external mail, replace with: listen on all # listen on lo0 action \u0026#34;local_mail\u0026#34; mbox alias \u0026lt;aliases\u0026gt; action \u0026#34;outbound\u0026#34; relay # Uncomment the following to accept external mail for domain \u0026#34;example.org\u0026#34; # # match from any for domain \u0026#34;example.org\u0026#34; action \u0026#34;local_mail\u0026#34; match from local for local action \u0026#34;local_mail\u0026#34; match from local for any action \u0026#34;outbound\u0026#34; Je voulais initialement mettre à jour la configuration progressivement pour vous tenir par la main, mais cet article à énormément grossi depuis sa première version. Par souci de simplicité, je vais simplement mettre les 16 lignes de configuration et les commenter ensuite :\npki mail.hypno.cat cert \u0026#34;/etc/ssl/mail.hypno.cat.fullchain.pem\u0026#34; pki mail.hypno.cat key \u0026#34;/etc/ssl/private/mail.hypno.cat.key\u0026#34; filter check_dyndns phase connect match rdns regex { \u0026#39;.*\\.dyn\\..*\u0026#39;, \u0026#39;.*\\.dsl\\..*\u0026#39; } \\ disconnect \u0026#34;550 no residential connections\u0026#34; filter check_rdns phase connect match !rdns \\ disconnect \u0026#34;550 no rDNS is so 80s\u0026#34; filter check_fcrdns phase connect match !fcrdns \\ disconnect \u0026#34;550 no FCrDNS is so 80s\u0026#34; filter senderscore \\ proc-exec \u0026#34;filter-senderscore -blockBelow 10 -junkBelow 70 -slowFactor 5000\u0026#34; filter rspamd proc-exec \u0026#34;filter-rspamd\u0026#34; table aliases file:/etc/mail/aliases listen on all tls pki mail.hypno.cat \\ filter { check_dyndns, check_rdns, check_fcrdns, senderscore, rspamd } listen on all port submission tls-require pki mail.hypno.cat auth filter rspamd action \u0026#34;local_mail\u0026#34; maildir junk alias \u0026lt;aliases\u0026gt; action \u0026#34;outbound\u0026#34; relay helo mail.hypno.cat match from any for domain \u0026#34;hypno.cat\u0026#34; action \u0026#34;local_mail\u0026#34; match from local for local action \u0026#34;local_mail\u0026#34; match from any auth for any action \u0026#34;outbound\u0026#34; match from local for any action \u0026#34;outbound\u0026#34; C\u0026rsquo;est tout ce dont nous avons besoin pour notre configuration SMTP complète.\nLes deux premières lignes pki déclarent que mail.hypno.cat utilisera le certificat et la clé que nous avons générés plus tôt pour TLS.\nLes lignes filter appliquent un ensemble de filtres sur les connexions entrantes. check_dyndns filtrera si rDNS corresponds à certains motifs. check_rdns filtrera s\u0026rsquo;il n\u0026rsquo;y a pas de rDNS. check_fcrdns filtrera si la correspondance FCrDNS échoue. Il s\u0026rsquo;agit de filtres \u0026ldquo;internes\u0026rdquo; à OpenSMTPD que vous pouvez ajuster pour filtrer différement, à d\u0026rsquo;autres phases ou avec d\u0026rsquo;autres critères.\nsenderscore est un filtre custom que vous pouvez installer soit depuis votre gestionnaire de paquets (pkg_add opensmtpd-filter-senderscore sur OpenBSD), ou obtenir depuis Github. Il n\u0026rsquo;est pas obligatoire mais je le trouve particulièrement utile et expliquerai pourquoi dans la prochaine section. Dans cette configuration, il rejettera un émetteur si son senderscore est en dessous de 10, il junk-era le message (ajoutera un entête X-Spam si le score est inférieur à 70), et pour mon plaisir personnel, ajoutera avant chaque réponse un délai inversement proportionnel à la réputation de l\u0026rsquo;émetteur pour ralentir les mauvais émetteurs.\nrspamd est également un filtre custom que nous avons installé dans la précedente section. Il n\u0026rsquo;y a aucune configuration car il est entièrement controlé depuis Rspamd, il suffit donc de le déclarer.\nSi vous voulez être plus conservateur et ne pas rejeter les mail pour éviter des faux positifs, vous pouvez assigner l\u0026rsquo;action junk plutôt que disconnect aux filtres internes et supprimer l\u0026rsquo;option -blockBelow au filtre senderscore :\nfilter check_dyndns phase connect match rdns regex { \u0026#39;.*\\.dyn\\..*\u0026#39;, \u0026#39;.*\\.dsl\\..*\u0026#39; } junk filter check_rdns phase connect match !rdns junk filter check_fcrdns phase connect match !fcrdns junk filter senderscore proc-exec \u0026#34;filter-senderscore -junkBelow 70 -slowFactor 5000\u0026#34; De cette façon, au lieu de rejeter les sessions, OpenSMTPD va simplement junk les messages pour les faire atterrir en boite à Spam. En regardant régulièrement ce qui atterri dans cette boite, vous pourrez gagner en confiance et adapter vos réglages pour trouver ceux qui vous conviennent.\nCes filtres simples, sans même compter rspamd, sont suffisants pour tuer la plus grosse partie du spam. Chez moi, ils permettent de passer de plusieurs centaines de spam quotidiens à une poignée. Le filtre rdns regex doit être adapté en fonction du pays, vous pouvez trouver des motifs qui sont récurrents chez vous et n\u0026rsquo;apparaissent jamais chez moi. Pour faciliter la maintenance, ils peuvent être stockés dans un fichier à raison d\u0026rsquo;un par ligne, en respectant la construction suivante :\ntable \u0026lt;dyndns\u0026gt; file:/etc/mail/path-to-my-regex-file filter check_dyndns phase connect match rdns regex \u0026lt;dyndns\u0026gt; junk Continuons à disséquer la configuration.\nLa table aliases pointe vers un fichier d\u0026rsquo;alias sur deux colonnes. La colonne de gauche correspond à la partie utilisateur d\u0026rsquo;une adresse e-mail que vous recevez ; la colonne de droite correspond à l\u0026rsquo;utilisateur à qui le mail doit être livré (ex. : root: gilles). Il est recommandé d\u0026rsquo;aliaser les adresses root, abuse et postmaster vers une adresse que vous lisez réellement. Je ne le fais pas ici parce que je vais simplement détruire le setup une fois l\u0026rsquo;article fini, mais en ce qui vous concerne, faites le !\nEnsuite viennent les lignes listen. La première est le point d\u0026rsquo;attache que vont contacter les autres serveurs de mail qui souhaitent envoyer du mail vers hypno.cat. Elle est configurée pour offrir tls en utilisant les certificats et clés pour mail.hypno.cat et pour filtrer les sessions entrantes avec mes filtres. La seconde est le point d\u0026rsquo;attache que vont contacter mes propres utilisateurs sur le port de submission, qui requiert TLS en utilisant les mêmes certificats et clés, mais également l\u0026rsquo;authentification des utilisateurs système locaux (le défaut peut être changé), et filtrant à-travers le filtre rspamd uniquement dans le but de faire la signature DKIM de nos messages.\nLes lignes action définissent les actions à entreprendre avec les mails qui sont acceptés dans le système. Une action locale permet de distribuer dans une maildir, en classifiant les spams dans un répertoire spécifique, et en résolvant les alias. Une seconde action permets de relayer les mails en s\u0026rsquo;annonçant en tant que mail.hypno.cat aux autres hôtes. Si le serveur disposait de plusieurs adresses IP, il serait possible d\u0026rsquo;assigner à l\u0026rsquo;aide de l\u0026rsquo;option src celle à utiliser, mais ici je n\u0026rsquo;ai qu\u0026rsquo;une seule adresse IP donc pas besoin de la spécifier.\nEnfin, les lignes match représentent l\u0026rsquo;ensemble des règles. Quand une enveloppe entre dans le serveur SMTP au travers d\u0026rsquo;un des points d\u0026rsquo;attache listen, elle est comparée séquentiellement à chaque ligne match jusqu\u0026rsquo;à trouver une correspondance ou rejetée si aucune correspondance n\u0026rsquo;est trouvée. Lorsqu\u0026rsquo;une correspondance est trouvée, l\u0026rsquo;action associée à la règle est prise en compte. Les règles de match sont très simples à comprendre, je ne vais donc pas les expliquer ; vous devriez arriver à comprendre seuls ce que signifie from any for domain \u0026quot;hypno.cat\u0026quot;, sans quoi vous ne devriez pas lire cet article en premier lieu.\nQuelques mots au sujet de SenderScore # SenderScore est une base de donnée de réputation IP qui associe un score entre 0 et 100 à une adresse IP. Le score est lié au volume et comportement observé depuis ces adresses IP, et même si l\u0026rsquo;on ne sait pas COMMENT sont calculés ces scores parce que la méthodologie n\u0026rsquo;est pas publique, un peu d\u0026rsquo;étude permet de confirmer que ces nombres ne sortent pas de nul part : ils sont corrélés au ratio de distribution et d\u0026rsquo;erreur chez différents Big Mailer Corps et il est possible d\u0026rsquo;influencer le score en changeant de comportement.\nIl est également TRÈS clair que pour construire les scores de réputation, ils ont accès à des informations relatives aux sessions SMTP dont seuls les serveurs mails de destinations peuvent disposer, comme le volume de mails ou le ratio de destinataires acceptés et refusés, observés depuis une adresse, impliquant que ces informations sont obtenues directement depuis les Big Mailer Corps. Faites ce que vous voulez de cela.\nEn me basant sur MA compréhension, il s\u0026rsquo;agit d\u0026rsquo;un indicateur intéressant pour limiter la quantité de spam qui vous atteint. Je ne fait pas confiance à cet indicateur concernant les bons scores (parce que je sais à peu près contourner) mais j\u0026rsquo;y fais ÉNORMÉMENT confiance en ce qui concerne les mauvais scores, parce qu\u0026rsquo;il faut vraiment faire un paquet de mauvaises choses en gros volume pour que le score se dégrade. Si vous ne faites pas de mailing en masse, vous êtes censés être soit inconnu de cette base de donnée ou avoir un score supérieur à 95, sinon il y a quelque chose qui déconne chez vous.\nTout le monde n\u0026rsquo;est pas convaincu par SenderScore et certains experts en déliverabilité disent que c\u0026rsquo;est du pipeau. J\u0026rsquo;ai personnellement fait tourner une expérimentation sur plusieurs mois en graphant volume et réputation quotidienne, en comparant aux graphs de distribution. Mon opinion est contraire : il y a une correlation très significative qui permet clairement de classifier les émetteurs. Je pense que la meilleure approche est d\u0026rsquo;utiliser le filtre pour junker, et non bloquer, pour déterminer par vous même si vous en êtes satisfait.\nSenderScore considère que les émetteurs devraient avoir une réputation supérieure à 70. Je pense pour ma part que les hôtes avec un score inférieur à 70 sont de bons candidats au junk, les hôtes avec un score inférieur à 10 sont des rejets évidents.\nInstaller et configurer Dovecot # OpenBSD dispose d\u0026rsquo;un paquet pour Dovecot qui peut être installé d\u0026rsquo;une simple commande :\nmail# pkg_add dovecot dovecot-2.3.7.2v0: ok The following new rcscripts were installed: /etc/rc.d/dovecot See rcctl(8) for details. New and changed readme(s): /usr/local/share/doc/pkg-readmes/dovecot […] Et, specifiquement pour OpenBSD, en suivant les instructions du fichier readme, le fichier /etc/login.conf devrait contenir une classe dovecot pour augmenter les ressources autorisées à Dovecot, gourmand en descripteurs de fichiers :\ndovecot:\\ :openfiles-cur=1024:\\ :openfiles-max=2048:\\ :tc=daemon: Cela fait, il n\u0026rsquo;y a plus grand chose à faire à part pointer Dovecot sur le certificat et la clé TLS générés plus tôt. On le fait en modifiant les clés de configuration ssl_cert et ssl_key dans le fichier /etc/dovecot/conf.d/10-ssl.conf pour qu\u0026rsquo;elles soient comme suit :\nssl_cert = \u0026lt;/etc/ssl/mail.hypno.cat.fullchain.pem ssl_key = \u0026lt;/etc/ssl/private/mail.hypno.cat.key Puis dire à Dovecot que les mails sont livrés dans le répertoire ~/Maildir de chaque utilisateur puisque c\u0026rsquo;est là que OpenSMTPD les déposera. On le fait en modifiant la clé de configuration mail_location dans le fichier /etc/dovecot/conf.d/10-mail.conf pour qu\u0026rsquo;elle soit comme suit :\nmail_location = maildir:~/Maildir On est bon.\nLe daemon peut être activé pour être démarré à chaque reboot, puis démarré immédiatement :\nmail# rcctl enable dovecot mail# rcctl start dovecot dovecot(ok) À ce stade, il est possible de configurer n\u0026rsquo;importe quel client mail comme mutt, thunderbird ou même l\u0026rsquo;application gmail sur Android, et utiliser mail.hypno.cat pour les mails entrants et sortants.\nApprendre à Dovecot à entrainer Rspamd # Vous avez lu jusqu\u0026rsquo;ici ? bien.\nCette section est une section bonus, elle n\u0026rsquo;est absolument pas nécessaire pour configurer votre serveur de mail, mais c\u0026rsquo;est un élément que j\u0026rsquo;aime ajouter parce qu\u0026rsquo;il permet aux utilisateurs d\u0026rsquo;entrainer le filtre antispam d\u0026rsquo;une manière à laquelle ils sont habitués : en déplaçant un mail vers la boite à Spam, ou en appuyant sur un bouton \u0026ldquo;signaler un Spam\u0026rdquo;, \u0026ldquo;marquer comme Spam\u0026rdquo; ou peu importe comment il s\u0026rsquo;appelle dans l\u0026rsquo;interface utilisée. Le bon côté est que cet élément de configuration s\u0026rsquo;intègre avec IMAP, donc peu importe comment les mails sont consultés et depuis quel logiciel, l\u0026rsquo;action de marquer un mail comme Spam entraînera automatiquement le filtre.\nC\u0026rsquo;est très simple en théorie : il suffit de brancher deux scripts, l\u0026rsquo;un qui gère le déplacement dans la boite à Spam, l\u0026rsquo;autre qui gère le déplacement hors de la boite à Spam. Les Big Mailer Corps utilisent des stratégies plus poussées en détectant les mails non ouverts, ceux déplacés directement en poubelle, etc… mais débutons simple, il est toujours possible d\u0026rsquo;étendre ensuite.\nPour faire ce branchement, nous dépendont de Sieve qui est… comment dire avec diplomatie… un peu sur-conçu.\nCe n\u0026rsquo;est pas un élément critique du setup, vous êtes autorisés à éteindre vos cerveaux et suivre les instructions aveuglément. Le pire qui puisse arriver ici est que l\u0026rsquo;entraînement de la détection ne marche pas.\nPour activer imap sieve, le package Pigeonhole doit être installé, encore une fois à l\u0026rsquo;aide d\u0026rsquo;une simple commande :\nmail# pkg_add dovecot-pigeonhole dovecot-pigeonhole-0.5.7.2v1: ok […] Et… voici la partie la plus complexe, il faut configurer Dovecot pour activer imap_sieve et lui apprendre quels scripts utiliser pour quelles actions.\nD\u0026rsquo;abord, on active imap_sieve dans Dovecot en l\u0026rsquo;ajoutant dans la liste des plugins mails pour IMAP. C\u0026rsquo;est fait en mofifiant la clé de configuration mail_plugins dans le fichier /etc/dovecot/conf.d/20-imap.conf :\nprotocol imap { […] mail_plugins = $mail_plugins imap_sieve […] } Ensuite pour apprendre à Dovecot à entrainer Rspamd, on ajoute la section suivante dans le fichier /etc/dovecot/conf.d/90-plugin.conf, pour dire quel script sieve déclencher quand un mail est déplacé vers ou hors du répertoire Junk :\nplugin { sieve_plugins = sieve_imapsieve sieve_extprograms sieve_global_extensions = +vnd.dovecot.pipe +vnd.dovecot.environment imapsieve_mailbox1_name = Junk imapsieve_mailbox1_causes = COPY APPEND imapsieve_mailbox1_before = file:/usr/local/lib/dovecot/sieve/report-spam.sieve imapsieve_mailbox2_name = * imapsieve_mailbox2_from = Junk imapsieve_mailbox2_causes = COPY imapsieve_mailbox2_before = file:/usr/local/lib/dovecot/sieve/report-ham.sieve imapsieve_mailbox3_name = Inbox imapsieve_mailbox3_causes = APPEND imapsieve_mailbox3_before = file:/usr/local/lib/dovecot/sieve/report-ham.sieve sieve_pipe_bin_dir = /usr/local/lib/dovecot/sieve } Maintenant que Dovecot est prêt, on prépare la partie Sieve qui dépend de deux scripts pour entraîner le Spam et le Ham dans /usr/local/lib/dovecot/sieve :\n# cat report-ham.sieve require [\u0026#34;vnd.dovecot.pipe\u0026#34;, \u0026#34;copy\u0026#34;, \u0026#34;imapsieve\u0026#34;, \u0026#34;environment\u0026#34;, \u0026#34;variables\u0026#34;]; if environment :matches \u0026#34;imap.mailbox\u0026#34; \u0026#34;*\u0026#34; { set \u0026#34;mailbox\u0026#34; \u0026#34;${1}\u0026#34;; } if string \u0026#34;${mailbox}\u0026#34; \u0026#34;Trash\u0026#34; { stop; } if environment :matches \u0026#34;imap.user\u0026#34; \u0026#34;*\u0026#34; { set \u0026#34;username\u0026#34; \u0026#34;${1}\u0026#34;; } pipe :copy \u0026#34;sa-learn-ham.sh\u0026#34; [ \u0026#34;${username}\u0026#34; ]; # cat report-spam.sieve require [\u0026#34;vnd.dovecot.pipe\u0026#34;, \u0026#34;copy\u0026#34;, \u0026#34;imapsieve\u0026#34;, \u0026#34;environment\u0026#34;, \u0026#34;variables\u0026#34;]; if environment :matches \u0026#34;imap.user\u0026#34; \u0026#34;*\u0026#34; { set \u0026#34;username\u0026#34; \u0026#34;${1}\u0026#34;; } pipe :copy \u0026#34;sa-learn-spam.sh\u0026#34; [ \u0026#34;${username}\u0026#34; ]; Et parce que les deux scripts Sieve dépendent de scripts shell sa-learn-ham.sh et sa-learn-spam.sh, on crée aussi ces deux scripts shell dans /usr/local/lib/dovecot/sieve :\n# cat sa-learn-ham.sh #!/bin/sh exec /usr/local/bin/rspamc -d \u0026#34;${1}\u0026#34; learn_ham # cat sa-learn-spam.sh #!/bin/sh exec /usr/local/bin/rspamc -d \u0026#34;${1}\u0026#34; learn_spam Enfin, on compile les scripts Sieve et on rend les scripts shell exécutables pour que Dovecot puisse les utiliser :\n# sievec report-ham.sieve # sievec report-spam.sieve # chmod 755 sa-learn-ham.sh # chmod 755 sa-learn-spam.sh C\u0026rsquo;est tout. Dorénavant en déplaçant un mail d\u0026rsquo;un répertoire à un autre, on doit voir les lignes suivantes dans le fichier de log /var/log/rspamd/rspamd.log :\n2019-09-13 23:59:46 #18598(controller) \u0026lt;1d44bd\u0026gt;; csession; rspamd_controller_learn_fin_task: \u0026lt;127.0.0.1\u0026gt; learned message as ham: CAHPtQbOxQxBCsVd7nUCP4podu74Pa-F6k28z+4BWfNeeqWYiAg@mail.gmail.com […] 2019-09-14 00:01:57 #18598(controller) \u0026lt;b76e28\u0026gt;; csession; rspamd_controller_learn_fin_task: \u0026lt;127.0.0.1\u0026gt; learned message as spam: CAHPtQbOxQxBCsVd7nUCP4podu74Pa-F6k28z+4BWfNeeqWYiAg@mail.gmail.com […] Il est surement possible de simplifier, je vais être honnête et dire que mon intérêt pour Sieve n\u0026rsquo;est pas assez poussé pour que je me perfectionne. C\u0026rsquo;est une fonctionnalité sur le côté et je ne toucherai probablement pas les scripts avant les dix prochaines années. Je ne suis pas du tout convaincu par Sieve et quand j\u0026rsquo;aurai le temps, je ferais une alternative qui ne me rappelle pas les années m4 de Sendmail.\nTester le tout # Et maintenant, on va juste tester que l\u0026rsquo;on arrive à faire un trajet complet aller-retour de mail depuis hypno.cat vers gmail.com.\nTout d\u0026rsquo;abord, je prépare un mail depuis mon compte hypno.cat vers mon compte gmail.com :\nAprès envoi, je vérifie qu\u0026rsquo;il arrive bien chez gmail.com :\nEnsuite, je vérifie que l\u0026rsquo;émission a bien eu lieu par dessus un canal sécurisé par TLS :\nJe vérifie également que gmail.com est content avec notre déclaration SPF, notre signature DKIM et qu\u0026rsquo;il a bien vu notre enregistrement DMARC. On fait cela en sélectionnant \u0026ldquo;Voir l\u0026rsquo;original\u0026rdquo; dans le menu associé à chaque mail :\nEnfin, j\u0026rsquo;y répond pour être sur que ça fonctionne dans les deux sens :\nCool, on a fini # Cet article est dense, je voulais expliquer pourquoi on fait les choses. Si vous retirez toutes les explications et gardez juste les détails purement techniques, vous réaliserez que nous avons construit une infrastructure de mail, fournissant des services entrants et sortants sécurisés par TLS, avec un trafic sortant respectant DKIM, SPF et DMARC, et un trafic entrant filtrant le spam.\nOn a fait cela en :\najoutant deux enregistrements A, un MX et trois TXT dans notre zone DNS; faisant attention à avoir un rDNS correctement configuré installant un certificat TLS préparant un fichier de configuration d\u0026rsquo;environ 15 lignes pour un serveur SMTP modifiant 3 lignes dans la configuration par défaut d\u0026rsquo;un serveur IMAP modifiant 8 lignes dans la configuration par défaut d\u0026rsquo;une solution antispam Et parce que nous étions de tres bonne humeur et volontaires pour faire un petit pas de plus, nous avons implémenté un apprentissage Spam / Ham de Rspamd en :\nmodifiant environ 20 lignes dans la configuration par défaut d\u0026rsquo;un serveur IMAP copiant 4 scripts Sieve dans un répertoire On admettra qu\u0026rsquo;un nouvel arrivant va devoir fournir quelques efforts pour trouver tout ça sans aide, mais aucune de ces tâches n\u0026rsquo;est réellement difficile ou complexe. De plus, la plupart sont des opérations de mises en place qui ne sont réalisées qu\u0026rsquo;une fois ; on n\u0026rsquo;édite pas la zone DNS ou un reverse DNS tous les deux jours, tout comme on ne touche pas une configuration en place qui fonctionne tant qu\u0026rsquo;il n\u0026rsquo;y a pas de nouveau cas d\u0026rsquo;utilisation.\nPour citer les plus réfractaires à l\u0026rsquo;auto-hébergement, il peut y avoir des maintenances pour gérer les conséquences d\u0026rsquo;une blacklist, mais il n\u0026rsquo;y a aucun scénario dans lequel ladite maintenance impliquerait autant de travail que la mise en place que nous venons de faire… et qui au final se réplique en 10 minutes chrono une fois réalisée une première fois pour se faire la main.\nQuelle est la prochaine étape ? # Votre prochaine étape est de mettre en place de la redondance pour vous assurer qu\u0026rsquo;une panne de votre serveur de mail n\u0026rsquo;entraine pas de perte de mail.\nEn pratique, la plupart des serveurs de mails retentent une émission de multiples fois si la destination est inaccessible donc, même en cas de panne, la plupart de vos mails seront temporisés par votre émetteur et retransmis quand votre serveur sera de nouveau accessible.\nEn théorie, on veut tout de même faire les choses bien, et reposer sur la responsabilité des autres à gérer nos pannes n\u0026rsquo;est pas très poli. Vous devez mettre en place un serveur secondaire, vous arranger entre amis pour être serveurs secondaires les uns des autres, ou même vous souscrire à un service qui offre du mail secondaire. N\u0026rsquo;importe quoi qui puisse permettre de couvrir vos arrières lorsque votre serveur primaire tombe.\nEnsuite, peu importe la méthode choisie, il vous faudra :\najouter un enregistrement MX supplémentaire dans votre zone DNS configurer le serveur secondaire pour retransmettre les mails au serveur primaire On est loin de la haute voltige.\nEst-ce qu\u0026rsquo;on a vraiment fini ? # Je vais probablement écrire une série d\u0026rsquo;article pour discuter de la réputation, ainsi que des mécanismes en place chez les Big Mailer Corps qui provoquent des pannes de distribution.\nSi ce sont des sujets d\u0026rsquo;intérêt et que j\u0026rsquo;ai du feedback positif, j\u0026rsquo;écrirais plus souvent sur les concepts autour de la déliverabilité, sinon je reprendrais mes anciennes activités : écrire mes rapports mensuels sur mes contributions opensource. À vous de me dire :-)\nFinalement, dans cet article j\u0026rsquo;ai décrit un setup vraiment simple mais il y a des tonnes de choses intéressantes à faire avec les infrastructures de mail, si vous n\u0026rsquo;avez pas peur d\u0026rsquo;aller plus loin.\nJe construis actuellement une infrastructure de mail pour un future service commercial d\u0026rsquo;hébergement. L\u0026rsquo;infrastructure s\u0026rsquo;étend sur plusieurs data centers dans plusieurs pays, a des serveurs secondaires capable d\u0026rsquo;encaisser des pannes très sérieuses des serveurs primaires, peut facilement monter à l\u0026rsquo;échelle sur des pics de volume, elle décorelle le trafic entrant et sortant pour permettre de fournir des services partiels, peut facilement re-router le trafic entre des machines pour contourner des pannes, tout en fournissant des services IMAP à des comptes virtuels sur une multitude de domaines, avec des backups quotidiens. L\u0026rsquo;infrastructure me coute… moins de 75 EUR par mois. Elle est également très simple, la plupart des machines sont des installations par défaut d\u0026rsquo;OpenBSD avec très peu de changements au système de base.\nSi lire à propos de ce genre de mises en place vous intéresse, je peux écrire à ce sujet pour aider un maximum de personnes à monter un maximum d\u0026rsquo;alternatives aux Big Mailer Corps, ce qui est au final mon souhait.\nMerci de m\u0026rsquo;avoir lu, je n\u0026rsquo;ai pas de soundcloud, mais j\u0026rsquo;ai un patreon et un github si vous voulez me sponsoriser, ou utiliser les icones en dessous du lien de commentaires pour partager cet article sur les reseaux sociaux.\n","date":"23 Janvier 2019","permalink":"/fr/posts/2019-12-23/mettre-en-place-un-serveur-de-mail-avec-opensmtpd-dovecot-et-rspamd/","section":"Posts","summary":"TL;DR: Pas de résumé, j\u0026rsquo;ai passé des heures à traduire, vous allez passer des minutes à lire ;) OK… J\u0026rsquo;ai expliqué avec BIEN TROP DE DÉTAILS comment mettre en place un serveur de mail Merci à mes sponsors !","title":"Mettre en place un serveur de mail avec OpenSMTPD, Dovecot et Rspamd"},{"content":" TL;DR: SMTP est la méthode dont les ordinateurs échangent des e-mails il s\u0026rsquo;agit d\u0026rsquo;un protocole décentralisé, ce qui signifie que CHACUN peut héberger un nœud et être indépendant il est en train d\u0026rsquo;être centralisé dans des sociétés qui ont un passif d\u0026rsquo;abus il est en train d\u0026rsquo;être centralisé dans un pays qui a un passif d\u0026rsquo;abus Où est-ce que j\u0026rsquo;ai déjà lu ça ? # En Août, j\u0026rsquo;ai publié un petit article intitulé \u0026ldquo; You should not run your mail server because mail is hard\u0026rdquo; (\u0026ldquo;Vous ne devriez pas héberger votre serveur de mail parce que c\u0026rsquo;est dur\u0026rdquo;) qui était, en gros, mon opinion sur les différentes raisons qui poussent les gens à décourager l\u0026rsquo;hébergement de mails. De manière très inattendue, l\u0026rsquo;article est devenu assez populaire, atteignant 100K lectures et continuant à recevoir des visites et des commentaires plusieurs mois après publication.\nEn Septembre, j\u0026rsquo;ai publié un autre article beaucoup plus long intitulé \u0026ldquo; Setting up a mail server with OpenSMTPD, Dovecot and Rspamd\u0026rdquo; (\u0026ldquo;Installer un serveur de mail avec OpenSMTPD, Dovecot et Rspamd\u0026rdquo;) qui décrivait pas à pas, de façon très détaillée, les étapes pour installer un serveur de mail complet jusqu\u0026rsquo;à la livraison des e-mails en boîte de réception chez un gros hébergeur de mail américain. L\u0026rsquo;article est devenu lui aussi plutôt populaire, sans pour autant atteindre le niveau du précedent article moins technique et spécifique, mais atteignant 40K lectures et continuant également à recevoir des visites et des commentaires plusieurs mois après publication.\nLe contenu que vous vous apprêtez à lire est extrait de ce second article auquel il n\u0026rsquo;aurait pas dû être rattaché. Il est bien trop (géo-)politique pour faire partie d\u0026rsquo;un article technique, j\u0026rsquo;ai donc décidé de l\u0026rsquo;en retirer et d\u0026rsquo;en faire un dédié. Je ne veux pas que les spécificités d\u0026rsquo;un article sur OpenSMTPD aille à l\u0026rsquo;encontre d\u0026rsquo;un message beaucoup plus général.\nC\u0026rsquo;est mon premier article en français depuis des années, je vous demande donc un peu d\u0026rsquo;indulgence : si vous trouvez des fautes, vous pouvez me les remonter pour que je les corrige, ou faire une pull request pour les techies.\nN\u0026rsquo;hésitez pas à partager la publication à l\u0026rsquo;aide des icones en fin d\u0026rsquo;article et à la commenter \u0026lt;3\nQui sont Big Mailer Corps ? # Je ne vais pas pointer de doigts vers des directions en particulier. Concrètement, rentrent dans ma définition des Big Mailer Corps, toute grosse entreprise qui centralise l\u0026rsquo;hébergement des e-mails d\u0026rsquo;un très grand nombre d\u0026rsquo;utilisateurs :\n- Orange ? SFR ? La Poste ? - Non, plus grand, plus mondial, … Et là, normalement le doute est dissipé, pas besoin de citer de nom. Vous avez compris qui est visé parce que TOUT LE MONDE connait les Big Mailer Corps, la plupart d\u0026rsquo;entre vous avez une adresse chez l\u0026rsquo;un d\u0026rsquo;entre eux, et la plupart de vos contacts sont hébergés chez l\u0026rsquo;un d\u0026rsquo;entre eux.\nL\u0026rsquo;auto-hébergement et encourager les petits fournisseurs est meilleur pour notre bien commun # Il y a des conséquences à la centralisation des services de mail chez les Big Mailer Corps.\nIl n\u0026rsquo;y a aucun sens à ce que Jacques Lambda, qui partage des photos de chatons avec sa famille et ses amis, se construise une infrastructure d\u0026rsquo;hébergement de mails alors que plusieurs Big Mailer Corps lui offrent, \u0026ldquo;gratuitement\u0026rdquo;, une qualité de service au top. Il peut obtenir une adresse e-mail immédiatement disponible et qui marche de manière parfaitement fiable. Il n\u0026rsquo;y a absolument aucun sens à ce que Jacques Lambda n\u0026rsquo;aille pas chez l\u0026rsquo;un des Big Mailer Corps, particulièrement quand même les techies font ce choix sans hésitation, confirmant que c\u0026rsquo;est plutôt une bonne option.\nIl n\u0026rsquo;y a rien de mal à ce que tous les Jacques Lambda choisissent un service qui marche.\nCe qui est terriblement mauvais par contre, c\u0026rsquo;est le centralisation d\u0026rsquo;un protocole de communication dans les mains d\u0026rsquo;une poignée d\u0026rsquo;entreprises commerciales, CHACUNE D\u0026rsquo;ENTRE ELLES provenant du même pays (actuellement dirigé par un lunatique qui abuse de son pouvoir et souffre probablement de trouble de la personnalité narcissique), CHACUNE D\u0026rsquo;ENTRE ELLES étant apparu dans les informations et/ou dans une cour de tribunal pour tout un assortiment de comportements \u0026ldquo;déplaisants\u0026rdquo; (abus de la vie privée, espionnage, abus de monopole, harcellement professionnel ou sexuel, j\u0026rsquo;en passe… ), et CHACUNE D\u0026rsquo;ENTRE ELLES faisant croître des bases d\u0026rsquo;utilisateurs qui dépassent de loin la population totale de plusieurs pays combinés.\nMettons un peu de perspective. Le plus gros des Big Mailer Corps annonce une base d\u0026rsquo;utilisateur qui dépasse 1.4 MILLARD d\u0026rsquo;utilisateurs (Avril 2018), soit à peu près la population totale de la Chine ou de l\u0026rsquo;Inde, plus de quatre fois la population totale des USA, ou plus de vingt fois la population totale de la France. Si vous comptiez les utilisateurs au rythme d\u0026rsquo;un par seconde, il vous faudrait 44 ans pour en faire le tour.\nEnsuite, très loin derrière, il est suivi par le prochain Big Mailer Corp qui annonce une base de 400 millions d\u0026rsquo;utilisateurs (2018 également), dépassant la population totale des USA, atteignant quatre fois la population totale de l\u0026rsquo;Égypte, et cinq fois la population totale de la France.\nDans la plupart des rapports de mailing que j\u0026rsquo;ai pu surveiller, le premier des Big Mailer Corps couvre approximativement la moitié des adresse e-mails de destinataires… l\u0026rsquo;autre moitié étant également couverte en large partie par les autres Big Mailer Corps.\nCe n\u0026rsquo;est pas sain. Ni ici, ni nulle part, ni maintenant, ni jamais, ni dans aucune dimension alternative (insérer \u0026ldquo;sliiiiiiders\u0026rdquo; en chuchotement mental ici).\nPrenez un moment pour bien enregistrer ce qui suit :\nSi ces grosses entreprises étaient contraintes de couper les communications avec un pays pour appliquer des sanctions, bien au delà d\u0026rsquo;un MILLIARD de personnes seraient hors de portée pour le pays visé. Et si vous pensez la crainte exagérée, les utilisateurs de Github en Iran, en Syrie, à Cuba ou en Crimée pourraient vous donner un point de vue différent après avoir découvert qu\u0026rsquo;ils étaient mis à la porte pour appliquer les sanctions américaines sur leurs pays.\nAussi ennuyant soit-il, Git reste un outil de techies qui n\u0026rsquo;impacte principalement que des techies, une minorité d\u0026rsquo;humains qui sait trouver facilement des solutions de contournement… facilitées par le fait que Git est décentralisé et ne nécessite pas d\u0026rsquo;interconnexions et d\u0026rsquo;interopérabilité : les utilisateurs peuvent facilement bouger ailleurs et s\u0026rsquo;auto-héberger. Aucun lien coupé avec aucun pays ne peut empêcher ça.\nLe mail fonctionne de façon différente. Il impacte tout le monde, des personnes de tous âges et qui ne sont pas forcément des techies. Il est toujours possible de trouver une solution de contournement en cas de blocage, mais ce n\u0026rsquo;est pas simple pour tout le monde. Et comme il s\u0026rsquo;agit d\u0026rsquo;un protocole pour mettre en relation un émetteur A avec un destinataire B, il y a un besoin d\u0026rsquo;interconnexion, un besoin d\u0026rsquo;interopérabilité ET besoin que le lien entre A et B ne soit pas coupé. Les conséquences d\u0026rsquo;un blocage similaire à celui de Github chez les Big Mailer Corps seraient plusieurs ordres de magnitude plus durs et visibles : un pan des utilisateurs d\u0026rsquo;Internet ne serait tout bonnement plus joignable par les citoyens des pays sanctionnés.\nLes habitants des pays de merde ne sont pas tous des techies, ils sont des personnes qui ont BESOIN d\u0026rsquo;interconnexions et d\u0026rsquo;interopérabilité pour communiquer avec plus d\u0026rsquo;un MILLIARD de personnes hébergées chez les Big Mailer Corps. Le mail permet de connecter les populations mondiales de manière fiable… UNIQUEMENT si le mail reste décentralisé. Il ne marche plus s\u0026rsquo;il est centralisé dans une poignée d\u0026rsquo;entreprises toutes localisées dans le même pays.\nBien sûr cela n\u0026rsquo;arrivera peut être jamais, et je metterai même mon billet dessus parce qu' un pays connu pour avoir intercepté et épié les communications mondiales a plus d\u0026rsquo;intérêt à conserver le flot des communications qu\u0026rsquo;à le couper, mais le seul fait que ce soit TECHNIQUEMENT possible devrait être suffisant pour nous mettre mal à l\u0026rsquo;aise. J\u0026rsquo;ignore même volontairement que la raison pour laquelle ils ne le feront pas me rends également mal à l\u0026rsquo;aise. Si les Big Mailer Corps étaient hébergés en Chine, nous serions déjà en train d\u0026rsquo;envisager les conséquences d\u0026rsquo;une coupure et d\u0026rsquo;envisager un plan de sortie, mais nous ne le faisons pas parce que nous pensons que nous sommes du bon côté de la barrière, et que des sanctions à notre encontre ne pourraient pas arriver.\nMais ça, c\u0026rsquo;est jusqu\u0026rsquo;à ce que l\u0026rsquo;on soit complètement au pied du mur sans solution.\nÀ ce stade, je pourrais également faire semblant d\u0026rsquo;ignorer que le modèle économique de la plupart de certaines de ces entreprises repose sur la création d\u0026rsquo;un profil commercial de leurs utilisateurs et qu\u0026rsquo;avoir à disposition tous les e-mails est une mine d\u0026rsquo;or.\nCertains Big Mailer Corps se défendent d\u0026rsquo;exploiter le contenu des e-mails, mais… il n\u0026rsquo;y a pas besoin de connaître le contenu des e-mails si les expéditeurs et destinataires sont écrits sur l\u0026rsquo;enveloppe. Il est tout à fait possible de savoir que vous essayer de souscrire un crédit en faisant des comparatifs, mais que vous recevez également des remboursements de santé réguliers et que vous recevez des informations concernant un certain type d\u0026rsquo;appareillage médical. Un profil très précis et qui serait très intéressant pour des organismes de prêt ou des assurances peut tout à fait être dressé sans avoir à \u0026ldquo;lire\u0026rdquo; les e-mails… mais bon, ce ne sont que des spéculations basées sur quelque chose de techniquement réalisable.\nDans la même idée, je vais faire semblant d\u0026rsquo;ignorer que tous les documents partagés peuvent être analysés pour détecter des logiciels malveillants, que le document soit confidentiel ou non, qu\u0026rsquo;il soit stratégique ou non. Tout comme les liens échangés par mail, qu\u0026rsquo;ils soient stratégiques ou non, perdent tout caractère confidentiel lorsqu\u0026rsquo;ils passent par le webmail d\u0026rsquo;un Big Mailer Corp.\nAlors OUI, il faut plus de personnes qui s\u0026rsquo;auto-hébergent ou qui dépendent d\u0026rsquo;hébergeurs géolocalisés, tissant un réseau de communication le plus vaste au-travers de plusieurs opérateurs dans plusieurs pays. Je ne pense évidemment pas que tout le monde doit s\u0026rsquo;auto-héberger, mais je pense que DAVANTAGE de monde doit sortir des Big Mailer Corps pour aller n\u0026rsquo;importe où ailleurs… il faut réintroduire de la contrainte chez les les Big Mailer Corps, qu\u0026rsquo;ils soient obligés d\u0026rsquo;interagir avec des opérateurs en dehors de leur gang, et qu\u0026rsquo;il y ait un risque financier SI soudainement ils prenaient des décisions à l\u0026rsquo;encontre des populations.\nLes Big Mailer Corps ne sont pas mauvais ou méchants, j\u0026rsquo;utilise moi-même leurs services régulièrement, et la plupart de leurs employés cherchent probablement le bien commun… mais ces entreprises sont devenues trop grosses et puissantes, il faut qu\u0026rsquo;il y ait un équilibre parce que l\u0026rsquo;on ne sait pas comment elles évolueront dans les années à venir, on ne sait pas non plus comment évoluera la politique de leurs pays d\u0026rsquo;origine dans les années à venir, et les informations récentes ne décrivent pas un avenir tout rose dans la bonne direction.\nJe concluerai en vous recommandant de regarder cette excellente présentation de Bert Hubert ( @PowerDNS_Bert) de PowerDNS, à propos de problèmes similaires qui sont en train d\u0026rsquo;émerger avec le protocole DNS et les craintes qui en découlent autour de la surveillance. De très nombreux points de sa présentation sont tout aussi valides en ce qui concerne les services de mail.\n","date":"15 Janvier 2019","permalink":"/fr/posts/2019-12-15/decentralisons-smtp-pour-le-bien-commun/","section":"Posts","summary":"TL;DR: SMTP est la méthode dont les ordinateurs échangent des e-mails il s\u0026rsquo;agit d\u0026rsquo;un protocole décentralisé, ce qui signifie que CHACUN peut héberger un nœud et être indépendant il est en train d\u0026rsquo;être centralisé dans des sociétés qui ont un passif d\u0026rsquo;abus il est en train d\u0026rsquo;être centralisé dans un pays qui a un passif d\u0026rsquo;abus Où est-ce que j\u0026rsquo;ai déjà lu ça ?","title":"Décentralisons SMTP pour le bien commun"},{"content":" TL;DR: Le mail n\u0026rsquo;est pas dur: les gens répètent ça parce qu\u0026rsquo;ils l\u0026rsquo;ont lu, pas parce qu\u0026rsquo;ils ont essayé Les Big Mailer Corps sont contents de ce mythe, ça fait grossir leur base d\u0026rsquo;utilisateurs Les Big Mailer Corps contrôlent un large pourcentage de l\u0026rsquo;espace d\u0026rsquo;adressage des e-mails ce qui n\u0026rsquo;est bon pour personne C\u0026rsquo;est ok que des gens aient leurs adresses e-mail hébergées chez des Big Mailer Corps tant qu\u0026rsquo;il y a assez de gens en dehors EDIT (2019-12-15) # Un guide pratique pour installer un serveur de mail a été publié sur ce blog.\nAvertissement # CECI EST POUR LES SYSADMINS AVEC UNE COMPRÉHENSION TECH ET QUI SAVENT HÉBERGER DES SERVICES. L\u0026rsquo;auto-hébergement n\u0026rsquo;est pas DUR mais requiert du TRAVAIL, deux choss différentes. Mettre en place une infrastructure de mail demande beaucoup de travail en amont, puis de la maintenance très basique sur le long terme.\nJe travaille sur un serveur SMTP open source. Je construis des solutions open source et propriétaires liées au mail.\nDans cet article, je vais volontairement utiliser le terme mail parce qu\u0026rsquo;il est assez vague pour englober protocoles et logiciels. Ce n\u0026rsquo;est pas un article très technique et je ne veux pas plonger dans les détails, je veux que les gens qui n\u0026rsquo;ont jamais travaillé avec le mail puissent tout comprendre.\nJe ne vais pas non plus expliquer comment j\u0026rsquo;accomplis les tâches que je décris comme simples. Je veux que cet article se concentre sur le mythe \u0026ldquo;le mail est dur\u0026rdquo;, mettant de côté les solutions techniques utilisées pour les implémenter. Je veux que les personnes qui lisent ceci puissent se renseigner sur Postfix, Notqmail, Exim et OpenSMTPD, et pas simplement aller directement sur OpenSMTPD parce que j\u0026rsquo;aurais donné des exemples.\nJ\u0026rsquo;écrirais ensuite un article pour y faire suite, cette fois-ci en montrant comment je fais les choses avec OpenSMTPD. Si des personnes écrivent des articles similaires pour d\u0026rsquo;autres solutions, transmettez-les-moi et j\u0026rsquo;en linkerai quelques-uns. Cet article sera mis à jour de temps en temps au fil des changements, revenez de temps à autre.\nEnfin, Le nom Big Mailer Corps représente les fournisseurs d\u0026rsquo;e-mails principaux. Je me veux pas en viser un spécifique, vous pouvez concrètement remplacer Big Mailer Corps n\u0026rsquo;importe où dans ce texte par le nom d\u0026rsquo;un fournisseur qui détient plusieurs centaines de millions d\u0026rsquo;adresses de destinataires. Gardez aussi à l\u0026rsquo;esprit que certains Big Mailer Corps permettent d\u0026rsquo;héberger sous votre propre nom de domaine, donc quand je parle d\u0026rsquo;espace d\u0026rsquo;adressage e-mail, si vous possédez un domaine mais qu\u0026rsquo;il est hosté par un Big Mailer Corp, alors votre domaine et vos adresses font partie de leur espace d\u0026rsquo;adressage.\nIl était une fois, \u0026ldquo;le mail est dur\u0026rdquo; # Lorsque vous commencez à chercher à devenir indépendant pour vos e-mails, dès lors que vous demandez de l\u0026rsquo;aide pour \u0026ldquo;monter un serveur de mail\u0026rdquo; sur un média tech, les gens vont invariablement sauter dans la discussion pour vous décourager d\u0026rsquo;essayer parce que \u0026ldquo;le mail est dur\u0026rdquo;.\nNon seulement \u0026ldquo;le mail est dur\u0026rdquo; mais il semblerait aussi que \u0026ldquo;les Big Mailer Corps ont déjà gagnés\u0026rdquo;, que \u0026ldquo;tous les mails que vous enverrez à vos destinataires vont terminer en boite à spam\u0026rdquo;, et que \u0026ldquo;vous serez inondés de spammers\u0026rdquo; qui vont \u0026ldquo;abuser de votre serveur pour lui faire relayer du spam au monde\u0026rdquo;.\nWow, ça fait beaucoup là non ? :-|\nVous vouliez juste envoyer et recevoir du mail parce que ça semblait une bonne idée, et c\u0026rsquo;est devenu la pire des décisions de votre vie. Mais est-ce que ça l\u0026rsquo;est vraiment ?\nLe logiciel est difficile # Le mail était dur\u0026hellip; Il y a longtemps, très longtemps.\nIl était dur parce que les logiciels étaient durs à configurer correctement. Un serveur de mail comme Sendmail demandait au moins un doctorat en théorie des langages pour se configurer, et la culture élitiste des postmasters qui pouvaient lire les \u0026ldquo;fichiers de configuration\u0026rdquo; de Sendmail n\u0026rsquo;a pas aidé à créer un environnement très amical pour les débutants. Les postmasters se plaignaient de la complexité de Sendmail, tout en déclarant leur amour inconditionnel pour le format m4 dans un concours de la plus grosse. Je peux facilement imaginer ces gens se fouetter avec des orties fraiches par hobby.\nPostfix est une alternative à Sendmail qui est présente depuis 1998. Je ne la considèrerai pas comme \u0026ldquo;simple\u0026rdquo; même en étant très imaginatif, mais elle est des ordres de magnitude plus simple que Sendmail. Avec l\u0026rsquo;aide d\u0026rsquo;un moteur de recherche, les débutants peuvent facilement trouver des tutoriels et identifier les trois ou quatre options de configurations à modifier.\nOpenSMTPD est une autre alternative publiée pour la première en 2013. Elle est également des ordres de magnitude plus simple que Sendmail. La configuration se lit presque en anglais et un fichier de configuration utilisable peut tenir \u0026hellip; dans un tweet.\n[full screen](/images/2019-08-30-tweet.png) Je n\u0026rsquo;ai pas d\u0026rsquo;expérience avec les autres, mais la plupart des systèmes d\u0026rsquo;exploitation et des distributions fournissent plusieurs alternatives, pré-packagées pour pouvoir être installées en une seule commande.\nLes logiciels de mail ne sont pas durs. Ils ne le sont que si vous avez arrêté de regarder dans les années 90.\nOK, les logiciels ne sont pas durs mais gérer le SPAM si # Le mythe continue en annonçant que le mail est difficile parce que dès lors que l\u0026rsquo;on fait tourner son propre serveur de mail, les spammers débarquent en hordes et que gérer le spam devient un cauchemar quotidien. Ça ne pourrait pas être plus éloigné de la réalité.\nMaintenant qu\u0026rsquo;on se connait un peu et que nous avons établi un peu de confiance, je ne vais pas vous mentir: il y a des hordes de spammers.\nLorsque vous branchez votre serveur sur internet, vous allez voir des connexions aléatoires de différentes sources essayer de faire passer du mail à travers votre serveur. Vous les verrez venir depuis des connections domestiques, depuis des pays lointains, depuis des adresses IP qui partagent la même plage IP, il n\u0026rsquo;y aura pas de fin à l\u0026rsquo;émerveillement que cela pourra vous procurer.\nMais concrètement, elles entreront dans deux catégories:\ndes clients qui essaient d\u0026rsquo;abuser votre serveur pour s\u0026rsquo;en servir en relai et spammer le monde des clients qui essaient de vous spammer après avoir obtenu votre adresse e-mail d\u0026rsquo;une certaine façon Ceux de la première catégorie sont les plus simples à gérer: IGNOREZ-LES. Ils cherchent des serveurs mal configurés et tentent des choses qui sont rejetées par un serveur correctement configuré, où tentent de s\u0026rsquo;authentifier avec des attaques par dictionnaire qui sont garanties d\u0026rsquo;échouer si vous avez une politique de bons mots de passe. Ce sont les équivalents des moustiques un soir d\u0026rsquo;été, ils sont ennuyeux mais\u0026hellip; mouais.\nc1a89cb774083905 smtp connected address=185.234.219.64 host=\u0026lt;unknown\u0026gt; c1a89cb774083905 smtp failed-command command=\u0026#34;AUTH LOGIN\u0026#34; result=\u0026#34;503 5.5.1 Invalid command: Command not supported\u0026#34; c1a89cb774083905 smtp disconnected reason=disconnect c1a89cb8c5b84cbf smtp connected address=193.32.160.143 host=\u0026lt;unknown\u0026gt; c1a89cb8c5b84cbf smtp bad-input result=\u0026#34;500 5.5.1 Invalid command: Pipelining not supported\u0026#34; c1a89cb8c5b84cbf smtp disconnected reason=quit c1a89cb9441966e7 smtp connected address=185.234.219.193 host=\u0026lt;unknown\u0026gt; c1a89cb9441966e7 smtp failed-command command=\u0026#34;AUTH LOGIN\u0026#34; result=\u0026#34;503 5.5.1 Invalid command: Command not supported\u0026#34; c1a89cb9441966e7 smtp disconnected reason=disconnect Si vraiment, vraiment ils vous embêtent ou que vous ne supportiez pas de voir ces tentatives échouées dans vos logs, écrivez un script qui détecte ces motifs dans les logs et ajoute les clients indélicats dans vos règles de firewall. Par pure flemme, je n\u0026rsquo;ai jamais utilisé de scripts comme cela en vingt ans d\u0026rsquo;hébergement de serveurs de mails et\u0026hellip; je suis encore là pour vous en parler. Tant que vous les voyez pas tenter quelque chose de surprenant, contentez-vous de les ignorer.\nCeux de la seconde catégorie sont un peu plus ennuyants parce que si vous les ignorez, votre boite mail se retrouve pleine de spams. Heureusement, ils ne sont pas si durs que cela à filtrer au travers de plusieurs méthodes simples et il est très facile de réduire le spam à quelques mails, de temps à autre, le plus souvent classés dans la boite à Spam. Je ne prends absolument aucune précaution pour cacher mon adresse e-mail, gilles@poolp.org, et j\u0026rsquo;ai de temps en temps quelques spams qui arrivent dans ma boite à spam. Non seulement ce n\u0026rsquo;est pas un cauchemar quotidien, mais c\u0026rsquo;est en réalité moins que ce que je reçois sur mon compte Big Mailer Corp\u0026hellip; que je ne communique pas autant et qui a pourtant entre trois et cinq fois la quantité quotidienne de spam.\nNotez que certains filtres très simples que vous pouvez appliquer pour la seconde catégorie de spammers et aussi TRÈS efficace pour tuer la première catégorie:\na56dece24dcac3d2 smtp failed-command command=\u0026#34;DATA\u0026#34; result=\u0026#34;550 message rejected\u0026#34; a56ded3dd6cda8c2 smtp failed-command command=\u0026#34;\u0026#34; result=\u0026#34;550 your IP reputation is too low for this MX\u0026#34; a56ded3f7db5b96c smtp failed-command command=\u0026#34;DATA\u0026#34; result=\u0026#34;550 message rejected\u0026#34; a56dec6ffdb2caef smtp failed-command command=\u0026#34;\u0026#34; result=\u0026#34;421 you must have rDNS to contact this MX\u0026#34; a56dec895475b9bf smtp failed-command command=\u0026#34;\u0026#34; result=\u0026#34;421 you must have FCrDNS to contact this MX\u0026#34; Je vais le dire une bonne fois pour toutes: Vous n\u0026rsquo;atteindrez jamais le 0 absolu en spam, ça a déjà été prouvé dans les années 2000s (je n\u0026rsquo;ai plus la référence, désolé), mais la quantité que vous recevrez en étant auto-hébergé peut être aussi basse, voire plus basse, que celle que vous recevrez chez un Big Mailer Corp. Le spam n\u0026rsquo;est pas plus un souci en auto-hébergement qu\u0026rsquo;en Big Mailer Corp, peu importe à quel point le marketing tente de vous convaincre du contraire.\nPour illustrer cela, j\u0026rsquo;ai vidé ma boite à Spam sur mon compte poolp.org et sur mon compte Big Mailer Corp ce matin, voici un screenshot des deux boites le soir même, poolp.org à gauche et Big Mailer Corp à droite. Aucun des deux n\u0026rsquo;a de spam en Inbox.\nOK le SPAM n\u0026rsquo;est pas le souci mais mes mails n\u0026rsquo;atteindront pas les Big Mailer Corps # Un autre mythe, avec un peu plus de substance celui-là, est qu\u0026rsquo;envoyer un e-mail depuis une adresse qui n\u0026rsquo;est pas un Big Mailer Corp va nécessairement se retrouver rejeté ou en spam.\nLaissez-moi vous dire un secret: Les Big Mailer Corps ne sont pas inquiets de vos mails mais de ceux des gros émetteurs qui harcellent leurs utilisateurs. Ils ne se soucient pas de serveurs personnels qui envoient quelques mails, même si ce sont quelques milliers par mois. Ce qui est intéresse ce sont les ordinateurs infectés ou les serveurs compromis qui floodent leurs utilisateurs. Ce qui les intéresse ce sont les entreprises de marketing qui chient littéralement sur eux, envoyant individuellement des millions de mails commerciaux par jour, en tentant d\u0026rsquo;éviter les filtres anti-spam, et qui arrivent souvent à contourner un petit moment avant de se faire rejeter. À moins d\u0026rsquo;envoyer des centaines de milliers de mails vers eux tous les jours, honnêtement et sans vouloir heurter vos sentiments, vous êtes biiiiiiiiiiiiiiiiiiiiiiien en dessous des radars.\nAlors pourquoi j\u0026rsquo;ai dit que ce mythe avait plus de substance que les autres ?\nVolontairement ou non, les Big Mailer Corps ont introduit une preuve de travail dans les échanges de mail.\nContrairement aux émetteurs légitimes qui tentent d\u0026rsquo;atteindre un utilisateur spécifique, les spammers veulent atteindre une tonne d\u0026rsquo;utilisateurs quels qu\u0026rsquo;ils soient, parce que statistiquement certains vont tomber dans le panneau qui est dressé. Parmi ces spammers, on va inclure les boites de marketing qui achètent des listes d\u0026rsquo;utilisateurs de leurs partenaires et qui envoient de manière indiscriminée pour les \u0026ldquo;activer\u0026rdquo; dans l\u0026rsquo;espoir d\u0026rsquo;atteindre un pourcentage d\u0026rsquo;ouvertures.\nIls se fichent de savoir qui va recevoir le mail du moment qu\u0026rsquo;il est ouvert, parce que\u0026hellip; vous savez\u0026hellip; les statistiques tout ça. Donc plus c\u0026rsquo;est dur pour eux, plus il y a de chance qu\u0026rsquo;ils visent une autre cible pour pas perdre de temps et rester en avance sur leurs statistiques. Ne pensez pas que je fantasme ça, vous n\u0026rsquo;avez pas idée des astuces employées pour faire mécaniquement monter les ouvertures de quelques pourcents sur telle ou telle campagne.\nÀ l\u0026rsquo;opposé de tout ça, vous avez les émetteurs légitimes qui visent des destinataires spécifiques et ne peuvent pas simplement envoyer ailleurs. Des émetteurs qui vont nécessairement devoir faire ce qu\u0026rsquo;il faut pour que ça marche, quitte à bosser un peu plus.\nSachant cela, les Big Mailer Corps sont arrivés avec un jeu de règles sur ce qu\u0026rsquo;un Bon émetteur devrait faire pour pouvoir communiquer avec eux. Ces listes de règles sont concrètement une preuve de travail: elles ne garantissent pas que vous pourrez envoyer vers eux, elles ne garantissent pas que vous irez en inbox et pas en spam, mais elles sont l\u0026rsquo;ensemble minimal qu\u0026rsquo;il faut faire pour prouver que vous ne vous en foutez pas\u0026hellip; et comme certains spammers font de leur mieux pour paraitre sous un meilleur jour, si vous ne le faites pas vous-même ça veut concrètement dire que vous ne voulez même pas faire mieux que les spammers.\nCes règles ne sont pas là pour vous embêter, elles sont même très efficaces: certaines règles ne peuvent pas être respectées par un spammer qui aurait compromis une machine, par exemple, parce qu\u0026rsquo;il faudrait compromettre tout un domaine. Ce paradigme de la preuve de travail est ennuyant parce qu\u0026rsquo;il augmente (en temps) le coût d\u0026rsquo;entrée, mais il permet aussi à tous de bénéficier de ce travail pour tuer le spam. Puisque les Bons Émetteurs veulent clairement passez chez les Big Mailer Corps, si vous recevez des connexions de clients qui ne font pas le minimum pour pouvoir livrer du mail chez eux, vous pouvez probablement considérer qu\u0026rsquo;ils peuvent être pénalisés parce qu\u0026rsquo;ils sont déjà pénalisés sur la plus grosse portion de l\u0026rsquo;espace d\u0026rsquo;adressage.\nC\u0026rsquo;est pour cela que je dis que ce mythe a plus de substance que les autres. C\u0026rsquo;est vrai que SI l\u0026rsquo;ont ne fait pas le minimum de travail, ALORS on commence à être pénalisé.\nEn pratique, une notion de réputation est aussi en jeu. Certaines personnes n\u0026rsquo;essaient même pas mais sont très en dessous des radars\u0026hellip; et peuvent se permettre d\u0026rsquo;envoyer n\u0026rsquo;importe quoi sans souci. J\u0026rsquo;envoie souvent du mail vers mon compte Big Mailer Corp depuis un ordinateur portable de développement, sur ma connexion domestique loin d\u0026rsquo;êtres correctement configurée, et il arrive systématiquement en inbox. Une bonne réputation permet de compenser des erreurs et de passer sans être 100% irréprochable, alors qu\u0026rsquo;une mauvaise réputation augmente la quantité de travail à fournir pour montrer patte blanche. En considérant qu\u0026rsquo;une bonne réputation est acquise en faisant les bonnes choses, vous avez l\u0026rsquo;idée générale: faites les bonnes choses.\nLe set minimal de règles à respecter est TRÈS LOIN d\u0026rsquo;être dur. Pour citer quelqu\u0026rsquo;un sur Twitter:\nJe n\u0026rsquo;ai jamais eu de problème à inboxer [\u0026hellip;]. Reverse DNS + SPF/DKIM et c\u0026rsquo;est bon. [\u0026hellip;]. Je crois que le plus dur à gérer est le spam entrant.\nJe rajouterai bien deux ou trois choses à sa liste mais ça montre bien que pour certaines personnes, c\u0026rsquo;est déjà bon avec juste du rDNS, SPF et DKIM. La partie sur le spam entrant, on en a discuté juste avant ;-)\nOK, alors pourquoi tout le monde dit que c\u0026rsquo;est dur ? # La première raison, c\u0026rsquo;est parce que personne ne dit le contraire et, comme Big Mailer Corps bénéficie de cette situation, ils ne vont pas la contredire non plus. Big Mailer Corps BÉNÉFICIE du mythe que le mail est dur parce que ça veut dire que davantage de personnes dépendent de leurs services, ils contrôlent une plus grosse portion de l\u0026rsquo;espace d\u0026rsquo;adressage, et ça se traduit par plus de mails qui peuvent être analysés pour de la publicité ciblée et du rapport de force.\nPlus les gens sont découragés, plus les gens vont éventuellement s\u0026rsquo;inscrire à leurs services, et comme ils contrôlent déjà une grosse portion de l\u0026rsquo;adressage, ils peuvent rendre le mail encore un petit peu plus difficile en augmentant leurs pré-requis (plus difficile, PAS difficile). Ce n\u0026rsquo;est PAS quelque chose qu\u0026rsquo;ils font par conspiration, c\u0026rsquo;est juste la conséquence stratégique de leur donner plus de pouvoir parce que les gens s\u0026rsquo;éloignent de l\u0026rsquo;auto-hébergement.\nUne autre raison est parce que ça a été dur il y a très longtemps. Des gens ont été traumatisés par le niveau de difficulté pour ne pas rater et n\u0026rsquo;ont jamais réévalué la situation. De nombreuses personnes aujourd\u0026rsquo;hui découragent d\u0026rsquo;autres de se lancer en citant des difficultés rencontrées il y a des décennies alors que beaucoup d\u0026rsquo;outils à disposition aujourd\u0026rsquo;hui n\u0026rsquo;existaient pas et que le paysage a bien changé.\nEt finalement, une autre raison est que des gens répètent ce qu’ils ont entendu sans jamais essayer eux-mêmes. Je le sais parce que des gens m\u0026rsquo;ont dit que le mail est dur ces dix dernières années et que chaque fois que j\u0026rsquo;ai demandé ce qu\u0026rsquo;ils trouvaient dur pour essayer de comprendre et améliorer la situation. La GRANDE majorité des gens ont confessé ne jamais avoir vraiment essayé: ils ont lu ou entendu que c\u0026rsquo;était dur, souvent depuis une source de confiance, ils ont accepté cela comme un fait et commencés à répéter à leur tour que le mail est dur. On ne peut pas vraiment leur reprocher quand le mythe a été présent aussi longtemps, si je n\u0026rsquo;avais pas de connaissances préalables et que je faisais une recherche rapide pour monter mon serveur de mail, je déciderai probablement que la complexité n\u0026rsquo;en vaut pas le bénéfice vu ce qu\u0026rsquo;en disent les gens.\nAlors on fait quoi maintenant ? # On doit récupérer le mail. Je ne veux pas dire que personne ne doit être hébergé par Big Mailer Corps, mais que ça ne devrait pas être le réflexe pavlovien à la question \u0026ldquo;où est-ce que je peux ouvrir une boite mail ?\u0026rdquo;.\nTant qu\u0026rsquo;il y a assez de serveurs de mail dehors, Big Mailer Corps DOIT rester amical parce que leurs utilisateurs peuvent se plaindre que du mail légitime est perdu ou bloqué, ce qui risque de faire fuir des utilisateurs ailleurs, moins d\u0026rsquo;e-mails, moins de ciblage, moins de $$$.\nSi le nombre de serveurs de mail se réduit au point que le trafic ne provenant pas d\u0026rsquo;un Big Mailer Corps est insignifiant, alors cela devient leur protocole et ils peuvent inventer de nouvelles règles qui ne sont plus soutenables par personne à part eux.\nEncore une fois, ce n\u0026rsquo;est PAS une théorie du complot mais un effet secondaire d\u0026rsquo;être une poignée aux manettes: pourquoi se plier à des standards qui fonctionneraient pour tous et s\u0026rsquo;assurer une interopérabilité\u0026hellip; si la plupart du trafic est déjà chez moi et que je peux customiser pour offrir des services qui verrouilleront les utilisateurs chez moi ?\nC\u0026rsquo;est déjà en train de se produire avec l\u0026rsquo;un des Big Mailer Corp qui requièrent que les e-mails soient envoyés depuis l\u0026rsquo;un de ses copains pour être inboxé\u0026hellip; ou alors que les émetteurs fassent partie du carnet de contact (hébergé chez lui bien sûr) pour les autres. Tout autre émetteur commencera par faire un petit séjour en spambox avant d\u0026rsquo;éventuellement passer en inbox.\nOn ne peut pas laisser cela se produire: autoriser les e-mails à être complètement controlés par une petite poignée d\u0026rsquo;entreprises privées revient à accepter qu\u0026rsquo;ils puissent imposer toutes les règles de la communication par e-mail.\nIl est très important que l\u0026rsquo;on ne laisse pas le mythe se propager plus. Notre intérêt est d\u0026rsquo;avoir une GRANDE variété de choix de fournisseurs d\u0026rsquo;e-mail, petits et grands, commerciaux ou non. Il faut augmenter le nombre de fournisseurs pour que le nombre d\u0026rsquo;adresses e-mail en dehors des Big Mailer Corps reste significatif.\nEt surtout, il ne faut pas pousser tout le monde systématiquement à utiliser Big Mailer Corps, en particulier parce que beaucoup de ces personnes lisent leurs e-mails depuis un smartphone et se fichent de l\u0026rsquo;interface, ils pourraient utiliser presque n\u0026rsquo;importe quel fournisseur et être contents.\nJ\u0026rsquo;espère que mon point sera entendu, partagez cela où vous voulez et avec qui vous voulez, redirigez vers cet article ou reproduisez-le ailleurs.\nDans quelques jours, je publierai un guide pratique pour mettre en place un serveur similaire au mien, fournissant de la protection spam pour le mail entrant, et une preuve de travail suffisante pour rendre la plupart des Big Mailer Corps heureux.\n","date":"30 Janvier 2019","permalink":"/fr/posts/2019-08-30/vous-ne-devriez-pas-faire-tourner-votre-serveur-de-mail-parce-que-cest-dur/","section":"Posts","summary":"TL;DR: Le mail n\u0026rsquo;est pas dur: les gens répètent ça parce qu\u0026rsquo;ils l\u0026rsquo;ont lu, pas parce qu\u0026rsquo;ils ont essayé Les Big Mailer Corps sont contents de ce mythe, ça fait grossir leur base d\u0026rsquo;utilisateurs Les Big Mailer Corps contrôlent un large pourcentage de l\u0026rsquo;espace d\u0026rsquo;adressage des e-mails ce qui n\u0026rsquo;est bon pour personne C\u0026rsquo;est ok que des gens aient leurs adresses e-mail hébergées chez des Big Mailer Corps tant qu\u0026rsquo;il y a assez de gens en dehors EDIT (2019-12-15) # Un guide pratique pour installer un serveur de mail a été publié sur ce blog.","title":"Vous ne devriez pas faire tourner votre serveur de mail parce que c'est dur"},{"content":"Yop,\nLes services de poolp.org sont hébergés sur plusieurs serveurs.\nLe serveur principal à été basculé d\u0026rsquo;un petit hébergeur US \u0026ldquo;OpenBSD-friendly\u0026rdquo; vers Online.net depuis 3 ans maintenant. J\u0026rsquo;ai rusé à l\u0026rsquo;époque pour installer OpenBSD sur la Dedibox \u0026ldquo;DC\u0026rdquo; en utilisant une vieille version de Yaifo et en faisant des upgrades successives du système d\u0026rsquo;exploitation. Mis à part 3 petits downtimes dont 1 de ma responsabilité, je n\u0026rsquo;ai jamais eu à me plaindre de leurs services et de leur matériel.\nLe serveur secondaire, qui ne fournit que de l\u0026rsquo;espace disque pour les backups et un service de DNS et de SMTP secondaire en cas de panne du serveur primaire, est actuellement un serveur Kimsufi de chez OVH sur lequel j\u0026rsquo;ai installé OpenBSD via le vKVM. Le serveur est sous-utilisé, recevant un trafic anecdotique en dehors des backups journaliers en provenance du serveur primaire, mais je suis globalement content du service qui n\u0026rsquo;a pas subi de downtime depuis plus d\u0026rsquo;un an en ce qui me concerne.\nDes fois, pour les besoins d\u0026rsquo;un projet, je prends un serveur supplémentaire pour une durée indéterminée et je le laisse expirer à la fin du projet, ou bien je bascule le serveur secondaire dessus si à prix équivalent le matériel est plus confortable.\nCe week-end, je me suis rendu compte de la disponibilité des nouveaux serveurs Dedibox Classic+ Gen2 qui avaient l\u0026rsquo;air pas mal sexy. J\u0026rsquo;allais justement renouveller un serveur un peu moins confortable au même tarif, j\u0026rsquo;ai donc décidé de prendre un nouveau serveur chez Online et de laisser expirer celui que j\u0026rsquo;allais renouveller chez OVH.\nLe Classic+ Gen2 avait l\u0026rsquo;air assez sympa et la dispo d\u0026rsquo;un KVM/IP laissait présager qu\u0026rsquo;installer OpenBSD serait une partie de plaisir.\nCa, c\u0026rsquo;était avant d\u0026rsquo;essayer pour de vrai.\nLet\u0026rsquo;s go !\nMon serveur est commandé et je recoit peu après un mail m\u0026rsquo;indiquant sa disponibilité. Ni une, ni deux, je me loggue et ne vois pas de menu pour avoir accès au KVM, juste un bouton \u0026ldquo;Install\u0026rdquo;.\nComme il me faudra de toutes facons connaitre un peu le materiel avant d\u0026rsquo;installer OpenBSD par KVM, je prends le premier OS de la liste et lance une install pour pouvoir recuperer quelques infos du dmesg.\nL\u0026rsquo;install est rapide, il faut attendre un délai d\u0026rsquo;une heure avant de réussir à se connecter à la machine par SSH. Ca laisse le temps de chercher comment on accède au KVM depuis la console Online.\niDRAC\nL\u0026rsquo;Install de Debian finie, des menus supplémentaires apparaissent dans la console Online, dont le menu iDrac qui permets de lancer une console virtuelle.\nPas de bol, il faut un OS \u0026ldquo;java\u0026rdquo;-compliant, je viens de vendre mon laptop et je n\u0026rsquo;ai rien qui fasse l\u0026rsquo;affaire. Après moultes galères, je mets la main sur un Windows et je lance la console virtuelle, choisis l\u0026rsquo;ISO d\u0026rsquo;OpenBSD et tente un boot.\nPendant le boot, perte de connexion, impossible de relancer la console virtuelle, impossible de rebooter le serveur depuis la console Online ou bien simplement de faire un ssh sur la machine (normal, elle est en plein boot de l\u0026rsquo;installeur OpenBSD\u0026hellip;).\nSur le canal IRC d\u0026rsquo;#online, on m\u0026rsquo;indique que l\u0026rsquo;iDRAC est dans le caniveau, une intervention est planifiee.\nJe retente de differentes facons, mais le crash de l\u0026rsquo;iDRAC est systematique et me fait perdre la main completement sur le serveur sans aucune action possible à part quémander un redémarrage sur IRC et/ou ouvrir un ticket pour planifier une intervention.\nA la cinquième tentative, mes reves d\u0026rsquo;install par KVM/IP s\u0026rsquo;envolent, on me suggère de faire tourner une VM (ESXi est proposé comme OS), mais je suis pas trop fan donc\u0026hellip;\nQEMU à la rescousse\nJe cherche du coté de Yaifo vu qu\u0026rsquo;il m\u0026rsquo;a sauvé la vie la première fois, mais il n\u0026rsquo;est plus maintenu depuis un bail. J\u0026rsquo;envisage de le mettre à jour, mais pas trop envie de rester sur le problème 40 ans et l\u0026rsquo;idée de me retapper des heures d\u0026rsquo;attentes entre chaque intervention sur mes tentatives de tests échoué m\u0026rsquo;enchante pas des masses.\nSur IRC, Enjolras (#gcu) me fait savoir qu\u0026rsquo;il a installé DragonFlyBSD sur un Kimsufi en se servant d\u0026rsquo;un FreeBSD en mode rescue et d\u0026rsquo;unionfs pour faire l\u0026rsquo;install sur le disque physique depuis un QEMU lancé en curses.\nIdée séduisante, en rescue sur une Dedibox même pas besoin d\u0026rsquo;unionfs\u0026hellip;\nCi-dessous, voici donc la méthode pour installer le plus simplement possible un OpenBSD sur une Dedibox. Elle devrait marcher pour n\u0026rsquo;importe quel OS qui supporte le matériel avec un minimum de changements. Merci Enjolras !\nRécupérer les infos utiles\nIl faut tout d\u0026rsquo;abord booter sur le Linux installé et récupérer une copie du dmesg.\nLa raison est toute simple, QEMU va simuler le matériel, l\u0026rsquo;installation verra un disque et une interface réseau différentes de ceux du serveur physique. Lorsque l\u0026rsquo;installation sera terminée, si on reboot sur le serveur physique sans avoir fait quelques modifications, le système cherchera une interface et un disque inexistants avec le résultat attendu\u0026hellip; un ticket pour une intervention dans quelques heures ;-)\nLes infos qui nous intéressent sont éventuellement le DUID pour identifier le disque dans /etc/fstab et la description des interfaces réseau pour retrouver le nom du driver qui les prendra en charge et ainsi pouvoir créer les fichiers de conf réseau.\nSur le Classic+, j\u0026rsquo;ai décidé de ne pas me servir du DUID vu que c\u0026rsquo;est sympa mais pas obligatoire et pas d\u0026rsquo;un intérêt fou dans mon cas. En revanche, un petit grep eth a mis en évidence deux interfaces réseau \u0026ldquo;Broadcom BCM5716\u0026rdquo; et un petit coup de man bnx à confirmé que le driver bnx(4) les prends en charge sous OpenBSD. QEMU proposera une interface Realtek prise en charge par le driver re(4), donc ca n\u0026rsquo;ira pas.\nLe disque dur est monté sur /dev/sda, avec OpenBSD dans QEMU il sera visible en tant que /dev/wd0c, et avec OpenBSD sur le serveur physique il sera visible en tant que /dev/sd0c.\nDe plus, il va nous falloir les infos pour la configuration réseau:\nadresse IP broadcast netmask gateway On peut les récupérer depuis l\u0026rsquo;interface Online ou depuis ifconfig et route, en ce qui me concerne:\nadresse : 88.191.185.XXX broadcast : 88.191.185.255 netmask : 255.255.255.0 gateway : 88.191.185.1 Il faudra aussi l\u0026rsquo;adresse d\u0026rsquo;un serveur de nom pour éviter de passer 4 plombes sur le reverse lookup à la première connexion ssh, personnellement j\u0026rsquo;ai utilisé le 8.8.8.8 de Google pour mon premier boot puisque j\u0026rsquo;installe un serveur de nom local par la suite.\nLet\u0026rsquo;s Go Pour De Vrai!\nPremière étape: installer QEMU ;-) % sudo apt-get update % sudo apt-get install qemu\nSeconde étape: télécharger l\u0026rsquo;ISO d\u0026rsquo;install % wget ftp://ftp.fr.openbsd.org/pub/OpenBSD/5.3/amd64/install53.iso\nTroisième étape: lancer l\u0026rsquo;install. % sudo qemu-system-x86_64 -curses -boot -d -cdrom install53.iso -hda /dev/sda\nA ce stade, qemu boot sur l\u0026rsquo;installer et on fait face a une install tout a fait normale d\u0026rsquo;OpenBSD. Je le lance en mono-cpu, je prefere une install qui boot sur un kernel monoproc la première fois et faire une install du kernel MP après le premier boot, chacun est libre de faire comme il veut ;-)\nJe ne vais pas documenter l\u0026rsquo;installation, il y a moultes informations à ce sujet, par contre je vais juste faire une petite remarque utile pour vous éviter de perdre du temps inutilement:\nen mode \u0026ldquo;auto\u0026rdquo;, disklabel ne consommera pas tout le disque, il faut faire un découpage custom\nIl vaut mieux s\u0026rsquo;en rendre compte pendant l\u0026rsquo;install que de se galérer à faire les resize après \u0026hellip; croyez moi.\nInstallation finie ?\nAvant de quitter le mode rescue et de booter sur le serveur physique, quelques petites modifications.\nOn configure\u0026hellip;\n\u0026hellip; la gateway:\necho 88.191.185.1 \u0026gt; /etc/mygate\n\u0026hellip; l\u0026rsquo;interface réseau:\necho inet 88.191.185.XXX 255.255.255.0 88.191.185.255 \u0026gt; /etc/hostname.bnx0\n\u0026hellip; le resolver:\ncat \u0026lt; /etc/resolv.conf nameserver 8.8.8.8 search file bind EOF\n\u0026hellip; le fstab (attention à pas se rater):\nsed \u0026rsquo;s/wd0/sd0/g\u0026rsquo; \u0026lt; /etc/fstab \u0026gt; /tmp/fstab \u0026amp;\u0026amp; mv /tmp/fstab /etc/fstab\n\u0026hellip; et HOP on reboot\nreboot\nPremier reboot\u0026hellip;\nLe premier boot est long. Tres long. En fait pas si long que ca, mais l\u0026rsquo;anxiete de devoir refaire un ticket pour une intervention et attendre 4h pour refaire une tentative donne l\u0026rsquo;impression que des heures s\u0026rsquo;ecoulent avant la premiere reponse aux ping ;-)\nUne fois ce stade, on doit pouvoir se SSH sur la machine dans un OpenBSD avec un kernel monoproc. Si c\u0026rsquo;est bon, il ne reste plus qu\u0026rsquo;à installer le kernel MP:\ncp /bsd /bsd.sp ftp ftp://ftp.fr.openbsd.org/pub/OpenBSD/5.3/amd64/bsd.mp cp bsd.mp /bsd sync reboot\nAu reboot on est sur un OpenBSD 5.3 GENERIC#MP \\o/\nOpenBSD 5.3 (GENERIC.MP) #62: Tue Mar 12 18:21:20 MDT 2013 deraadt@amd64.openbsd.org:/usr/src/sys/arch/amd64/compile/GENERIC.MP real mem = 8557342720 (8160MB) avail mem = 8307052544 (7922MB) mainbus0 at root bios0 at mainbus0: SMBIOS rev. 2.7 @ 0xe6da0 (57 entries) bios0: vendor Dell Inc. version \u0026ldquo;2.2.3\u0026rdquo; date 10/25/2012 bios0: Dell Inc. PowerEdge R210 II acpi0 at bios0: rev 2 acpi0: sleep states S0 S4 S5 acpi0: tables DSDT FACP SPMI DMAR ASF! HPET APIC MCFG BOOT SSDT ASPT SSDT SSDT SPCR HEST ERST BERT EINJ acpi0: wakeup devices P0P1(S4) GLAN(S0) EHC1(S4) EHC2(S4) XHC_(S4) PXSX(S4) RP01(S5) PXSX(S4) RP02(S5) PXSX(S4) RP03(S5) PXSX(S4) RP04(S5) PXSX(S4) RP05(S5) PXSX(S4) RP06(S5) PXSX(S4) RP07(S5) PXSX(S4) RP08(S5) PEG0(S5) PEGP(S5) PEG1(S5) PEG2(S5) PEG3(S5) acpitimer0 at acpi0: 3579545 Hz, 24 bits acpihpet0 at acpi0: 14318179 Hz acpimadt0 at acpi0 addr 0xfee00000: PC-AT compat cpu0 at mainbus0: apid 0 (boot processor) cpu0: Intel(R) Xeon(R) CPU E3-1220 V2 @ 3.10GHz, 3093.38 MHz cpu0: FPU,VME,DE,PSE,TSC,MSR,PAE,MCE,CX8,APIC,SEP,MTRR,PGE,MCA,CMOV, PAT,PSE36,CFLUSH,DS,ACPI,MMX,FXSR,SSE,SSE2,SS,HTT,TM,PBE,SSE3,PCLMUL, DTES64,MWAIT,DSCPL,VMX,SMX,EST,TM2,SSSE3,CX16,xTPR,PDCM,PCID,SSE4.1, SSE4.2,x2APIC,POPCNT,DEADLINE,AES,XSAVE,AVX,F16C,RDRAND,NXE,LONG,LAHF, PERF,ITSC,FSGSBASE,SMEP,ERMS cpu0: 256KB 64b/line 8-way L2 cache cpu0: apic clock running at 99MHz cpu1 at mainbus0: apid 2 (application processor) cpu1: Intel(R) Xeon(R) CPU E3-1220 V2 @ 3.10GHz, 3092.98 MHz cpu1: FPU,VME,DE,PSE,TSC,MSR,PAE,MCE,CX8,APIC,SEP,MTRR,PGE,MCA,CMOV,PAT,PSE36,CFLUSH, DS,ACPI,MMX,FXSR,SSE,SSE2,SS,HTT,TM,PBE,SSE3,PCLMUL,DTES64,MWAIT,DS-CPL, VMX,SMX,EST,TM2,SSSE3,CX16,xTPR,PDCM,PCID,SSE4.1,SSE4.2,x2APIC,POPCNT, DEADLINE,AES,XSAVE,AVX,F16C,RDRAND,NXE,LONG,LAHF,PERF,ITSC,FSGSBASE,SMEP,ERMS cpu1: 256KB 64b/line 8-way L2 cache cpu2 at mainbus0: apid 4 (application processor) cpu2: Intel(R) Xeon(R) CPU E3-1220 V2 @ 3.10GHz, 3092.98 MHz cpu2: FPU,VME,DE,PSE,TSC,MSR,PAE,MCE,CX8,APIC,SEP,MTRR,PGE,MCA,CMOV,PAT,PSE36,CFLUSH, DS,ACPI,MMX,FXSR,SSE,SSE2,SS,HTT,TM,PBE,SSE3,PCLMUL,DTES64,MWAIT,DS-CPL, VMX,SMX,EST,TM2,SSSE3,CX16,xTPR,PDCM,PCID,SSE4.1,SSE4.2,x2APIC,POPCNT, DEADLINE,AES,XSAVE,AVX,F16C,RDRAND,NXE,LONG,LAHF,PERF,ITSC,FSGSBASE,SMEP,ERMS cpu2: 256KB 64b/line 8-way L2 cache cpu3 at mainbus0: apid 6 (application processor) cpu3: Intel(R) Xeon(R) CPU E3-1220 V2 @ 3.10GHz, 3092.98 MHz cpu3: FPU,VME,DE,PSE,TSC,MSR,PAE,MCE,CX8,APIC,SEP,MTRR,PGE,MCA,CMOV,PAT,PSE36,CFLUSH, DS,ACPI,MMX,FXSR,SSE,SSE2,SS,HTT,TM,PBE,SSE3,PCLMUL,DTES64,MWAIT,DS-CPL, VMX,SMX,EST,TM2,SSSE3,CX16,xTPR,PDCM,PCID,SSE4.1,SSE4.2,x2APIC,POPCNT, DEADLINE,AES,XSAVE,AVX,F16C,RDRAND,NXE,LONG,LAHF,PERF,ITSC,FSGSBASE,SMEP,ERMS cpu3: 256KB 64b/line 8-way L2 cache ioapic0 at mainbus0: apid 0 pa 0xfec00000, version 20, 24 pins acpimcfg0 at acpi0 addr 0xe0000000, bus 0-255 acpiprt0 at acpi0: bus 0 (PCI0) acpiprt1 at acpi0: bus 3 (P0P1) acpiprt2 at acpi0: bus 2 (RP01) acpiprt3 at acpi0: bus -1 (RP02) acpiprt4 at acpi0: bus -1 (RP03) acpiprt5 at acpi0: bus -1 (RP04) acpiprt6 at acpi0: bus -1 (RP05) acpiprt7 at acpi0: bus -1 (RP06) acpiprt8 at acpi0: bus -1 (RP07) acpiprt9 at acpi0: bus -1 (RP08) acpiprt10 at acpi0: bus 1 (PEG0) acpiprt11 at acpi0: bus -1 (PEG1) acpiprt12 at acpi0: bus -1 (PEG2) acpiprt13 at acpi0: bus -1 (PEG3) acpicpu0 at acpi0: C3, C2, C1, PSS acpicpu1 at acpi0: C3, C2, C1, PSS acpicpu2 at acpi0: C3, C2, C1, PSS acpicpu3 at acpi0: C3, C2, C1, PSS acpipwrres0 at acpi0: FN00 acpipwrres1 at acpi0: FN01 acpipwrres2 at acpi0: FN02 acpipwrres3 at acpi0: FN03 acpipwrres4 at acpi0: FN04 acpitz0 at acpi0: critical temperature is 106 degC ipmi at mainbus0 not configured cpu0: Enhanced SpeedStep 3093 MHz: speeds: 3101, 3100, 3000, 2900, 2800, 2700, 2600, 2500, 2300, 2200, 2100, 2000, 1900, 1800, 1700, 1600 MHz pci0 at mainbus0 bus 0 pchb0 at pci0 dev 0 function 0 vendor \u0026ldquo;Intel\u0026rdquo;, unknown product 0x0158 rev 0x09 ppb0 at pci0 dev 1 function 0 \u0026ldquo;Intel Xeon E3-1200v2 PCIE\u0026rdquo; rev 0x09: msi pci1 at ppb0 bus 1 mpii0 at pci1 dev 0 function 0 \u0026ldquo;Symbios Logic SAS2008\u0026rdquo; rev 0x03: msi mpii0: PERC H200A, firmware 7.15.8.0 IR, MPI 2.0 scsibus0 at mpii0: 42 targets sd0 at scsibus0 targ 1 lun 0: SCSI4 0/direct fixed naa.600508e0000000003cd970ac3a16d00c sd0: 953344MB, 512 bytes/sector, 1952448512 sectors ehci0 at pci0 dev 26 function 0 \u0026ldquo;Intel 6 Series USB\u0026rdquo; rev 0x04: apic 0 int 20 usb0 at ehci0: USB revision 2.0 uhub0 at usb0 \u0026ldquo;Intel EHCI root hub\u0026rdquo; rev 2.00/1.00 addr 1 ppb1 at pci0 dev 28 function 0 \u0026ldquo;Intel 6 Series PCIE\u0026rdquo; rev 0xb4: msi pci2 at ppb1 bus 2 bnx0 at pci2 dev 0 function 0 \u0026ldquo;Broadcom BCM5716\u0026rdquo; rev 0x20: apic 0 int 16 bnx1 at pci2 dev 0 function 1 \u0026ldquo;Broadcom BCM5716\u0026rdquo; rev 0x20: apic 0 int 17 ehci1 at pci0 dev 29 function 0 \u0026ldquo;Intel 6 Series USB\u0026rdquo; rev 0x04: apic 0 int 23 usb1 at ehci1: USB revision 2.0 uhub1 at usb1 \u0026ldquo;Intel EHCI root hub\u0026rdquo; rev 2.00/1.00 addr 1 ppb2 at pci0 dev 30 function 0 \u0026ldquo;Intel 82801BA Hub-to-PCI\u0026rdquo; rev 0xa4 pci3 at ppb2 bus 3 vga1 at pci3 dev 3 function 0 \u0026ldquo;Matrox MGA G200eW\u0026rdquo; rev 0x0a wsdisplay0 at vga1 mux 1: console (80x25, vt100 emulation) wsdisplay0: screen 1-5 added (80x25, vt100 emulation) pcib0 at pci0 dev 31 function 0 \u0026ldquo;Intel C202 LPC\u0026rdquo; rev 0x04 ahci0 at pci0 dev 31 function 2 \u0026ldquo;Intel 6 Series AHCI\u0026rdquo; rev 0x04: msi, AHCI 1.3 scsibus1 at ahci0: 32 targets ichiic0 at pci0 dev 31 function 3 \u0026ldquo;Intel 6 Series SMBus\u0026rdquo; rev 0x04: apic 0 int 19 iic0 at ichiic0 sdtemp0 at iic0 addr 0x19: mcp98243 spdmem0 at iic0 addr 0x51: 8GB DDR3 SDRAM ECC PC3-10600 with thermal sensor isa0 at pcib0 isadma0 at isa0 com0 at isa0 port 0x3f8/8 irq 4: ns16550a, 16 byte fifo com1 at isa0 port 0x2f8/8 irq 3: ns16550a, 16 byte fifo pckbc0 at isa0 port 0x60/5 kbc: cmd word write error pcppi0 at isa0 port 0x61 spkr0 at pcppi0 mtrr: Pentium Pro MTRR support uhub2 at uhub0 port 1 \u0026ldquo;Intel Rate Matching Hub\u0026rdquo; rev 2.00/0.00 addr 2 uhidev0 at uhub2 port 1 configuration 1 interface 0 \u0026ldquo;Avocent USB Composite Device-0\u0026rdquo; rev 1.10/0.00 addr 3 uhidev0: iclass 3/1 ukbd0 at uhidev0: 8 variable keys, 6 key codes wskbd0 at ukbd0 mux 1 wskbd0: connecting to wsdisplay0 uhidev1 at uhub2 port 1 configuration 1 interface 1 \u0026ldquo;Avocent USB Composite Device-0\u0026rdquo; rev 1.10/0.00 addr 3 uhidev1: iclass 3/1 ums0 at uhidev1: 3 buttons, Z dir wsmouse0 at ums0 mux 0 uhub3 at uhub1 port 1 \u0026ldquo;Intel Rate Matching Hub\u0026rdquo; rev 2.00/0.00 addr 2 uhub4 at uhub3 port 5 \u0026ldquo;Standard Microsystems product 0x2514\u0026rdquo; rev 2.00/0.00 addr 3 vscsi0 at root scsibus2 at vscsi0: 256 targets softraid0 at root scsibus3 at softraid0: 256 targets root on sd0a (f32d1747471a3037.a) swap on sd0b dump on sd0b bnx0: address d4:ae:52:c8:01:89 brgphy0 at bnx0 phy 1: BCM5709 10/100/1000baseT PHY, rev. 8 bnx1: address d4:ae:52:c8:01:8a brgphy1 at bnx1 phy 1: BCM5709 10/100/1000baseT PHY, rev. 8\n","date":"8 Janvier 2013","permalink":"/fr/posts/2013-05-08/installer-openbsd-sur-une-dedibox-classic-gen2/","section":"Posts","summary":"Yop,\nLes services de poolp.org sont hébergés sur plusieurs serveurs.\nLe serveur principal à été basculé d\u0026rsquo;un petit hébergeur US \u0026ldquo;OpenBSD-friendly\u0026rdquo; vers Online.net depuis 3 ans maintenant.","title":"Installer OpenBSD sur une dedibox Classic+ Gen2"},{"content":"","date":"8 Janvier 2013","permalink":"/fr/categories/technology/","section":"Categories","summary":"","title":"technology"},{"content":"Je sais pas pourquoi, mais je suis epuise alors que j\u0026rsquo;ai dormi pres de 14h cette nuit. J\u0026rsquo;ai envie de faire une pause, de me prendre une annee de vacances au bord de la plage les doigts de pieds dans le sable fin blanc pendant qu\u0026rsquo;on me sert du sorbet a la noix de coco sur fond de Gojira alors que le soleil me rechauffe le visage mais juste un peu, pas trop, voila, comme ca, merci. L\u0026rsquo;odeur des langoustes grilles me chatouille les narines et, alors que je sirote une pinte de Guinness(c) (la premire d\u0026rsquo;une longue serie ?), j\u0026rsquo;entends le doux murmure des vagues wuuuuuush \u0026hellip;. wuuuuuuush \u0026hellip; couvert par le cri des mouettes t\u0026rsquo;as un syscall a finiiiiir \u0026hellip; t\u0026rsquo;as un syscall a finiiiiiiiiir \u0026hellip;\nEn rouvrant les yeux, un peu triste et du, j\u0026rsquo;entrevois deux lignes \u0026hellip;\n$ cc -c -I/usr/src/sys -D_KERNEL sys_whore.c $ \u0026hellip; qui me ramene la dure realite\u0026hellip; j\u0026rsquo;ai un syscall a terminer.\nMeme dans mes songes, je passe vraiment des vacances de merde \u0026hellip;\n[Ajout] Bon alors voila, j\u0026rsquo;ai perdu plusieurs heures dessus donc je vais donner une astuce qui va peut-etre epargner de nombreuses heures de recherche a mes camarades tech4 qui codent leur syscall pour BSD.\nint sys_whore(struct proc *p, void *v, register_t *retval) { return (0); } Mais a quoi peut bien servir retval alors qu\u0026rsquo;on a un return() dans le code, et comment faire pour faire retourner autre chose qu\u0026rsquo;un entier a notre syscall ?\nApres m\u0026rsquo;etre cogne pres d\u0026rsquo;une dizaine de syscalls sans en voir un seul qui utilisait le retval, j\u0026rsquo;ai demande sur le channel #netbsd ou on m\u0026rsquo;a dit de la merde.\nUn peu plus tard sur #openbsd, on m\u0026rsquo;a conseill la lecture de /usr/src/sys/i386/i386/trap.c et la tout devient evident a la lecture de la fonction syscall().\nEn realite, que se passe-t\u0026rsquo;il lorsqu\u0026rsquo;un programme demande l\u0026rsquo;execution de notre syscall ?\nLes parametres sont places en ordre inverse dans la stack Le numro de syscall est place dans le registre EAX L\u0026rsquo;interruption 0x80 fait passer en mode kernel qui execute\u0026hellip; la fonction syscall() definie dans le trap.c Quand on regarde ce qu\u0026rsquo;elle fait, on comprends mieux. Quelques morceaux choisis:\nregister_t code, args[8], rval[2]; [...] rval[0] = 0; /* valeur de retour de l\u0026#39;appel systeme */ [...] /* appel; on stock le return */ orig_error = error = (*callp-\u0026gt;sy_call)(p, args, rval); [...] switch (error) { [...] default: /* return different de zero (et de cas particuliers) */ bad: if (p-\u0026gt;p_emul-\u0026gt;e_errno) error = p-\u0026gt;p_emul-\u0026gt;e_errno[error]; frame.tf_eax = error; frame.tf_eflags |= PSL_C; /* carry bit */ break; } Explications: Le premier element de rval est la valeur de retour de notre syscall, a ne pas confondre avec le return. En fait, le return dans le code de notre syscall sert uniquement a determiner s\u0026rsquo;il s\u0026rsquo;est bien deroule, il renvoie 0 en cas de succes quoi qu\u0026rsquo;il arrive, et une valeur d\u0026rsquo;errno dans le cas contraire. Mais alors \u0026hellip; c\u0026rsquo;est pour ca que retval n\u0026rsquo;est presque jamais utilise dans les syscalls !\nEn effet, si le syscall rate son return sera un code errno et la fonction wrapper n\u0026rsquo;aura pas besoin de verifier retval puisque la valeur qu\u0026rsquo;elle devra renvoyer sera -1 ou NULL, donc pas besoin d\u0026rsquo;y toucher. De meme, si syscall reussi, comme generalement il est sense renvoyer 0, il n\u0026rsquo;a pas besoin d\u0026rsquo;y toucher non plus puisque retval[0] est initialise a 0 avant le call. Le seul cas ou retval est modifie alors c\u0026rsquo;est quand le syscall renvoie une valeur differente de 0 en cas de success\u0026hellip; la lecture de getpid() et de ses soeurs le confirme\u0026hellip; YOUPI !\nCa vous rappelle rien ? Dans ktrace en tech3 on avait eu le meme probleme, lorsqu\u0026rsquo;un syscall ratait il renvoyait non pas -1 mais une valeur differente de 0 et il fallait ruser avec EAX pour determiner s\u0026rsquo;il s\u0026rsquo;agissait d\u0026rsquo;un ratage ou pas pour afficher nous meme -1 comme etant la valeur de retour.\nUn mystere qui m\u0026rsquo;a occupe une partie de la journe est resolu ;)\n[Ajout #2] Si vous vous demandiez pourquoi retval est un tableau de deux entiers, la reponse m\u0026rsquo;est apparue tout a l\u0026rsquo;heure, je sais pas, un clair de lucidite. Comme son nom l\u0026rsquo;indique, c\u0026rsquo;est un tableau de registre (register_t), et si le premier element correspond au registre EAX (bah oui puisque la valeur de retour est placee dans ce registre), le fait que syscall() associe le registre EDX au second element peut sembler un peu bizarre.\nEt bien nan, en fait c\u0026rsquo;est pour resoudre un cas bien particulier, celui de sys_fork() puisqu\u0026rsquo;il renvoie DEUX valeurs de retour en cas de succes. Le pere recupere la valeur de retour; le pid, dans EAX et le fils recupere la valeur de retour, 0, dans EDX. Magique non ?\n","date":"21 Janvier 2005","permalink":"/fr/posts/2005-05-21/fatigue-et-envie-de-vacances.../","section":"Posts","summary":"Je sais pas pourquoi, mais je suis epuise alors que j\u0026rsquo;ai dormi pres de 14h cette nuit. J\u0026rsquo;ai envie de faire une pause, de me prendre une annee de vacances au bord de la plage les doigts de pieds dans le sable fin blanc pendant qu\u0026rsquo;on me sert du sorbet a la noix de coco sur fond de Gojira alors que le soleil me rechauffe le visage mais juste un peu, pas trop, voila, comme ca, merci.","title":"fatigue et envie de vacances..."},{"content":" Identification # Ce site web est détenu et géré par Gilles CHEHADE, enregistré en tant qu\u0026rsquo;auto-entrepreneur sous le numéro SIRET 515 053 908 00031, situé au 30 Boulevard de l\u0026rsquo;estuaire, 44200 Nantes, France.\nSi vous devez contacter Gilles CHEHADE, vous pouvez envoyer un e-mail à : gilles@poolp.org.\nAssurance # Les activités de Gilles CHEHADE sont couvertes par un contrat d\u0026rsquo;assurance avec AIG, sous le numéro de contrat RD01416644U.\nHébergement du Site Web # Ce site web est auto-géré par Gilles CHEHADE et est hébergé par Vultr.com.\nLes serveurs physiques du site se trouvent dans les différents centres de données de Vultr.com. En cas de plainte concernant le site ou son contenu, Gilles CHEHADE peut être contacté via l\u0026rsquo;e-mail mentionné ci-dessus.\nPolitique de Conservation des Données # Nous respectons votre vie privée. Notre site web n\u0026rsquo;utilise pas de cookies ou de traceurs. Nous ne collectons aucune donnée personnelle sur nos visiteurs, à l\u0026rsquo;exception des adresses IP, des horodatages et des pages visitées. Ces informations sont collectées conformément à la loi française et sont utilisées uniquement à des fins de sécurité et d\u0026rsquo;analyse. Ces données ne sont pas partagées avec des tiers et ne sont pas utilisées à d\u0026rsquo;autres fins.\nToute modification de cette politique de confidentialité sera publiée sur cette page. Veuillez revenir fréquemment pour voir les mises à jour ou les modifications de notre politique de confidentialité.\nCette politique a été mise à jour pour la dernière fois le 18 juillet 2023.\n","date":"1 janv.vier 0001","permalink":"/fr/legal/","section":"poolp.org","summary":"Identification # Ce site web est détenu et géré par Gilles CHEHADE, enregistré en tant qu\u0026rsquo;auto-entrepreneur sous le numéro SIRET 515 053 908 00031, situé au 30 Boulevard de l\u0026rsquo;estuaire, 44200 Nantes, France.","title":"Mentions Légales"}]